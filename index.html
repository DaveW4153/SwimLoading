<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwimLoading - Live Prototype</title>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js for temperature trends -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://szgkzuswelntnevobnoh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6Z2t6dXN3ZWxudG5ldm9ibm9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxODY1NTUsImV4cCI6MjA4Mzc2MjU1NX0.UfKqj2OZ-XeyzCy-MZYZqsDWjn_4EKrhgCFR8eIK2NA';

        let supabaseClient;

        // Initialize after library loads
        if (window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Global state
        let currentUser = null;
        let spots = [];

        // Global state for Spot Lock
        let selectedSpotLocked = false;
        let gpsSuggestedSpotId = null;

        // Icon helper function
        function icon(name, size = 16) {
            return `<i data-lucide="${name}" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"></i>`;
        }

        // Initialize Lucide icons after DOM updates
        function initIcons() {
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // Check authentication on load
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                loadApp();
            } else {
                showAuth();
            }
        }

        // Show auth screen
        function showAuth() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Load main app
        async function loadApp() {
            // Check if user needs onboarding
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('terms_accepted_at')
                .eq('id', currentUser.id)
                .maybeSingle();

            // NEW USER - show onboarding
            if (!profile || !profile.terms_accepted_at) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'none';
                showOnboardingLegal();
                return;
            }

            // EXISTING USER - go to main app
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            // Load spots
            await loadSpots();

            // Load dashboard data
            await loadDashboard();

            // Initialize Lucide icons
            initIcons();

            // Initialize spot lock handler
            attachSpotLockHandler();

            // Initialize nav scroll handler
            initNavScroll();
        }

        // Sign up
        async function signUp() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const displayName = document.getElementById('signupName').value;

            if (!email || !password || !displayName) {
                alert('Please fill in all fields');
                return;
            }

            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    data: { display_name: displayName }
                }
            });

            if (error) {
                alert('Sign up failed: ' + error.message);
            } else {
                // Create profile
                await supabaseClient.from('profiles').insert({
                    id: data.user.id,
                    display_name: displayName
                });

                alert('Sign up successful! Please check your email to verify.');
            }
        }

        // Sign in
        async function signIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                alert('Login failed: ' + error.message);
            } else {
                currentUser = data.user;
                loadApp();
            }
        }

        // Sign out
        async function signOut() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            showAuth();
        }

        // Load spots
        async function loadSpots() {
            const { data, error } = await supabaseClient
                .from('spots')
                .select('*')
                .eq('active', true)
                .order('name', { ascending: true });



            if (data) {
                spots = data;
                populateSpotDropdowns();
            }
        }

        // Populate spot dropdowns
        function populateSpotDropdowns() {
            const selects = document.querySelectorAll('select[data-spots]');
            selects.forEach(select => {
                select.innerHTML = spots.map(spot =>
                    `<option value="${spot.id}">${spot.name}</option>`
                ).join('');
            });

            // Also populate history filter
            const historyFilter = document.getElementById('historySpotFilter');
            if (historyFilter) {
                historyFilter.innerHTML = '<option value="">All Locations</option>' +
                    spots.map(spot => `<option value="${spot.id}">${spot.name}</option>`).join('');
            }

            // Also populate event filter
            const eventFilter = document.getElementById('eventSpotFilter');
            if (eventFilter) {
                eventFilter.innerHTML = '<option value="">All Locations</option>' +
                    spots.map(spot => `<option value="${spot.id}">${spot.name}</option>`).join('');
            }
        }

        // Attach Spot Lock Handler
        function attachSpotLockHandler() {
            const spotSelect = document.querySelector('#logTemp select[data-spots]');
            if (spotSelect) {
                spotSelect.removeEventListener('change', handleSpotLock);
                spotSelect.addEventListener('change', handleSpotLock);
            }
        }

        function handleSpotLock() {
            selectedSpotLocked = true;
            // console.log('Spot selection locked by user');
        }

        // Nav Scroll Handler
        function initNavScroll() {
            const navTabs = document.querySelector('.nav-tabs');
            const navFade = document.querySelector('.nav-fade');

            if (!navTabs || !navFade) return;

            const checkScroll = () => {
                // If scrolled to end (within 5px tolerance), hide fade
                const isAtEnd = navTabs.scrollWidth - navTabs.scrollLeft - navTabs.clientWidth < 5;
                navFade.style.opacity = isAtEnd ? '0' : '1';
            };

            navTabs.removeEventListener('scroll', checkScroll);
            navTabs.addEventListener('scroll', checkScroll);

            // Checks initially
            checkScroll();

            // Also check on resize
            window.addEventListener('resize', checkScroll);
        }

        // Age calculation helper for temps
        function getAgeDisplay(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

            if (diffHours < 24) {
                return `${diffHours}h`;
            } else {
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays}d`;
            }
        }

        // Check if temp is fresh (<=96h)
        function isTempFresh(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffHours = diffMs / (1000 * 60 * 60);
            return diffHours <= 96;
        }

        // Helper to parse route from notes
        function parseRouteFromNotes(notes) {
            if (!notes || !notes.startsWith('Route: ')) return { route: null, notes: notes };
            const pipeIndex = notes.indexOf(' | ');
            if (pipeIndex !== -1) {
                return {
                    route: notes.substring(7, pipeIndex).trim(),
                    notes: notes.substring(pipeIndex + 3).trim()
                };
            } else {
                return {
                    route: notes.substring(7).trim(),
                    notes: ''
                };
            }
        }

        // Load dashboard
        async function loadDashboard() {
            try {
                // Load user stats
                const { data: stats } = await supabaseClient
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                // Render stats
                document.getElementById('dashStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--ocean-light);">${stats?.total_logs || 0}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Temp Logs</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--success);">${stats?.points || 0}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Points</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${stats?.current_streak || 0} <i data-lucide="zap" style="width: 18px; height: 18px; vertical-align: middle;"></i></div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Day Streak</div>
                        </div>
                    </div>
                `;

                // Load upcoming swims user is attending
                console.log('Loading upcoming swims for user:', currentUser.id);

                const { data: memberEvents, error: eventsError } = await supabaseClient
                    .from('swim_event_members')
                    .select(`
                        *,
                        swim_events(*)
                    `)
                    .eq('user_id', currentUser.id)
                    .in('rsvp', ['yes', 'maybe']);

                console.log('Member events result:', { memberEvents, eventsError });

                // Filter for upcoming events in JavaScript
                const now = new Date();
                const upcomingSwims = memberEvents
                    ?.map(m => m.swim_events)
                    .filter(e => e && new Date(e.start_at) >= now)
                    .slice(0, 3) || [];

                console.log('Upcoming swims after filter:', upcomingSwims);

                if (upcomingSwims.length === 0) {
                    document.getElementById('dashUpcomingSwims').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
                            No upcoming swims yet<br>
                            <button class="btn" style="margin-top: 12px; width: auto; padding: 8px 16px; font-size: 13px;" onclick="showPage('events')">Browse Swims</button>
                        </div>
                    `;
                } else {
                    document.getElementById('dashUpcomingSwims').innerHTML = upcomingSwims.map(e => {
                        const d = new Date(e.start_at);
                        const isToday = d.toDateString() === new Date().toDateString();
                        const routeInfo = parseRouteFromNotes(e.notes);
                        return `
                            <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid rgba(56, 189, 248, 0.2); border-radius: 12px; padding: 12px; margin-bottom: 8px; cursor: pointer;" onclick="viewEventDetails('${e.id}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); font-size: 15px;">${e.title}</div>
                                        <div style="display: flex; gap: 6px; align-items: center; margin-top: 4px;">
                                            <div style="font-size: 12px; color: var(--text-secondary);"><i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${e.location_name}</div>
                                            ${routeInfo.route ? `
                                                <div style="background: rgba(56, 189, 248, 0.15); color: var(--ocean-light); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; border: 1px solid rgba(56, 189, 248, 0.2);">
                                                    ${routeInfo.route}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 13px; color: ${isToday ? 'var(--success)' : 'var(--ocean-light)'}; font-weight: 600;">
                                            ${isToday ? 'TODAY' : d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Initialize icons after rendering upcoming swims
                initIcons();

                // Load recent temperatures
                const { data: recentLogs } = await supabaseClient
                    .from('temp_logs')
                    .select(`
                        *,
                        spots(name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (!recentLogs || recentLogs.length === 0) {
                    document.getElementById('dashConditions').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
                            No recent temperatures logged
                        </div>
                    `;
                } else {
                    // Group by spot, show latest per spot
                    const bySpot = {};
                    recentLogs.forEach(log => {
                        if (!bySpot[log.spot_id]) bySpot[log.spot_id] = log;
                    });
                    const latest = Object.values(bySpot).slice(0, 4);

                    document.getElementById('dashConditions').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            ${latest.map(log => {
                        const color = log.temp_c < 12 ? '#3b82f6' : log.temp_c < 16 ? '#06b6d4' : log.temp_c < 20 ? '#10b981' : '#f59e0b';
                        const age = getAgeDisplay(log.created_at);
                        const isFresh = isTempFresh(log.created_at);
                        return `
                                    <div style="background: rgba(15, 23, 42, 0.6); border-radius: 10px; padding: 12px; text-align: center; ${!isFresh ? 'opacity: 0.6;' : ''}">
                                        <div style="font-size: 24px; font-weight: 700; color: ${color};">${log.temp_c}° <span style="font-size: 11px; font-weight: 400; color: var(--text-secondary);">${age}</span></div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${log.spots?.name || 'Unknown'}</div>
                                        <div style="font-size: 10px; color: var(--text-secondary); opacity: 0.7;">${getTimeAgo(new Date(log.created_at))}</div>
                                    </div>
                                `;
                    }).join('')}
                        </div>
                    `;
                }

            } catch (err) {
                console.error('Error loading dashboard:', err);
            }

            // Initialize icons after dashboard loads
            initIcons();
        }

        // History view state
        let historyView = 'my'; // 'my' or 'community'
        let tempChart = null;

        // Toggle history view
        function toggleHistoryView(el, view) {
            historyView = view;
            el.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            loadHistory();
        }

        // Load history and trends
        async function loadHistory() {
            const spotFilter = document.getElementById('historySpotFilter').value;

            try {
                // First, try simple query without joins
                let query = supabaseClient
                    .from('temp_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                // Filter by user if "My Logs" is selected
                if (historyView === 'my') {
                    query = query.eq('user_id', currentUser.id);
                }

                // Filter by spot if selected
                if (spotFilter) {
                    query = query.eq('spot_id', spotFilter);
                }

                const { data: logs, error } = await query;

                if (error) {
                    console.error('Error loading history:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    document.getElementById('historyList').innerHTML =
                        `<div style="color: var(--danger); text-align: center; padding: 20px;">
                            Error loading history<br>
                            <small style="font-size: 11px;">${error.message || 'Unknown error'}</small>
                        </div>`;
                    return;
                }

                console.log('Loaded logs:', logs);

                // Now load spot and profile data separately
                if (logs && logs.length > 0) {
                    const spotIds = [...new Set(logs.map(l => l.spot_id).filter(Boolean))];
                    const userIds = [...new Set(logs.map(l => l.user_id).filter(Boolean))];

                    // Load spots
                    const { data: spotsData } = await supabaseClient
                        .from('spots')
                        .select('id, name')
                        .in('id', spotIds);

                    // Load profiles
                    const { data: profilesData } = await supabaseClient
                        .from('profiles')
                        .select('id, display_name')
                        .in('id', userIds);

                    // Create lookup maps
                    const spotMap = {};
                    const profileMap = {};

                    if (spotsData) spotsData.forEach(s => spotMap[s.id] = s);
                    if (profilesData) profilesData.forEach(p => profileMap[p.id] = p);

                    // Attach to logs
                    logs.forEach(log => {
                        log.spots = spotMap[log.spot_id] || null;
                        log.profiles = profileMap[log.user_id] || null;
                    });
                }

                // Render list
                renderHistoryList(logs);

                // Render chart
                renderTempChart(logs);
            } catch (err) {
                console.error('Caught error:', err);
                document.getElementById('historyList').innerHTML =
                    `<div style="color: var(--danger); text-align: center; padding: 20px;">
                        Unexpected error<br>
                        <small style="font-size: 11px;">${err.message}</small>
                    </div>`;
            }
        }

        // Render history list
        function renderHistoryList(logs) {
            const container = document.getElementById('historyList');

            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        No temperature logs yet. Be the first to log!
                    </div>
                `;
                return;
            }

            // Group by spot to get latest per spot
            const bySpot = {};
            logs.forEach(log => {
                if (!bySpot[log.spot_id]) {
                    bySpot[log.spot_id] = log;
                }
            });

            const allSpots = Object.values(bySpot);

            // Separate fresh (<=96h) and stale (>96h)
            const freshTemps = allSpots.filter(log => isTempFresh(log.created_at));
            const staleTemps = allSpots.filter(log => !isTempFresh(log.created_at));

            let html = '';

            // Fresh temps section
            if (freshTemps.length > 0) {
                html += freshTemps.map(log => {
                    const date = new Date(log.created_at);
                    const timeAgo = getTimeAgo(date);
                    const age = getAgeDisplay(log.created_at);
                    const spotName = log.spots?.name || 'Unknown';
                    const userName = log.profiles?.display_name || 'Anonymous';

                    return `
                    <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid rgba(56, 189, 248, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--ocean-light);">
                                    ${log.temp_c}°C <span style="font-size: 12px; font-weight: 400; color: var(--text-secondary);">${age}</span>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    <i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${spotName}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${timeAgo}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${userName}
                                </div>
                            </div>
                        </div>
                        ${log.conditions ? `
                            <div style="display: inline-block; background: rgba(56, 189, 248, 0.2); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-top: 6px;">
                                ${log.conditions}
                            </div>
                        ` : ''}
                        ${log.hazards && log.hazards.length > 0 ? log.hazards.map(h => `
                            <div style="display: inline-block; background: rgba(245, 158, 11, 0.2); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-top: 6px;">
                                ${h}
                            </div>
                        `).join('') : ''}
                        ${log.notes ? `
                            <div style="margin-top: 10px; font-size: 13px; color: var(--text-secondary); font-style: italic;">
                                "${log.notes}"
                            </div>
                        ` : ''}
                    </div>
                `;
                }).join('');
            }

            // Stale temps section (collapsible)
            if (staleTemps.length > 0) {
                html += `
                    <div style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 16px;">
                        <div onclick="toggleStaleTemps()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.4); border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">
                                <i data-lucide="clock" style="width: 14px; height: 14px; vertical-align: middle;"></i> Stale Temperatures (${staleTemps.length})
                            </div>
                            <i id="staleToggleIcon" data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                        </div>
                        <div id="staleTempsContainer" style="display: none;">
                            ${staleTemps.map(log => {
                    const date = new Date(log.created_at);
                    const timeAgo = getTimeAgo(date);
                    const age = getAgeDisplay(log.created_at);
                    const spotName = log.spots?.name || 'Unknown';
                    const userName = log.profiles?.display_name || 'Anonymous';

                    return `
                                    <div style="background: rgba(15, 23, 42, 0.4); border: 2px solid rgba(56, 189, 248, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 12px; opacity: 0.6;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <div style="font-size: 18px; font-weight: 600; color: var(--ocean-light);">
                                                    ${log.temp_c}°C <span style="font-size: 12px; font-weight: 400; color: var(--text-secondary);">${age}</span>
                                                </div>
                                                <div style="font-size: 13px; color: var(--text-secondary);">
                                                    <i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${spotName}
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">
                                                    ${timeAgo}
                                                </div>
                                                <div style="font-size: 12px; color: var(--text-secondary);">
                                                    ${userName}
                                                </div>
                                            </div>
                                        </div>
                                        ${log.conditions ? `
                                            <div style="display: inline-block; background: rgba(56, 189, 248, 0.1); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-top: 6px;">
                                                ${log.conditions}
                                            </div>
                                        ` : ''}
                                        ${log.hazards && log.hazards.length > 0 ? log.hazards.map(h => `
                                            <div style="display: inline-block; background: rgba(245, 158, 11, 0.1); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-top: 6px;">
                                                ${h}
                                            </div>
                                        `).join('') : ''}
                                        ${log.notes ? `
                                            <div style="margin-top: 10px; font-size: 13px; color: var(--text-secondary); font-style: italic;">
                                                "${log.notes}"
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            initIcons();
        }

        // Toggle stale temps visibility
        function toggleStaleTemps() {
            const container = document.getElementById('staleTempsContainer');
            const icon = document.getElementById('staleToggleIcon');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.setAttribute('data-lucide', 'chevron-up');
            } else {
                container.style.display = 'none';
                icon.setAttribute('data-lucide', 'chevron-down');
            }
            initIcons();
        }

        // Render temperature chart
        function renderTempChart(logs) {
            const ctx = document.getElementById('tempChart');

            if (!logs || logs.length === 0) {
                ctx.style.display = 'none';
                return;
            }

            ctx.style.display = 'block';

            // Prepare data (reverse to show oldest to newest)
            const reversedLogs = [...logs].reverse();
            const labels = reversedLogs.map(log => {
                const date = new Date(log.created_at);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const temps = reversedLogs.map(log => log.temp_c);

            // Destroy existing chart
            if (tempChart) {
                tempChart.destroy();
            }

            // Create new chart
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Water Temperature (°C)',
                        data: temps,
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#38bdf8',
                        pointBorderColor: '#0c4a6e',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(56, 189, 248, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8',
                                callback: function (value) {
                                    return value + '°C';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(56, 189, 248, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        // Helper: Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';

            return date.toLocaleDateString();
        }

        // ========== SWIM EVENTS ==========

        // Show/hide create event modal
        function showCreateEvent() {
            document.getElementById('createEventModal').style.display = 'block';
        }

        function hideCreateEvent() {
            document.getElementById('createEventModal').style.display = 'none';
            document.getElementById('createEventForm').reset();
        }

        // Load events
        async function loadEvents() {
            try {
                console.log('Loading events...');

                // Query using your actual column names
                const { data: events, error } = await supabaseClient
                    .from('swim_events')
                    .select('*')
                    .order('start_at', { ascending: true })
                    .limit(20);

                console.log('Events query result:', { events, error });

                if (error) {
                    console.error('Error loading events:', error);
                    document.getElementById('eventsList').innerHTML =
                        `<div style="color: var(--danger); text-align: center; padding: 20px;">
                            Error loading events<br>
                            <small style="font-size: 11px;">${error.message || JSON.stringify(error)}</small>
                        </div>`;
                    return;
                }

                // Filter out past events
                const now = new Date();
                let upcomingEvents = events?.filter(e => new Date(e.start_at) >= now) || [];

                // Apply pace filter if selected
                const paceFilter = document.getElementById('eventPaceFilter')?.value;
                if (paceFilter) {
                    const targetPace = parseInt(paceFilter, 10);
                    upcomingEvents = upcomingEvents.filter(e => e.target_pace_sec_per_100m === targetPace);
                }

                console.log('Upcoming events:', upcomingEvents);

                // If no events, show empty state
                if (!upcomingEvents || upcomingEvents.length === 0) {
                    document.getElementById('eventsList').innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;"><i data-lucide="waves" style="width: 48px; height: 48px;"></i></div>
                            <div style="font-size: 16px; margin-bottom: 8px;">No upcoming swims</div>
                            <div style="font-size: 13px;">Be the first to create one!</div>
                        </div>
                    `;
                    return;
                }

                console.log('Successfully loaded events:', upcomingEvents);

                // Load creator profiles
                const creatorIds = [...new Set(upcomingEvents.map(e => e.created_by).filter(Boolean))];
                const { data: profilesData } = await supabaseClient
                    .from('profiles')
                    .select('id, display_name')
                    .in('id', creatorIds);

                const profileMap = {};
                if (profilesData) profilesData.forEach(p => profileMap[p.id] = p);

                console.log('Profile map:', profileMap);
                console.log('Creator IDs needed:', creatorIds);

                // Load user's RSVP status for these events
                const eventIds = upcomingEvents.map(e => e.id);
                const { data: userRsvps } = await supabaseClient
                    .from('swim_event_members')
                    .select('event_id, rsvp')
                    .eq('user_id', currentUser.id)
                    .in('event_id', eventIds);

                const rsvpMap = {};
                if (userRsvps) userRsvps.forEach(r => rsvpMap[r.event_id] = r.rsvp);

                // Show events with your actual data structure
                const html = upcomingEvents.map(event => {
                    const eventDate = new Date(event.start_at);
                    const dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const timeStr = eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const creatorName = profileMap[event.created_by]?.display_name || 'Anonymous';
                    const userRsvp = rsvpMap[event.id]; // Get user's RSVP status

                    // Build RSVP buttons based on user's status
                    let rsvpButtons;
                    if (userRsvp === 'yes') {
                        rsvpButtons = `
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <button class="btn btn-success" style="flex: 1; padding: 10px; font-size: 13px;" disabled>
                                    <i data-lucide="check" style="width: 14px; height: 14px; vertical-align: middle;"></i> You're Going
                                </button>
                                <button class="btn" style="padding: 10px 16px; font-size: 13px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3);" onclick="event.stopPropagation(); leaveEvent('${event.id}')">
                                    Cancel
                                </button>
                                <button class="btn btn-outline" style="padding: 10px 16px; font-size: 13px;" onclick="event.stopPropagation(); viewEventDetails('${event.id}')">
                                    Details
                                </button>
                            </div>
                            <div style="margin-top: 8px;">
                                <button class="btn" style="width: 100%; padding: 8px; font-size: 12px; background: rgba(234, 179, 8, 0.2); border: 1px solid rgba(234, 179, 8, 0.4); color: var(--warning);" onclick="event.stopPropagation(); showRunningLate('${event.id}')">
                                    <i data-lucide="clock" style="width: 14px; height: 14px; vertical-align: middle;"></i> Running Late / Traffic
                                </button>
                            </div>
                        `;
                    } else if (userRsvp === 'maybe') {
                        rsvpButtons = `
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <button class="btn btn-success" style="flex: 1; padding: 10px; font-size: 13px;" onclick="event.stopPropagation(); joinEvent('${event.id}', 'yes')">
                                    Confirm Going
                                </button>
                                <button class="btn" style="padding: 10px 16px; font-size: 13px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3);" onclick="event.stopPropagation(); leaveEvent('${event.id}')">
                                    Cancel
                                </button>
                                <button class="btn btn-outline" style="padding: 10px 16px; font-size: 13px;" onclick="event.stopPropagation(); viewEventDetails('${event.id}')">
                                    Details
                                </button>
                            </div>
                            <div style="font-size: 11px; color: var(--warning); margin-top: 4px; text-align: center;">? You marked Maybe</div>
                        `;
                    } else {
                        rsvpButtons = `
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <button class="btn btn-success" style="flex: 1; padding: 10px; font-size: 13px;" onclick="event.stopPropagation(); joinEvent('${event.id}', 'yes')">
                                    I'm Going
                                </button>
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(234, 179, 8, 0.2); border: 1px solid rgba(234, 179, 8, 0.3);" onclick="event.stopPropagation(); joinEvent('${event.id}', 'maybe')">
                                    Maybe
                                </button>
                                <button class="btn btn-outline" style="padding: 10px 16px; font-size: 13px;" onclick="event.stopPropagation(); viewEventDetails('${event.id}')">
                                    Details
                                </button>
                            </div>
                        `;
                    }

                    const routeInfo = parseRouteFromNotes(event.notes);

                    return `
                        <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid rgba(56, 189, 248, 0.2); border-radius: 12px; padding: 18px; margin-bottom: 14px; cursor: pointer;" onclick="viewEventDetails('${event.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                        ${event.title || 'Untitled Swim'}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        <i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${event.location_name || 'Location TBD'}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 14px; color: var(--ocean-light); font-weight: 600;">
                                        ${dateStr}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        ${timeStr}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                                ${event.category ? `
                                    <div style="background: rgba(56, 189, 248, 0.2); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                        ${event.category}
                                    </div>
                                ` : ''}
                                ${routeInfo.route ? `
                                    <div style="background: rgba(56, 189, 248, 0.3); border: 1px solid var(--ocean-light); padding: 6px 12px; border-radius: 6px; font-size: 12px; color: white;">
                                        <i data-lucide="repeat" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${routeInfo.route}
                                    </div>
                                ` : ''}
                                ${event.distance_km ? `
                                    <div style="background: rgba(16, 185, 129, 0.2); padding: 6px 12px; border-radius: 6px; font-size: 12px;">
                                        <i data-lucide="ruler" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${event.distance_km}km
                                    </div>
                                ` : ''}
                                ${event.suit ? `
                                    <div style="background: rgba(139, 92, 246, 0.2); padding: 6px 12px; border-radius: 6px; font-size: 12px;">
                                        <i data-lucide="waves" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${event.suit}
                                    </div>
                                ` : ''}
                                ${event.target_pace_sec_per_100m ? `
                                    <div style="background: rgba(251, 191, 36, 0.2); padding: 6px 12px; border-radius: 6px; font-size: 12px;">
                                        ${event.target_pace_sec_per_100m === 100 ? '<i data-lucide="zap" style="width: 14px; height: 14px; vertical-align: middle;"></i> Fast' :
                                event.target_pace_sec_per_100m === 120 ? '<i data-lucide="trending-up" style="width: 14px; height: 14px; vertical-align: middle;"></i> Steady' :
                                    event.target_pace_sec_per_100m === 150 ? '<i data-lucide="users" style="width: 14px; height: 14px; vertical-align: middle;"></i> Social' :
                                        '<i data-lucide="heart" style="width: 14px; height: 14px; vertical-align: middle;"></i> Developing'}
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${routeInfo.notes ? `
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.5;">
                                    ${routeInfo.notes.substring(0, 100)}${routeInfo.notes.length > 100 ? '...' : ''}
                                </div>
                            ` : ''}
                            
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                Created by ${creatorName}
                            </div>
                            
                            ${rsvpButtons}
                        </div>
                    `;
                }).join('');

                document.getElementById('eventsList').innerHTML = html;
                initIcons(); // Initialize Lucide icons

            } catch (err) {
                console.error('Caught error:', err);
                document.getElementById('eventsList').innerHTML =
                    `<div style="color: var(--danger); text-align: center; padding: 20px;">
                        Unexpected error<br>
                        <small style="font-size: 11px;">${err.message}</small>
                    </div>`;
            }
        }

        // Render events list
        function renderEventsList(events) {
            const container = document.getElementById('eventsList');

            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;"><i data-lucide="waves" style="width: 48px; height: 48px;"></i></div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No upcoming swims</div>
                        <div style="font-size: 13px;">Be the first to create one!</div>
                    </div>
                `;
                return;
            }

            const paceEmojis = {
                fast: 'zap',
                steady: 'trending-up',
                social: 'users',
                developing: 'heart'
            };

            const paceLabels = {
                elite: 'Elite',
                advanced: 'Advanced',
                intermediate: 'Intermediate',
                beginner: 'Beginner'
            };

            const html = events.map(event => {
                const eventDate = new Date(event.event_date);
                const isToday = eventDate.toDateString() === new Date().toDateString();
                const dateStr = isToday ? 'Today' : eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const timeStr = eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                const spotName = event.spot?.name || 'Unknown Location';
                const creatorName = event.creator?.display_name || 'Anonymous';
                const paceIcon = paceEmojis[event.pace_level] || 'users';
                const paceHtml = `<i data-lucide="${paceIcon}" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>`;
                const paceLabel = paceLabels[event.pace_level] || event.pace_level;

                const confirmed = event.memberCount?.confirmed || 0;
                const pending = event.memberCount?.pending || 0;
                const maxPart = event.max_participants;
                const spotsLeft = maxPart ? (maxPart - confirmed) : null;

                return `
                    <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid rgba(56, 189, 248, 0.2); border-radius: 12px; padding: 18px; margin-bottom: 14px; cursor: pointer;" onclick="viewEventDetails('${event.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                    ${event.event_name}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    <i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${spotName}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: var(--ocean-light); font-weight: 600;">
                                    ${dateStr}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    ${timeStr}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                            <div style="background: rgba(56, 189, 248, 0.2); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                ${paceEmoji} ${paceLabel}
                            </div>
                            <div style="background: rgba(16, 185, 129, 0.2); padding: 6px 12px; border-radius: 6px; font-size: 12px;">
                                <i data-lucide="ruler" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${event.distance_km}km
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.2); padding: 6px 12px; border-radius: 6px; font-size: 12px;">
                                <i data-lucide="users" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${confirmed} confirmed${pending > 0 ? ` (+${pending} pending)` : ''}
                                ${spotsLeft !== null ? ` • ${spotsLeft} spots left` : ''}
                            </div>
                        </div>
                        
                        ${event.description ? `
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.5;">
                                ${event.description.substring(0, 100)}${event.description.length > 100 ? '...' : ''}
                            </div>
                        ` : ''}
                        
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            Created by ${creatorName}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            initIcons();
        }

        // Submit new event  
        async function submitEvent(e) {
            e.preventDefault();

            // Get form values
            const title = document.getElementById('eventName')?.value;
            const spotSelect = document.getElementById('eventSpot');
            const spotId = spotSelect?.value;
            const startAt = document.getElementById('eventDateTime')?.value;
            const paceLevel = document.getElementById('eventPaceLevel')?.value;
            const distanceKm = parseFloat(document.getElementById('eventDistance')?.value);
            const notes = document.getElementById('eventDescription')?.value;

            // Find the spot name from the ID
            const spot = spots.find(s => s.id === spotId);
            const locationName = spot ? spot.name : spotSelect?.options[spotSelect.selectedIndex]?.text;

            // Pace level is now stored directly as integer (no mapping needed)
            const targetPace = parseInt(paceLevel, 10);

            // Handle Route Type persistence in notes
            const routeType = document.getElementById('eventRouteType')?.value;
            let finalNotes = notes || '';
            if (routeType) {
                finalNotes = `Route: ${routeType}${finalNotes ? ' | ' + finalNotes : ''}`;
            }

            const eventData = {
                created_by: currentUser.id,
                title: title,
                start_at: startAt,
                location_name: locationName,  // Now using spot NAME not ID
                lat: spot?.latitude || null,
                lng: spot?.longitude || null,
                distance_km: distanceKm,
                target_pace_sec_per_100m: targetPace,
                suit: null,  // Optional - removed requirement
                visibility: 'open',  // Valid values: 'open' or 'invite_only'
                notes: finalNotes,
                status: 'planned',
                category: 'open'
            };

            console.log('CREATE_SWIM payload', eventData);

            const { data, error } = await supabaseClient
                .from('swim_events')
                .insert([eventData])
                .select();

            if (error) {
                alert('Error creating event: ' + error.message);
                console.error('Event creation error:', error);
                return;
            }

            console.log('Event created:', data);

            // Auto-join creator as organizer
            if (data && data[0]) {
                try {
                    await supabaseClient
                        .from('swim_event_members')
                        .insert([{
                            event_id: data[0].id,
                            user_id: currentUser.id,
                            role: 'organizer',
                            rsvp: 'yes'
                        }]);
                } catch (err) {
                    console.error('Could not auto-join event:', err);
                }
            }


            showToast('Swim created successfully!', 'success');
            hideCreateEvent();
            loadEvents();
        }

        // View event details (placeholder)
        // RSVP to event
        async function rsvpToEvent(eventId, rsvpStatus) {
            try {
                // Check if user already has a membership record
                const { data: existing } = await supabaseClient
                    .from('swim_event_members')
                    .select('id')
                    .eq('event_id', eventId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    // Update existing RSVP
                    const { error } = await supabaseClient
                        .from('swim_event_members')
                        .update({ rsvp: rsvpStatus })
                        .eq('id', existing.id);

                    if (error) throw error;
                } else {
                    // Create new RSVP
                    const { error } = await supabaseClient
                        .from('swim_event_members')
                        .insert({
                            event_id: eventId,
                            user_id: currentUser.id,
                            role: 'member',
                            rsvp: rsvpStatus
                        });

                    if (error) throw error;
                }

                // Show success message
                if (rsvpStatus === 'yes') {
                    showToast("You're going! See you there!", 'success');
                } else {
                    alert('👍 Marked as maybe. You can confirm later.');
                }

                // Reload events to update UI
                await loadEvents();

            } catch (error) {
                console.error('Error RSVPing:', error);
                alert('Error updating RSVP: ' + error.message);
            }
        }

        // View event (compatibility function)
        function viewEvent(eventId) {
            showEventDetails(eventId);
        }

        // View event details (wrapper for compatibility)
        async function viewEventDetails(eventId) {
            showPage('events');
            await showEventDetails(eventId);
        }

        // Show event details modal
        async function showEventDetails(eventId) {
            // Find the event
            const event = await loadEventDetails(eventId);
            if (!event) return;

            document.getElementById('eventDetailsModal').style.display = 'block';
            renderEventDetails(event);
        }

        function hideEventDetails() {
            document.getElementById('eventDetailsModal').style.display = 'none';
        }

        async function loadEventDetails(eventId) {
            try {
                console.log('Loading event details for:', eventId);

                const { data: event, error } = await supabaseClient
                    .from('swim_events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                console.log('Event loaded:', event);

                // Load creator profile
                const { data: creatorProfile, error: creatorError } = await supabaseClient
                    .from('profiles')
                    .select('display_name')
                    .eq('id', event.created_by)
                    .maybeSingle();

                if (creatorError) {
                    console.error('Error loading creator:', creatorError);
                }

                event.creatorName = creatorProfile?.display_name || 'Anonymous';
                console.log('Creator:', event.creatorName);

                // Load participants - simple query without join
                const { data: members, error: membersError } = await supabaseClient
                    .from('swim_event_members')
                    .select('*')
                    .eq('event_id', eventId);

                console.log('Members loaded:', { members, membersError });

                // Load profiles for these members separately
                if (members && members.length > 0) {
                    const userIds = members.map(m => m.user_id);
                    const { data: profiles } = await supabaseClient
                        .from('profiles')
                        .select('id, display_name')
                        .in('id', userIds);

                    console.log('Profiles loaded:', profiles);

                    // Attach profiles to members
                    members.forEach(member => {
                        const profile = profiles?.find(p => p.id === member.user_id);
                        member.profiles = profile;
                    });
                }

                event.members = members || [];

                // Check if current user is attending
                event.userRsvp = members?.find(m => m.user_id === currentUser.id)?.rsvp;

                console.log('User RSVP status:', event.userRsvp);

                return event;
            } catch (err) {
                console.error('Error loading event:', err);
                alert('Error loading event details: ' + err.message);
                return null;
            }
        }

        function renderEventDetails(event) {
            const eventDate = new Date(event.start_at);
            const attending = event.members.filter(m => m.rsvp === 'yes').length;
            const maybe = event.members.filter(m => m.rsvp === 'maybe').length;

            const html = `
                <div style="margin-bottom: 20px;">
                    <h2 style="font-size: 24px; color: var(--text-primary); margin-bottom: 8px;">${event.title || 'Group Swim'}</h2>
                    <div style="color: var(--text-secondary); font-size: 14px;">Created by ${event.creatorName}</div>
                </div>
                
                <div style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="margin-bottom: 12px;">
                        <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> LOCATION</span>
                        <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-top: 4px;">${event.location_name}</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="calendar" style="width: 14px; height: 14px; vertical-align: middle;"></i> DATE & TIME</span>
                        <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-top: 4px;">
                            ${eventDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                            <br>${eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </div>
                    
                    ${event.distance_km ? `
                        <div style="margin-bottom: 12px;">
                            <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="ruler" style="width: 14px; height: 14px; vertical-align: middle;"></i> DISTANCE</span>
                            <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-top: 4px;">${event.distance_km}km</div>
                        </div>
                    ` : ''}
                    
                    ${(function () {
                    const routeInfo = parseRouteFromNotes(event.notes);
                    return routeInfo.route ? `
                            <div style="margin-bottom: 12px;">
                                <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="repeat" style="width: 14px; height: 14px; vertical-align: middle;"></i> ROUTE TYPE</span>
                                <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-top: 4px;">${routeInfo.route}</div>
                            </div>
                        ` : '';
                })()}
                    
                    ${(function () {
                    const routeInfo = parseRouteFromNotes(event.notes);
                    return routeInfo.notes ? `
                            <div>
                                <span style="color: var(--text-secondary); font-size: 13px;">DETAILS</span>
                                <div style="color: var(--text-primary); font-size: 14px; margin-top: 4px; line-height: 1.6;">${routeInfo.notes}</div>
                            </div>
                        ` : '';
                })()}
                </div>
                
                <div style="background: rgba(56, 189, 248, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-weight: 600; color: var(--ocean-light); margin-bottom: 12px;"><i data-lucide="users" style="width: 14px; height: 14px; vertical-align: middle;"></i> Participants (${attending}${maybe > 0 ? ` + ${maybe} maybe` : ''})</div>
                    ${event.members.length > 0 ?
                    event.members.map(m => `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--ocean-blue); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                    ${m.profiles?.display_name?.charAt(0) || '?'}
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: var(--text-primary); font-size: 14px;">${m.profiles?.display_name || 'Anonymous'}</div>
                                    ${m.role === 'organizer' ? '<div style="color: var(--ocean-light); font-size: 12px;">Swim Host</div>' : ''}
                                </div>
                                <div style="color: var(--text-secondary); font-size: 12px;">
                                    ${m.rsvp === 'yes' ? '✓ Going' : m.rsvp === 'maybe' ? '? Maybe' : ''}
                                </div>
                            </div>
                        `).join('')
                    : '<div style="color: var(--text-secondary); font-size: 13px;">No one has joined yet. Be the first!</div>'
                }
                </div>
                
                <div id="eventDetailsActions"></div>
            `;

            document.getElementById('eventDetailsContent').innerHTML = html;

            // Render action buttons
            renderEventActions(event);
        }

        function renderEventActions(event) {
            const container = document.getElementById('eventDetailsActions');

            if (event.userRsvp === 'yes') {
                container.innerHTML = `
                    <button class="btn" style="background: var(--success);" disabled><i data-lucide="check" style="width: 14px; height: 14px; vertical-align: middle;"></i> You're Going</button>
                    <button class="btn" style="background: transparent; border: 2px solid var(--danger); color: var(--danger); margin-top: 10px;" onclick="leaveEvent('${event.id}')">Leave Swim</button>
                `;
            } else if (event.userRsvp === 'maybe') {
                container.innerHTML = `
                    <button class="btn btn-success" onclick="joinEvent('${event.id}', 'yes')">Confirm - I'm Going!</button>
                    <button class="btn" style="background: transparent; border: 2px solid var(--text-secondary); color: var(--text-secondary); margin-top: 10px;" onclick="leaveEvent('${event.id}')">Cancel RSVP</button>
                `;
            } else {
                container.innerHTML = `
                    <button class="btn btn-success" onclick="joinEvent('${event.id}', 'yes')">Join Swim</button>
                    <button class="btn" style="background: rgba(255,255,255,0.1); margin-top: 10px;" onclick="joinEvent('${event.id}', 'maybe')">Maybe</button>
                `;
            }
        }

        async function joinEvent(eventId, rsvp) {
            try {
                console.log('Joining event:', eventId, 'with RSVP:', rsvp);

                // Check if already a member
                const { data: existing, error: checkError } = await supabaseClient
                    .from('swim_event_members')
                    .select('id')
                    .eq('event_id', eventId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (checkError) {
                    console.error('Error checking membership:', checkError);
                    throw checkError;
                }

                console.log('Existing membership:', existing);

                if (existing) {
                    // Update existing RSVP
                    const { error } = await supabaseClient
                        .from('swim_event_members')
                        .update({ rsvp: rsvp })
                        .eq('id', existing.id);

                    if (error) throw error;
                } else {
                    // Create new membership
                    console.log('Creating new membership for user:', currentUser.id);

                    const { data: inserted, error } = await supabaseClient
                        .from('swim_event_members')
                        .insert({
                            event_id: eventId,
                            user_id: currentUser.id,
                            role: 'member',
                            rsvp: rsvp
                        })
                        .select();

                    console.log('Insert result:', { inserted, error });

                    if (error) throw error;
                }

                console.log('Successfully joined event:', eventId, 'with RSVP:', rsvp);

                // FORCE refresh event details modal if it's open
                const modal = document.getElementById('eventDetailsModal');
                console.log('Modal element:', modal);
                console.log('Modal display:', modal ? modal.style.display : 'modal not found');

                if (modal && modal.style.display === 'block') {
                    console.log('Modal is open - refreshing...');
                    // Force refresh by reloading event details
                    await showEventDetails(eventId);
                    console.log('Modal refreshed!');
                } else {
                    console.log('Modal not open, skipping refresh');
                }

                showToast(rsvp === 'yes' ? "You're in!" : 'Marked as maybe', 'success');

                loadEvents(); // Refresh list
                loadDashboard(); // Refresh dashboard
            } catch (err) {
                console.error('Error joining event:', err);
                alert('Error joining event: ' + err.message);
            }
        }

        async function leaveEvent(eventId) {
            if (!confirm('Leave this swim?')) return;

            try {
                const { error } = await supabaseClient
                    .from('swim_event_members')
                    .delete()
                    .eq('event_id', eventId)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                showToast('You\'ve left the swim', 'info');

                // Refresh event details modal if it's open
                const modal = document.getElementById('eventDetailsModal');
                if (modal && modal.style.display === 'block') {
                    await showEventDetails(eventId); // Refresh the modal
                }

                loadEvents(); // Refresh events list
                loadDashboard(); // Refresh dashboard
            } catch (err) {
                alert('Error leaving event: ' + err.message);
            }
        }

        // Show running late options
        function showRunningLate(eventId) {
            const options = [
                { label: '5 mins late', value: 5 },
                { label: '10 mins late', value: 10 },
                { label: '15 mins late', value: 15 },
                { label: 'Just leaving now', value: 20 },
                { label: 'Cancel - can\'t make it', value: null }
            ];

            const optionsText = options.map((o, i) => `${i + 1}. ${o.label}`).join('\n');
            const choice = prompt(`Running late due to traffic?\n\n${optionsText}\n\nEnter number (1-${options.length}):`);

            if (!choice) return; // Cancelled

            const selectedIndex = parseInt(choice) - 1;
            if (selectedIndex < 0 || selectedIndex >= options.length) {
                alert('Invalid choice');
                return;
            }

            const selected = options[selectedIndex];

            if (selected.value === null) {
                // User chose to cancel
                leaveEvent(eventId);
            } else {
                // Mark as running late
                markRunningLate(eventId, selected.value, selected.label);
            }
        }

        // Mark user as running late
        async function markRunningLate(eventId, minutes, label) {
            try {
                // Update the member record with a note about being late
                const { data: existing } = await supabaseClient
                    .from('swim_event_members')
                    .select('id')
                    .eq('event_id', eventId)
                    .eq('user_id', currentUser.id)
                    .single();

                if (!existing) {
                    alert('Error: Not found as member');
                    return;
                }

                // For now, we'll just show a toast
                // In future, we could store this in a 'status' field or send notifications
                showToast(`Marked as ${label}. Others will be notified!`, 'info');

                // Could add: Update database with status
                // Could add: Send notification to other participants
                // Could add: Show on event details

            } catch (err) {
                console.error('Error marking late:', err);
                alert('Error updating status: ' + err.message);
            }
        }

        function showToast(message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--ocean-blue)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: 600;
                z-index: 10000;
                animation: slideUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========== PROFILE SETTINGS ==========

        // Global to store profile being edited
        let editingProfile = null;
        // Avatar options (ocean-themed Lucide icons)
        const AVATARS = [
            { icon: 'anchor', color: '#3b82f6', name: 'Anchor' },
            { icon: 'waves', color: '#06b6d4', name: 'Waves' },
            { icon: 'compass', color: '#10b981', name: 'Compass' },
            { icon: 'ship', color: '#f59e0b', name: 'Ship' },
            { icon: 'sailboat', color: '#ef4444', name: 'Sailboat' },
            { icon: 'fish', color: '#8b5cf6', name: 'Fish' },
            { icon: 'droplets', color: '#ec4899', name: 'Droplets' },
            { icon: 'gem', color: '#14b8a6', name: 'Gem' },
            { icon: 'zap', color: '#6366f1', name: 'Lightning' },
            { icon: 'flame', color: '#f97316', name: 'Flame' },
            { icon: 'star', color: '#84cc16', name: 'Star' },
            { icon: 'trophy', color: '#06b6d4', name: 'Trophy' },
            { icon: 'shield', color: '#0ea5e9', name: 'Shield' },
            { icon: 'target', color: '#22c55e', name: 'Target' },
            { icon: 'award', color: '#a855f7', name: 'Award' },
            { icon: 'crown', color: '#f43f5e', name: 'Crown' }
        ];

        async function showProfileSettings() {
            // Instant open
            console.log('OPEN_PROFILE');
            document.getElementById('profileModal').style.display = 'block';
            document.getElementById('profileEmail').textContent = currentUser.email;

            // Load current profile
            try {
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (profile) {
                    editingProfile = profile;
                    selectedAvatar = profile.avatar_url;

                    document.getElementById('profileDisplayName').value = profile.display_name || '';
                    document.getElementById('profileHomeBeach').value = profile.home_beach_id || '';
                    document.getElementById('profilePreferredSuit').value = profile.preferred_suit || 'both';
                    document.getElementById('profileColdTolerance').value = profile.cold_tolerance_min_c || '';

                    // Times
                    if (profile.pool_1km_time_seconds) {
                        const mins = Math.floor(profile.pool_1km_time_seconds / 60);
                        const secs = profile.pool_1km_time_seconds % 60;
                        document.getElementById('profilePoolTime').value = `${mins}:${secs.toString().padStart(2, '0')}`;
                    } else {
                        document.getElementById('profilePoolTime').value = '';
                    }

                    if (profile.ocean_1km_time_seconds) {
                        const mins = Math.floor(profile.ocean_1km_time_seconds / 60);
                        const secs = profile.ocean_1km_time_seconds % 60;
                        document.getElementById('profileOceanTime').value = `${mins}:${secs.toString().padStart(2, '0')}`;
                    } else {
                        document.getElementById('profileOceanTime').value = '';
                    }
                }

                renderAvatarGrid();
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }

        function renderAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            if (!grid) return;
            grid.innerHTML = '';

            AVATARS.forEach(avatar => {
                const div = document.createElement('div');
                const isSelected = selectedAvatar === avatar.icon;
                div.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 18px;
                    border-radius: 14px;
                    background: ${avatar.color};
                    opacity: ${isSelected ? '1' : '0.75'};
                    border: 3px solid ${isSelected ? 'white' : 'transparent'};
                    transition: all 0.2s;
                    box-shadow: ${isSelected ? '0 6px 16px rgba(0,0,0,0.35)' : '0 2px 8px rgba(0,0,0,0.15)'};
                    transform: ${isSelected ? 'scale(1.05)' : 'scale(1)'};
                `;
                div.innerHTML = `<i data-lucide="${avatar.icon}" style="width: 28px; height: 28px; color: white;"></i>`;
                div.title = avatar.name;
                div.onmouseenter = () => {
                    if (!isSelected) {
                        div.style.opacity = '0.9';
                        div.style.transform = 'scale(1.05)';
                    }
                };
                div.onmouseleave = () => {
                    if (!isSelected) {
                        div.style.opacity = '0.75';
                        div.style.transform = 'scale(1)';
                    }
                };
                div.onclick = () => {
                    selectedAvatar = avatar.icon;
                    renderAvatarGrid();
                };
                grid.appendChild(div);
            });
            initIcons(); // Re-initialize Lucide icons
        }

        function hideProfileSettings() {
            document.getElementById('profileModal').style.display = 'none';
        }

        async function saveProfile() {
            const displayName = document.getElementById('profileDisplayName').value;
            const homeBeachId = document.getElementById('profileHomeBeach').value;
            const preferredSuit = document.getElementById('profilePreferredSuit').value;
            const coldTolerance = document.getElementById('profileColdTolerance').value;
            const poolTimeStr = document.getElementById('profilePoolTime').value;
            const oceanTimeStr = document.getElementById('profileOceanTime').value;

            if (!displayName) {
                alert('Please enter a display name');
                return;
            }

            // Helper: mm:ss OR raw seconds to integer seconds (Tolerant)
            const mmssToSeconds = (val) => {
                if (!val) return null;
                const s = String(val).trim();
                if (!s) return null;

                // Normalize separators: dots, spaces, semicolons -> colon
                const normalized = s.replace(/[.;\s]+/g, ':');

                // If digits only
                if (/^\d+$/.test(normalized)) return parseInt(normalized, 10);

                // If mm:ss
                const parts = normalized.split(':');
                if (parts.length === 2) {
                    const m = parseInt(parts[0], 10) || 0;
                    const sc = parseInt(parts[1], 10) || 0;
                    // Basic validation: seconds should be < 60
                    if (sc >= 60) return null;
                    return m * 60 + sc;
                }
                return null;
            };

            // Derive Tier
            const poolTierFromSeconds = (poolSec) => {
                if (poolSec == null) return null;
                if (poolSec < 870) return "fast";
                if (poolSec <= 989) return "steady";
                if (poolSec <= 1140) return "social";
                return "developing";
            };

            const poolSeconds = mmssToSeconds(poolTimeStr);
            const oceanSeconds = mmssToSeconds(oceanTimeStr);
            const experienceLevel = poolTierFromSeconds(poolSeconds);

            const payload = {
                display_name: displayName,
                home_beach_id: homeBeachId || null,
                preferred_suit: preferredSuit,
                cold_tolerance_min_c: coldTolerance ? parseFloat(coldTolerance) : null,
                pool_1km_time_seconds: poolSeconds,
                ocean_1km_time_seconds: oceanSeconds,
                experience_level: experienceLevel,
                avatar_url: selectedAvatar
            };

            // Onboarding check
            if (editingProfile && !editingProfile.onboarding_completed_at) {
                payload.onboarding_completed_at = new Date().toISOString();
            }

            console.log("PROFILE SAVE PAYLOAD", payload);

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update(payload)
                    .eq('id', currentUser.id);

                if (error) throw error;

                showToast('Profile updated!', 'success');
                hideProfileSettings();
                loadDashboard();
            } catch (err) {
                console.error('Error saving profile:', err);
                alert('Error saving profile: ' + err.message);
            }
        }

        // ===== ONBOARDING FUNCTIONS =====

        function showOnboardingLegal() {
            document.getElementById('onboardingLegal').style.display = 'block';
            document.getElementById('onboardingPersonal').style.display = 'none';
            setTimeout(() => initIcons(), 100);
        }

        function showOnboardingPersonal() {
            document.getElementById('onboardingLegal').style.display = 'none';
            document.getElementById('onboardingPersonal').style.display = 'block';
            setTimeout(() => initIcons(), 100);
        }

        function checkOnboardingBoxes() {
            const terms = document.getElementById('obTerms').checked;
            const privacy = document.getElementById('obPrivacy').checked;
            const waiver = document.getElementById('obWaiver').checked;
            const data = document.getElementById('obData').checked;

            const btn = document.getElementById('obAcceptBtn');
            const allChecked = terms && privacy && waiver && data;
            btn.disabled = !allChecked;
            btn.style.opacity = allChecked ? '1' : '0.5';
            btn.style.cursor = allChecked ? 'pointer' : 'not-allowed';
        }

        // Consent document content (embedded for file:// compatibility)
        const consentDocuments = {
            terms: {
                title: 'Terms of Service',
                content: `
<h4 style="color: #38bdf8; margin-bottom: 12px;">SwimLoading Terms of Service</h4>
<p><strong>Effective Date:</strong> January 2025</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">1. Acceptance of Terms</h4>
<p>By accessing or using SwimLoading ("the App"), you agree to be bound by these Terms of Service. If you do not agree, do not use the App.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">2. Description of Service</h4>
<p>SwimLoading is a community platform for open water swimmers to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Log and share water temperature readings</li>
<li>View swim conditions at various spots</li>
<li>Connect with the local swimming community</li>
<li>Track swimming activities</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">3. User Responsibilities</h4>
<p>You agree to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Provide accurate information when logging temperatures and conditions</li>
<li>Not misuse the service or attempt to harm other users</li>
<li>Respect the community and other swimmers</li>
<li>Keep your account credentials secure</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">4. Safety Disclaimer</h4>
<p>SwimLoading provides information for convenience only. <strong>You are solely responsible for assessing conditions and your own safety.</strong> Never rely solely on app data for safety decisions.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">5. Intellectual Property</h4>
<p>The App and its content are owned by SwimLoading. User-submitted data (temperatures, conditions) may be used to improve the service and shared with the community.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">6. Termination</h4>
<p>We may suspend or terminate accounts that violate these terms or for any reason at our discretion.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">7. Changes to Terms</h4>
<p>We may update these terms at any time. Continued use constitutes acceptance of changes.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">8. Governing Law</h4>
<p>These terms are governed by the laws of South Africa.</p>
`
            },
            privacy: {
                title: 'Privacy Policy (POPIA Compliant)',
                content: `
<h4 style="color: #38bdf8; margin-bottom: 12px;">SwimLoading Privacy Policy</h4>
<p><strong>Effective Date:</strong> January 2025</p>
<p>This policy complies with the Protection of Personal Information Act (POPIA) of South Africa.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">1. Information We Collect</h4>
<p><strong>Account Information:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>Email address</li>
<li>Full name</li>
<li>Phone number (for emergency contact)</li>
<li>Date of birth</li>
<li>Physical address</li>
</ul>

<p><strong>Usage Data:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>Temperature logs you submit</li>
<li>GPS coordinates (when you grant permission)</li>
<li>Swim check-ins and activities</li>
<li>App usage patterns</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">2. How We Use Your Information</h4>
<ul style="margin: 8px 0 8px 20px;">
<li>To provide and improve the SwimLoading service</li>
<li>To display community temperature data</li>
<li>For safety features (check-in/check-out, emergency contacts)</li>
<li>To communicate important updates</li>
<li>For anonymized research to improve ocean safety</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">3. Data Sharing</h4>
<p>We may share data with:</p>
<ul style="margin: 8px 0 8px 20px;">
<li><strong>Other users:</strong> Your temperature logs and swim spot data (not personal details)</li>
<li><strong>Emergency services:</strong> If you fail to check out from a swim</li>
<li><strong>Research partners:</strong> Anonymized data only, for ocean safety research</li>
</ul>
<p>We do <strong>not</strong> sell your personal information.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">4. Your POPIA Rights</h4>
<p>Under POPIA, you have the right to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Access your personal information</li>
<li>Correct inaccurate information</li>
<li>Request deletion of your data</li>
<li>Object to processing</li>
<li>Withdraw consent</li>
</ul>
<p>To exercise these rights, contact us at privacy@swimloading.com</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">5. Data Security</h4>
<p>We use industry-standard security measures to protect your data, including encryption in transit and at rest.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">6. Data Retention</h4>
<p>We retain your data for as long as your account is active. You may request deletion at any time.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">7. Information Officer</h4>
<p>SwimLoading's Information Officer can be contacted at: privacy@swimloading.com</p>
`
            },
            waiver: {
                title: 'Liability Waiver',
                content: `
<h4 style="color: #ef4444; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i> LIABILITY WAIVER AND ASSUMPTION OF RISK
                    </h4>
<p><strong>PLEASE READ CAREFULLY BEFORE ACCEPTING</strong></p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">ACKNOWLEDGMENT OF RISKS</h4>
<p>I understand and acknowledge that <strong>open water swimming is an inherently dangerous activity</strong> that involves serious risks including but not limited to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Drowning and death</li>
<li>Hypothermia and cold water shock</li>
<li>Cardiac events</li>
<li>Marine life encounters (sharks, jellyfish, etc.)</li>
<li>Strong currents, waves, and changing conditions</li>
<li>Boat traffic and watercraft collisions</li>
<li>Physical injury or permanent disability</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">VOLUNTARY PARTICIPATION</h4>
<p>I voluntarily choose to participate in open water swimming activities. I understand that SwimLoading is an information platform only and <strong>does not supervise, organize, or control any swimming activities</strong>.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">RELEASE OF LIABILITY</h4>
<p>In consideration of being allowed to use SwimLoading, I hereby:</p>
<ol style="margin: 8px 0 8px 20px;">
<li><strong>RELEASE AND DISCHARGE</strong> SwimLoading, its owners, operators, employees, and affiliates from any and all liability, claims, demands, or causes of action that may arise from my use of the app or participation in open water swimming.</li>
<li><strong>WAIVE</strong> any claims I may have against SwimLoading for injury, death, or property damage.</li>
<li><strong>ASSUME ALL RISKS</strong> associated with open water swimming, whether known or unknown.</li>
</ol>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">DATA ACCURACY DISCLAIMER</h4>
<p>I understand that:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Temperature and condition data is user-submitted and may be <strong>inaccurate</strong></li>
<li>Conditions can change rapidly and without warning</li>
<li>I must <strong>independently verify all conditions</strong> before swimming</li>
<li>SwimLoading makes <strong>no guarantees</strong> about data accuracy</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">INDEMNIFICATION</h4>
<p>I agree to indemnify and hold harmless SwimLoading from any claims, damages, or expenses arising from my swimming activities or use of the app.</p>

<h4 style="color: #ef4444; margin: 16px 0 8px 0; display: flex; align-items: center; gap: 8px;">
    <i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i> BY ACCEPTING, I CONFIRM THAT:
</h4>
<ul style="margin: 8px 0 8px 20px;">
<li>I have read and understood this waiver</li>
<li>I am at least 18 years old (or have parental consent)</li>
<li>I accept full responsibility for my safety</li>
<li>I am physically fit to participate in open water swimming</li>
</ul>
`
            },
            data: {
                title: 'Data Collection Consent',
                content: `
<h4 style="color: #38bdf8; margin-bottom: 12px;">Data Collection Consent</h4>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">Purpose of Data Collection</h4>
<p>SwimLoading collects data to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Build a community resource of ocean conditions</li>
<li>Improve safety for open water swimmers</li>
<li>Enable features like check-in/check-out safety systems</li>
<li>Support research into ocean swimming safety</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">What Data We Collect</h4>
<p><strong>Location Data:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>GPS coordinates when you log temperatures</li>
<li>Location during check-in/check-out</li>
<li>This helps verify spot accuracy and enables safety features</li>
</ul>

<p><strong>Activity Data:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>Temperature readings you submit</li>
<li>Conditions and hazards you report</li>
<li>Your swim activities and check-ins</li>
</ul>

<p><strong>Personal Data:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>Contact information for safety features</li>
<li>Emergency contact details</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">How We Use This Data</h4>
<ol style="margin: 8px 0 8px 20px;">
<li><strong>Community Features:</strong> Sharing temperature and condition data with other swimmers</li>
<li><strong>Safety:</strong> Alerting emergency contacts if you don't check out</li>
<li><strong>Improvement:</strong> Making the app better based on usage patterns</li>
<li><strong>Research:</strong> Anonymized data may be used for ocean safety research</li>
</ol>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">Your Control Over Your Data</h4>
<ul style="margin: 8px 0 8px 20px;">
<li>You can disable GPS permissions in your device settings</li>
<li>You can request a copy of your data at any time</li>
<li>You can request deletion of your account and data</li>
<li>Temperature logs may be retained anonymously for community benefit</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">Third-Party Sharing</h4>
<p>Your data may be shared with:</p>
<ul style="margin: 8px 0 8px 20px;">
<li><strong>Other users:</strong> Temperature logs (with optional anonymity)</li>
<li><strong>Emergency services:</strong> Only when safety features are triggered</li>
<li><strong>Insurance partners:</strong> Only with your explicit additional consent</li>
</ul>

<h4 style="color: #38bdf8; margin: 16px 0 8px 0;">By accepting, you consent to:</h4>
<ul style="margin: 8px 0 8px 20px;">
<li>Collection of the data described above</li>
<li>Use of this data for the stated purposes</li>
<li>Sharing as described in this policy</li>
</ul>
`
            }
        };

        function openConsentModal(docType) {
            const doc = consentDocuments[docType];
            if (!doc) return;

            document.getElementById('consentModalTitle').textContent = doc.title;
            document.getElementById('consentModalBody').innerHTML = doc.content;

            const modal = document.getElementById('consentModal');
            modal.style.display = 'flex';
        }

        function closeConsentModal() {
            document.getElementById('consentModal').style.display = 'none';
        }

        // ESC key to close modal
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeConsentModal();
            }
        });

        // Click outside modal to close
        document.getElementById('consentModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeConsentModal();
            }
        });

        async function acceptOnboardingLegal() {
            try {
                const now = new Date().toISOString();

                // Check if profile exists
                const { data: existing } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .update({
                            terms_accepted_at: now,
                            privacy_accepted_at: now,
                            waiver_accepted_at: now,
                            data_consent_at: now
                        })
                        .eq('id', currentUser.id);

                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .insert({
                            id: currentUser.id,
                            display_name: currentUser.email.split('@')[0],
                            terms_accepted_at: now,
                            privacy_accepted_at: now,
                            waiver_accepted_at: now,
                            data_consent_at: now
                        });

                    if (error) throw error;
                }

                showOnboardingPersonal();
            } catch (err) {
                console.error('Error accepting legal:', err);
                alert('Error: ' + err.message);
            }
        }

        async function saveOnboardingPersonal() {
            const fullName = document.getElementById('obFullName').value.trim();
            const phone = document.getElementById('obPhone').value.trim();
            const dob = document.getElementById('obDOB').value;
            const address = document.getElementById('obAddress').value.trim();
            const city = document.getElementById('obCity').value.trim();
            const postal = document.getElementById('obPostal').value.trim();

            if (!fullName || !phone || !dob || !address || !city || !postal) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        phone: phone,
                        date_of_birth: dob,
                        address_line1: address,
                        city: city,
                        postal_code: postal,
                        onboarding_completed_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Hide onboarding, show main app
                document.getElementById('onboardingLegal').style.display = 'none';
                document.getElementById('onboardingPersonal').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';

                await loadSpots();
                await loadDashboard();
                initIcons();
            } catch (err) {
                console.error('Error saving personal details:', err);
                alert('Error: ' + err.message);
            }
        }

        // ===== END ONBOARDING =====

        // GPS State
        let currentGpsLocation = null;

        // Get current GPS location
        async function getCurrentLocation() {
            const btn = document.getElementById('gpsButton');
            const status = document.getElementById('gpsStatus');

            if (!navigator.geolocation) {
                alert('GPS not supported on this device');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" style="width: 14px; height: 14px; animation: spin 1s linear infinite;"></i> Getting location...';
            status.textContent = 'Detecting...';
            status.style.color = 'var(--warning)';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    currentGpsLocation = { lat, lng };

                    // Find nearest spot
                    const nearest = findNearestSpot(lat, lng);

                    if (nearest) {
                        // Store suggested ID
                        gpsSuggestedSpotId = nearest.spot.id;

                        // Select the nearest spot in dropdown ONLY if not locked
                        if (!selectedSpotLocked) {
                            const select = document.querySelector('#logTemp select[data-spots]');
                            if (select) select.value = nearest.spot.id;
                        }

                        status.innerHTML = `📍 ${nearest.spot.name} (${nearest.distance.toFixed(1)}km away)`;
                        status.style.color = 'var(--success)';
                    } else {
                        status.textContent = `📍 ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                        status.style.color = 'var(--ocean-light)';
                    }

                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="map-pin" style="width: 14px; height: 14px;"></i> Update Location';
                    initIcons();
                },
                (error) => {
                    console.error('GPS error:', error);
                    status.textContent = 'Location access denied';
                    status.style.color = 'var(--danger)';
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="map-pin" style="width: 14px; height: 14px;"></i> Use My Location';
                    initIcons();

                    if (error.code === 1) {
                        alert('Please allow location access to use GPS');
                    }
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // Calculate distance between two points (Haversine formula)
        function getDistanceKm(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Find nearest spot to GPS coordinates
        function findNearestSpot(lat, lng) {
            if (!spots || spots.length === 0) return null;

            let nearest = null;
            let minDistance = Infinity;

            for (const spot of spots) {
                const distance = getDistanceKm(lat, lng, spot.latitude, spot.longitude);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = { spot, distance };
                }
            }

            // Only return if within 10km (reasonable for Cape Town spots)
            return minDistance <= 10 ? nearest : null;
        }

        // Submit temperature log
        async function submitTempLog() {
            const spotId = document.querySelector('#logTemp select[data-spots]').value;
            const temp = parseFloat(document.getElementById('tempValue').textContent);
            const conditionsRaw = document.querySelector('#logTemp .toggle-btn.active')?.textContent.trim() || 'Calm';

            // Remove emojis and extract just the word (calm, choppy, rough, extreme)
            const conditions = conditionsRaw.replace(/[^\w\s]/g, '').trim().toLowerCase();

            // Get selected hazards and remove emojis
            const hazards = Array.from(document.querySelectorAll('#logTemp .toggle-group:last-of-type .toggle-btn.active'))
                .map(btn => btn.textContent.replace(/[^\w\s]/g, '').trim().toLowerCase());

            const notes = document.querySelector('#logTemp textarea').value;

            // Determine location source
            let locationSource = 'fallback';
            if (selectedSpotLocked) {
                locationSource = 'manual';
            } else if (currentGpsLocation) {
                locationSource = 'gps';
            }

            // Build insert object
            const logData = {
                user_id: currentUser.id,
                spot_id: spotId,
                temp_c: temp,
                conditions: conditions,
                hazards: hazards,
                notes: notes,
                location_source: locationSource,
                gps_spot_id: gpsSuggestedSpotId
            };

            // Add GPS coordinates if available (for future custom spots feature)
            // Note: Could store in notes or a separate field later
            if (currentGpsLocation) {
                logData.lat = currentGpsLocation.lat;
                logData.lng = currentGpsLocation.lng;
                logData.notes = (notes ? notes + '\n' : '') +
                    `[GPS: ${currentGpsLocation.lat.toFixed(5)}, ${currentGpsLocation.lng.toFixed(5)}]`;
            }

            const { data, error } = await supabaseClient
                .from('temp_logs')
                .insert(logData);

            if (error) {
                alert('Error logging temperature: ' + error.message);
                console.error(error);
            } else {
                showToast('Temperature logged successfully! +10 points!', 'success');

                // Reset GPS and Lock state
                selectedSpotLocked = false;
                gpsSuggestedSpotId = null;
                currentGpsLocation = null;
                const status = document.getElementById('gpsStatus');
                if (status) status.textContent = '';

                // Switch to dashboard
                showPage('dashboard');
                await loadDashboard();
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', checkAuth);
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --ocean-blue: #0284c7;
            --ocean-dark: #0c4a6e;
            --ocean-light: #38bdf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --elite-red: #dc2626;
            --bg-dark: #0a1628;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: rgba(56, 189, 248, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(circle at 20% 80%, rgba(2, 132, 199, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(56, 189, 248, 0.08) 0%, transparent 50%);
            animation: pulse 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.3;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.5;
            }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            padding: 20px;
        }

        /* Auth Screen */
        #authScreen {
            display: none;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-card {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-logo h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .auth-logo p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: rgba(15, 23, 42, 0.6);
            padding: 4px;
            border-radius: 12px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--ocean-blue);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(56, 189, 248, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s;
            outline: none;
        }

        input:focus {
            border-color: var(--ocean-light);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--ocean-blue) 0%, var(--ocean-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(2, 132, 199, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        #mainApp {
            display: none;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--ocean-blue) 0%, var(--ocean-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid var(--ocean-light);
            position: relative;
            z-index: 200;
            pointer-events: auto;
            /* Ensure it is above any headers or overlays */
        }

        .nav-tabs {
            display: inline-flex;
            /* Fix desktop overflow: grow with content */
            flex-wrap: nowrap;
            /* Prevent wrapping on desktop */
            overflow-x: auto;
            /* Allow scroll if it doesn't fit */
            max-width: 100%;
            /* Ensure it doesn't overflow parent */
            min-width: 100%;
            /* Ensure it takes full width if content is small (pill style) */
            box-sizing: border-box;
            gap: 8px;
            /* margin-bottom handled by wrapper */
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            padding: 6px;
            border-radius: 16px;
            border: 1px solid var(--border);
            /* Position sticky handled by wrapper */
        }

        /* Wrapper for sticky positioning and positioning context for fade */
        .nav-wrapper {
            position: sticky;
            top: 20px;
            z-index: 100;
            margin-bottom: 24px;
            position: relative;
            /* For absolute fade positioning */
        }

        .nav-fade {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 40px;
            background: linear-gradient(to right, transparent, rgba(15, 23, 42, 0.9));
            pointer-events: none;
            border-top-right-radius: 16px;
            border-bottom-right-radius: 16px;
            transition: opacity 0.3s ease;
            display: none;
            /* Hidden by default on desktop */
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }


        .nav-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            white-space: nowrap;
            /* Prevent wrapping on desktop too */
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--ocean-blue) 0%, var(--ocean-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
        }

        /* Mobile nav: single row, swipeable, never wraps */
        @media (max-width: 520px) {
            .nav-wrapper {
                overflow: hidden;
                /* Clip anything outside */
                border-radius: 16px;
                /* Match nav radius */
            }

            .nav-tabs {
                display: flex;
                width: 100%;
                /* Reset inline-flex for mobile */
                flex-wrap: nowrap !important;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 2px;
                padding-right: 12px;
                /* prevents margin issues */
                margin-bottom: 0;
                /* Wrapper handles margin */
                border: none;
                background: rgba(30, 41, 59, 0.6);
                backdrop-filter: blur(20px);
                border: 1px solid var(--border);
            }

            .nav-fade {
                display: block;
                /* Show on mobile */
            }

            .nav-tabs::-webkit-scrollbar {
                display: none;
            }

            .nav-tab {
                flex: 0 0 auto !important;
                white-space: nowrap;
                padding: 8px 4px;
                font-size: 12px;
            }
        }


        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-blue) 100%);
            border-radius: 2px;
        }

        .slider-value {
            text-align: center;
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, var(--ocean-blue) 0%, var(--ocean-light) 100%);
            border-radius: 3px;
            outline: none;
            border: none;
            padding: 0;
            -webkit-appearance: none;
        }

        #logTemp input[type="range"]#tempSlider {
            background: linear-gradient(to right, #3b82f6 0%, #38bdf8 30%, #10b981 50%, #fbbf24 70%, #ef4444 100%);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border: 3px solid var(--ocean-blue);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .toggle-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        select {
            appearance: none;
            background: rgba(15, 23, 42, 0.8) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 16px center;
            background-size: 18px;
            border: 2px solid rgba(56, 189, 248, 0.15);
            border-radius: 12px;
            color: white;
            padding: 14px 18px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            font-weight: 500;
        }

        select:hover {
            border-color: rgba(56, 189, 248, 0.4);
            background-color: rgba(15, 23, 42, 0.9);
        }

        select:focus {
            outline: none;
            border-color: var(--ocean-light);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
        }

        .toggle-btn {
            padding: 14px 20px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(56, 189, 248, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .toggle-btn:hover {
            background: rgba(56, 189, 248, 0.15);
            border-color: rgba(56, 189, 248, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.5) 0%, rgba(6, 182, 212, 0.5) 100%);
            border-color: var(--ocean-light);
            color: white;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(56, 189, 248, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
            outline: none;
        }

        textarea:focus {
            border-color: var(--ocean-light);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
        }

        select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(56, 189, 248, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 44px;
        }

        select:focus {
            border-color: var(--ocean-light);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .info-box {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-box strong {
            color: var(--ocean-light);
            display: block;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <!-- AUTH SCREEN -->
    <div id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">
                <h1><i data-lucide="waves" style="width: 32px; height: 32px; vertical-align: middle;"></i> SwimLoading
                </h1>
                <p>Cape Town Ocean Swimming Community</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('signup')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="btn" onclick="signIn()">Login</button>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="auth-form">
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="signupName" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" placeholder="Create password (min 6 chars)">
                </div>
                <button class="btn" onclick="signUp()">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- ONBOARDING SCREENS -->
    <div id="onboardingLegal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); overflow-y: auto; z-index: 9999;">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="max-width: 600px; width: 100%;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="font-size: 48px; margin-bottom: 16px;"><i data-lucide="waves"
                            style="width: 48px; height: 48px; color: #38bdf8; stroke-width: 2;"></i></div>
                    <h2
                        style="font-size: 28px; color: #f8fafc; margin: 0 0 8px 0; font-family: system-ui, -apple-system, sans-serif;">
                        Before You Dive In...</h2>
                    <p style="color: #94a3b8; margin: 0; font-family: system-ui, -apple-system, sans-serif;">Please
                        review and accept the following</p>
                </div>

                <div
                    style="background: rgba(15, 23, 42, 0.8); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">

                    <div style="display: flex; gap: 12px; padding: 16px; border-radius: 8px; transition: background 0.2s; margin-bottom: 12px;"
                        onmouseover="this.style.background='rgba(56,189,248,0.1)'"
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" id="obTerms" onchange="checkOnboardingBoxes()"
                            style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div
                                style="color: #f8fafc; font-weight: 600; margin-bottom: 4px; font-family: system-ui, -apple-system, sans-serif;">
                                <label for="obTerms" style="cursor: pointer;"><i data-lucide="scroll-text"
                                        style="width: 16px; height: 16px; vertical-align: middle; stroke-width: 2;"></i>
                                    Terms of Service</label>
                                <a href="#" onclick="openConsentModal('terms'); return false;"
                                    style="margin-left: 8px; font-size: 12px; color: #38bdf8; text-decoration: none;">View</a>
                            </div>
                            <label for="obTerms" style="cursor: pointer;">
                                <div
                                    style="color: #94a3b8; font-size: 13px; font-family: system-ui, -apple-system, sans-serif;">
                                    I understand the rules and responsibilities</div>
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; padding: 16px; border-radius: 8px; transition: background 0.2s; margin-bottom: 12px;"
                        onmouseover="this.style.background='rgba(56,189,248,0.1)'"
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" id="obPrivacy" onchange="checkOnboardingBoxes()"
                            style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div
                                style="color: #f8fafc; font-weight: 600; margin-bottom: 4px; font-family: system-ui, -apple-system, sans-serif;">
                                <label for="obPrivacy" style="cursor: pointer;"><i data-lucide="shield-check"
                                        style="width: 16px; height: 16px; vertical-align: middle; stroke-width: 2;"></i>
                                    Privacy Policy (POPIA)</label>
                                <a href="#" onclick="openConsentModal('privacy'); return false;"
                                    style="margin-left: 8px; font-size: 12px; color: #38bdf8; text-decoration: none;">View</a>
                            </div>
                            <label for="obPrivacy" style="cursor: pointer;">
                                <div
                                    style="color: #94a3b8; font-size: 13px; font-family: system-ui, -apple-system, sans-serif;">
                                    I understand how my data is used</div>
                            </label>
                        </div>
                    </div>

                    <div
                        style="display: flex; gap: 12px; padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 2px solid rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05);">
                        <input type="checkbox" id="obWaiver" onchange="checkOnboardingBoxes()"
                            style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div
                                style="color: #ef4444; font-weight: 600; margin-bottom: 8px; font-family: system-ui, -apple-system, sans-serif;">
                                <label for="obWaiver" style="cursor: pointer;"><i data-lucide="alert-triangle"
                                        style="width: 16px; height: 16px; vertical-align: middle; stroke-width: 2;"></i>
                                    Liability Waiver</label>
                                <a href="#" onclick="openConsentModal('waiver'); return false;"
                                    style="margin-left: 8px; font-size: 12px; color: #38bdf8; text-decoration: none;">View</a>
                            </div>
                            <label for="obWaiver" style="cursor: pointer;">
                                <div
                                    style="color: #cbd5e1; font-size: 12px; font-family: system-ui, -apple-system, sans-serif;">
                                    Ocean swimming is dangerous. I may be seriously injured or killed. SwimLoading
                                    assumes ZERO liability.</div>
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; padding: 16px; border-radius: 8px; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(56,189,248,0.1)'"
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" id="obData" onchange="checkOnboardingBoxes()"
                            style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div
                                style="color: #f8fafc; font-weight: 600; margin-bottom: 4px; font-family: system-ui, -apple-system, sans-serif;">
                                <label for="obData" style="cursor: pointer;"><i data-lucide="database"
                                        style="width: 16px; height: 16px; vertical-align: middle; stroke-width: 2;"></i>
                                    Data Consent</label>
                                <a href="#" onclick="openConsentModal('data'); return false;"
                                    style="margin-left: 8px; font-size: 12px; color: #38bdf8; text-decoration: none;">View</a>
                            </div>
                            <label for="obData" style="cursor: pointer;">
                                <div
                                    style="color: #94a3b8; font-size: 13px; font-family: system-ui, -apple-system, sans-serif;">
                                    I consent to data collection for safety</div>
                            </label>
                        </div>
                    </div>

                </div>

                <button id="obAcceptBtn" onclick="acceptOnboardingLegal()" disabled
                    style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; background: #38bdf8; color: white; border: none; border-radius: 8px; cursor: not-allowed; opacity: 0.5; font-family: system-ui, -apple-system, sans-serif;">Accept
                    All & Continue</button>

                <div style="text-align: center; margin-top: 16px;">
                    <button onclick="signOut()"
                        style="background: transparent; border: 1px solid #64748b; color: #94a3b8; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: system-ui, -apple-system, sans-serif;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Consent Document Modal -->
    <div id="consentModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: #1e293b; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1);">
            <div
                style="padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="consentModalTitle"
                    style="margin: 0; color: #f8fafc; font-family: system-ui, -apple-system, sans-serif;"></h3>
                <button onclick="closeConsentModal()"
                    style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>
            <div id="consentModalBody"
                style="padding: 24px; overflow-y: auto; flex: 1; color: #cbd5e1; font-size: 14px; line-height: 1.6; font-family: system-ui, -apple-system, sans-serif;">
            </div>
            <div style="padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button onclick="closeConsentModal()"
                    style="width: 100%; padding: 12px; background: #38bdf8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: system-ui, -apple-system, sans-serif;">Close</button>
            </div>
        </div>
    </div>

    <div id="onboardingPersonal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); overflow-y: auto; z-index: 9999;">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="max-width: 600px; width: 100%;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="font-size: 48px; margin-bottom: 16px;"><i data-lucide="user"
                            style="width: 48px; height: 48px; color: #38bdf8; stroke-width: 2;"></i></div>
                    <h2
                        style="font-size: 28px; color: #f8fafc; margin: 0 0 8px 0; font-family: system-ui, -apple-system, sans-serif;">
                        Let's Get to Know You</h2>
                    <p style="color: #94a3b8; margin: 0; font-family: system-ui, -apple-system, sans-serif;">We need
                        this for safety and emergency purposes</p>
                </div>

                <div
                    style="background: rgba(15, 23, 42, 0.8); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">

                    <div style="margin-bottom: 16px;">
                        <label
                            style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;"><i
                                data-lucide="user"
                                style="width: 14px; height: 14px; vertical-align: middle; stroke-width: 2;"></i> Full
                            Name *</label>
                        <input type="text" id="obFullName" placeholder="John Smith"
                            style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label
                            style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;"><i
                                data-lucide="phone"
                                style="width: 14px; height: 14px; vertical-align: middle; stroke-width: 2;"></i> Phone
                            *</label>
                        <input type="tel" id="obPhone" placeholder="+27 82 123 4567"
                            style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label
                            style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;"><i
                                data-lucide="calendar"
                                style="width: 14px; height: 14px; vertical-align: middle; stroke-width: 2;"></i> Date of
                            Birth *</label>
                        <input type="date" id="obDOB"
                            style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label
                            style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;"><i
                                data-lucide="map-pin"
                                style="width: 14px; height: 14px; vertical-align: middle; stroke-width: 2;"></i> Address
                            *</label>
                        <input type="text" id="obAddress" placeholder="123 Beach Road"
                            style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label
                                style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;">City
                                *</label>
                            <input type="text" id="obCity" placeholder="Cape Town" value="Cape Town"
                                style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                        </div>
                        <div>
                            <label
                                style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;">Postal
                                *</label>
                            <input type="text" id="obPostal" placeholder="8001"
                                style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                        </div>
                    </div>

                </div>

                <button onclick="saveOnboardingPersonal()"
                    style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; background: #38bdf8; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: system-ui, -apple-system, sans-serif;">Continue
                    to Dashboard</button>

                <div
                    style="text-align: center; margin-top: 16px; color: #64748b; font-size: 12px; font-family: system-ui, -apple-system, sans-serif;">
                    * Required fields
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <div class="container">
            <div class="header">
                <div class="header-top">
                    <div class="logo"><i data-lucide="waves"
                            style="width: 24px; height: 24px; vertical-align: middle;"></i> SwimLoading</div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button class="btn"
                            style="padding: 8px 16px; font-size: 13px; background: transparent; border: 1px solid var(--danger); color: var(--danger);"
                            onclick="signOut()">Logout</button>
                        <div class="user-avatar" onclick="console.log('AVATAR_CLICK'); showProfileSettings()"
                            title="Profile Settings"><i data-lucide="user" style="width: 18px; height: 18px;"></i></div>
                    </div>
                </div>
            </div>

            <div class="nav-wrapper">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showPage('dashboard')">Home</button>
                    <button class="nav-tab" onclick="showPage('logTemp')">Temps</button>
                    <button class="nav-tab" onclick="showPage('events')">Swims</button>
                    <button class="nav-tab" onclick="showPage('history')">Trends</button>
                    <button class="nav-tab" onclick="showPage('safety')">Safety</button>
                    <button class="nav-tab" onclick="showPage('leaderboard')">Leaderboard</button>
                </div>
                <div class="nav-fade"></div>
            </div>



            <!-- DASHBOARD -->
            <div id="dashboard" class="page active">
                <div class="card">
                    <div class="card-title">Dashboard</div>

                    <!-- Your Upcoming Swims -->
                    <div style="margin-bottom: 24px;">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
                            <i data-lucide="calendar-check"
                                style="width: 18px; height: 18px; vertical-align: middle;"></i> Your Upcoming Swims
                        </div>
                        <div id="dashUpcomingSwims">Loading...</div>
                    </div>

                    <!-- Your Stats -->
                    <div
                        style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
                            <i data-lucide="bar-chart-3" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                            Your Stats
                        </div>
                        <div id="dashStats">Loading...</div>
                    </div>

                    <!-- Recent Conditions -->
                    <div style="margin-bottom: 24px;">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
                            <i data-lucide="thermometer" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                            Latest Water Temps
                        </div>
                        <div id="dashConditions">Loading...</div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <button class="btn btn-success" onclick="showPage('logTemp')">Log Temperature</button>
                    </div>
                </div>
            </div>

            <!-- LOG TEMP -->
            <div id="logTemp" class="page">
                <div class="card">
                    <div class="card-title">Log Temperature</div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="map-pin"
                                style="width: 14px; height: 14px; vertical-align: middle;"></i> Location</div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <select data-spots style="flex: 1;">
                                <option>Loading spots...</option>
                            </select>
                            <button type="button" id="gpsButton" class="btn"
                                style="width: auto; padding: 12px 16px; font-size: 13px;"
                                onclick="getCurrentLocation()">
                                <i data-lucide="navigation" style="width: 14px; height: 14px;"></i> GPS
                            </button>
                        </div>
                        <div id="gpsStatus" style="font-size: 12px; color: var(--text-secondary); min-height: 18px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="thermometer"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i> Water
                            Temperature</div>
                        <div class="slider-value" id="tempValue">14°C</div>
                        <input type="range" id="tempSlider" min="8" max="25" value="14" step="0.5"
                            oninput="document.getElementById('tempValue').textContent = this.value + '°C'">
                        <div class="slider-labels">
                            <span>8°C</span>
                            <span>25°C</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="waves"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                            Conditions</div>
                        <div class="toggle-group">
                            <div class="toggle-btn active" onclick="toggleSingle(this)"><i data-lucide="sun"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Calm</div>
                            <div class="toggle-btn" onclick="toggleSingle(this)"><i data-lucide="waves"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Choppy</div>
                            <div class="toggle-btn" onclick="toggleSingle(this)"><i data-lucide="wind"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Rough</div>
                            <div class="toggle-btn" onclick="toggleSingle(this)"><i data-lucide="cloud-lightning"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Extreme</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="shield-alert"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                            Hazards (Optional)</div>
                        <div class="toggle-group">
                            <div class="toggle-btn" onclick="this.classList.toggle('active')"><i data-lucide="droplet"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Jellyfish</div>
                            <div class="toggle-btn" onclick="this.classList.toggle('active')"><i
                                    data-lucide="circle-dot"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Seals</div>
                            <div class="toggle-btn" onclick="this.classList.toggle('active')"><i
                                    data-lucide="alert-triangle"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Shark</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="file-text"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i> Notes
                        </div>
                        <textarea placeholder="Visibility, currents, etc..."></textarea>
                    </div>

                    <button class="btn btn-success" onclick="submitTempLog()">Submit Temperature Log</button>

                    <div class="info-box">
                        <i data-lucide="database"
                            style="width: 16px; height: 16px; vertical-align: middle; color: var(--ocean-light); margin-right: 4px;"></i>
                        <strong>Live Database!</strong>
                        This will save to YOUR Supabase database in real-time!
                    </div>
                </div>
            </div>

            <!-- HISTORY & TRENDS -->
            <div id="history" class="page">
                <div class="card">
                    <div class="card-title">Temperature Trends</div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="map-pin"
                                style="width: 14px; height: 14px; vertical-align: middle;"></i> Filter by Location</div>
                        <select id="historySpotFilter" onchange="loadHistory()">
                            <option value="">All Locations</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="users"
                                style="width: 14px; height: 14px; vertical-align: middle;"></i> Show</div>
                        <div class="toggle-group">
                            <div class="toggle-btn active" onclick="toggleHistoryView(this, 'my')">My Logs</div>
                            <div class="toggle-btn" onclick="toggleHistoryView(this, 'community')">Community</div>
                        </div>
                    </div>

                    <!-- Temperature Trend Chart -->
                    <div id="trendChart" style="margin: 20px 0;">
                        <canvas id="tempChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- Recent Logs List -->
                    <div id="historyList" style="margin-top: 20px;">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            Loading history...
                        </div>
                    </div>
                </div>
            </div>

            <!-- SWIM EVENTS -->
            <div id="events" class="page">
                <div class="card">
                    <div class="card-title">Group Swims</div>

                    <!-- Create Event Button -->
                    <button class="btn btn-success" onclick="showCreateEvent()" style="margin-bottom: 20px;">
                        <i data-lucide="plus" style="width: 16px; height: 16px; vertical-align: middle;"></i> Create
                        New Swim
                    </button>

                    <!-- Event Filters -->
                    <div class="form-group">
                        <div class="form-label"><i data-lucide="map-pin"
                                style="width: 14px; height: 14px; vertical-align: middle;"></i> Location</div>
                        <select id="eventSpotFilter" onchange="loadEvents()">
                            <option value="">All Locations</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-label">Pace Level</div>
                        <select id="eventPaceFilter" onchange="loadEvents()">
                            <option value="">All Levels</option>
                            <option value="100">Fast (1:40/100m)
                            </option>
                            <option value="120">Steady (2:00/100m)
                            </option>
                            <option value="150">Social (2:30/100m)
                            </option>
                            <option value="180">Developing
                                (3:00/100m)</option>
                        </select>
                    </div>

                    <!-- Events List -->
                    <div id="eventsList" style="margin-top: 20px;">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            Loading events...
                        </div>
                    </div>
                </div>

                <!-- Create Event Modal -->
                <div id="createEventModal"
                    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; overflow-y: auto;">
                    <div
                        style="max-width: 500px; margin: 40px auto; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 20px; padding: 30px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--text-primary); font-size: 20px;">Create New Swim</h3>
                            <button onclick="hideCreateEvent()"
                                style="background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: auto;">✕</button>
                        </div>

                        <!-- Safety Disclaimer -->
                        <div
                            style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <div
                                style="font-weight: 600; color: var(--danger); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i> Important Safety
                                Note
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                Open water swimming is inherently dangerous. By creating or joining a swim, you
                                acknowledge that:
                                <ul style="margin: 8px 0 0 20px; padding: 0;">
                                    <li>You are responsible for your own safety</li>
                                    <li>Other swimmers are NOT responsible for you</li>
                                    <li>You must assess your own ability and conditions</li>
                                    <li>Swimming in cold water carries serious risks</li>
                                </ul>
                            </div>
                        </div>

                        <form id="createEventForm" onsubmit="submitEvent(event)">
                            <div class="form-group">
                                <div class="form-label">Swim Name</div>
                                <input type="text" id="eventName" placeholder="e.g., Morning Clifton Lap" required>
                            </div>

                            <div class="form-group">
                                <div class="form-label"><i data-lucide="map-pin"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Location</div>
                                <select id="eventSpot" data-spots required></select>
                            </div>

                            <div class="form-group">
                                <div class="form-label">Route Type</div>
                                <select id="eventRouteType">
                                    <option value="Out & Back">Out & Back</option>
                                    <option value="Point-to-Point (lifts needed)">Point-to-Point (lifts needed)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div class="form-label"><i data-lucide="calendar"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Date & Time
                                </div>
                                <input type="datetime-local" id="eventDateTime" required>
                            </div>

                            <div class="form-group">
                                <div class="form-label">Pace Category</div>
                                <select id="eventPaceLevel" required>
                                    <option value="100">Fast (1:40/100m)</option>
                                    <option value="120">Steady (2:00/100m)</option>
                                    <option value="150" selected>Social (2:30/100m)</option>
                                    <option value="180">Developing (3:00/100m)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div class="form-label"><i data-lucide="ruler"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Distance (km)
                                </div>
                                <input type="number" id="eventDistance" step="0.1" placeholder="e.g., 2.5" required>
                            </div>

                            <div class="form-group">
                                <div class="form-label"><i data-lucide="users"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Max Participants
                                </div>
                                <input type="number" id="eventMaxParticipants" placeholder="Leave empty for unlimited"
                                    min="2">
                            </div>

                            <div class="form-group">
                                <div class="form-label">Description / Route</div>
                                <textarea id="eventDescription"
                                    placeholder="Describe the route, meeting point, any special notes..."
                                    rows="4"></textarea>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="eventRequireApproval" style="width: auto; margin: 0;">
                                    <span style="font-size: 13px; color: var(--text-secondary);">
                                        Require approval for swimmers below pace level
                                    </span>
                                </label>
                            </div>

                            <button type="submit" class="btn btn-success" style="margin-top: 10px;">Create
                                Swim</button>
                        </form>
                    </div>
                </div>

                <!-- Event Details Modal -->
                <div id="eventDetailsModal"
                    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; padding: 20px; overflow-y: auto;">
                    <div
                        style="max-width: 600px; margin: 40px auto; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 20px; padding: 30px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--text-primary); font-size: 20px;">Swim Details</h3>
                            <button onclick="hideEventDetails()"
                                style="background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: auto;">✕</button>
                        </div>

                        <div id="eventDetailsContent"></div>
                    </div>
                </div>

                <!-- Profile Settings Modal -->
                <div id="profileModal"
                    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1002; padding: 20px; overflow-y: auto;">
                    <div
                        style="max-width: 500px; margin: 40px auto; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 20px; padding: 30px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--text-primary); font-size: 20px;">Profile Settings</h3>
                            <button onclick="hideProfileSettings()"
                                style="background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: auto;">✕</button>
                        </div>

                        <div style="text-align: center; margin-bottom: 24px;">
                            <div class="form-label" style="text-align:center; margin-bottom:8px;">Choose Avatar</div>
                            <div id="avatarGrid"
                                style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 20px;">
                                <!-- Populated by JS -->
                            </div>
                            <div style="color: var(--text-primary); font-weight: 600;" id="profileEmail"></div>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Display Name</div>
                            <input type="text" id="profileDisplayName" placeholder="Your name">
                        </div>

                        <div class="form-group">
                            <div class="form-label">Preferred Suit</div>
                            <select id="profilePreferredSuit">
                                <option value="skins">Skins (No Wetsuit)</option>
                                <option value="wetsuit">Wetsuit</option>
                                <option value="both">Both</option>
                            </select>
                        </div>



                        <div class="form-group">
                            <div class="form-label">🏖️ Home Beach</div>
                            <select id="profileHomeBeach" data-spots></select>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Pool 1km Time (optional)</div>
                            <input type="text" id="profilePoolTime" placeholder="e.g., 18:30 (mm:ss)">
                            <small style="color: var(--text-secondary); font-size: 11px;">Helps match you with
                                appropriate pace groups</small>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Ocean 1km Time (optional)</div>
                            <input type="text" id="profileOceanTime" placeholder="e.g., 21:00 (mm:ss)">
                        </div>

                        <div class="form-group">
                            <div class="form-label">❄️ Cold Tolerance (°C)</div>
                            <input type="number" id="profileColdTolerance" placeholder="e.g., 12" step="0.5">
                            <small style="color: var(--text-secondary); font-size: 11px;">Minimum water temp you're
                                comfortable swimming in</small>
                        </div>

                        <button class="btn btn-success" onclick="saveProfile()" style="margin-bottom: 12px;">Save
                            Profile</button>

                        <button class="btn"
                            style="background: transparent; border: 2px solid var(--danger); color: var(--danger);"
                            onclick="signOut()">Sign Out</button>
                    </div>
                </div>
            </div>

            <!-- SAFETY -->
            <div id="safety" class="page">
                <div class="card">
                    <div class="card-title"><i data-lucide="shield-alert"
                            style="width: 24px; height: 24px; vertical-align: middle;"></i> Safety</div>

                    <!-- Marine Life -->
                    <div
                        style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div
                            style="font-weight: 700; color: var(--text-primary); margin-bottom: 16px; font-size: 18px;">
                            Marine Life</div>
                        <div style="color: var(--text-secondary); line-height: 1.7; font-size: 14px;">
                            <ul style="margin: 0 0 0 20px; padding: 0;">
                                <li style="margin-bottom: 8px;"><strong
                                        style="color: var(--text-primary);">Sharks</strong> – Avoid dawn/dusk, murky
                                    water, and swimming near seals</li>
                                <li style="margin-bottom: 8px;"><strong
                                        style="color: var(--text-primary);">Seals</strong> – Curious but can bite if
                                    cornered; give them space</li>
                                <li style="margin-bottom: 8px;"><strong style="color: var(--text-primary);">Rabid
                                        seals</strong> – Rare but occurs; avoid any seal acting aggressively or
                                    unusually</li>
                                <li style="margin-bottom: 8px;"><strong style="color: var(--text-primary);">Jellyfish &
                                        Bluebottles</strong> – Check conditions; exit if you see large numbers</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Emergency Numbers -->
                    <div
                        style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="font-weight: 700; color: var(--danger); margin-bottom: 16px; font-size: 18px;">🚨
                            Emergency</div>
                        <div style="display: grid; gap: 12px;">
                            <a href="tel:0870949774"
                                style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 12px 16px; border-radius: 8px; text-decoration: none;">
                                <span style="color: var(--text-primary); font-weight: 600;">🚤 NSRI (Sea Rescue)</span>
                                <span style="color: #38bdf8; font-weight: 700;">087 094 9774</span>
                            </a>
                            <a href="tel:10111"
                                style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 12px 16px; border-radius: 8px; text-decoration: none;">
                                <span style="color: var(--text-primary); font-weight: 600;">👮 Police</span>
                                <span style="color: #38bdf8; font-weight: 700;">10111</span>
                            </a>
                            <a href="tel:10177"
                                style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 12px 16px; border-radius: 8px; text-decoration: none;">
                                <span style="color: var(--text-primary); font-weight: 600;">🚑 Ambulance</span>
                                <span style="color: #38bdf8; font-weight: 700;">10177</span>
                            </a>
                        </div>
                    </div>

                    <!-- Share Location Note -->
                    <div
                        style="background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.3); border-radius: 12px; padding: 16px;">
                        <div style="color: var(--text-secondary); font-size: 13px; line-height: 1.6;">
                            <strong style="color: var(--ocean-light);">💡 Tip:</strong> Share your live location with a
                            buddy via WhatsApp before you swim.
                        </div>
                    </div>
                </div>
            </div>

            <!-- LEADERBOARD -->
            <div id="leaderboard" class="page">
                <div class="card">
                    <div class="card-title"><i data-lucide="trophy"
                            style="width: 24px; height: 24px; vertical-align: middle;"></i> Leaderboard</div>

                    <!-- Top Swimmers -->
                    <div>
                        <div
                            style="font-weight: 700; color: var(--text-primary); margin-bottom: 16px; font-size: 18px;">
                            🏆 Top Swimmers</div>
                        <div id="leaderboardList"
                            style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px;">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(page).classList.add('active');
            event.target.classList.add('active');

            // Load data for specific pages
            if (page === 'dashboard') {
                loadDashboard();
            } else if (page === 'history') {
                loadHistory();
            } else if (page === 'events') {
                loadEvents();
            } else if (page === 'leaderboard') {
                loadLeaderboard();
            }

            // Initialize icons after page switch
            initIcons();
        }

        // Load leaderboard data
        async function loadLeaderboard() {
            const listEl = document.getElementById('leaderboardList');

            try {
                // Fetch top swimmers by points
                const { data, error } = await supabaseClient
                    .from('user_stats')
                    .select('user_id, points, profiles(display_name)')
                    .gt('points', 0)
                    .order('points', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('Leaderboard error:', error);
                    listEl.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 20px;">
                        ❌ Could not load leaderboard<br>
                        <small style="color: var(--text-secondary);">${error.message}</small>
                    </div>`;
                } else if (!data || data.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No swimmers on the leaderboard yet. Log a temperature to earn points!</div>';
                } else {
                    listEl.innerHTML = renderLeaderboardList(data, 'points');
                }

            } catch (err) {
                console.error('Leaderboard error:', err);
                listEl.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">Error loading leaderboard</div>';
            }
        }

        function renderLeaderboardList(data, pointsField) {
            const medals = ['🥇', '🥈', '🥉'];
            return data.map((row, i) => {
                const name = row.profiles?.display_name || 'Anonymous Swimmer';
                const points = row[pointsField] || 0;
                const medal = medals[i] || `${i + 1}.`;
                const isTop3 = i < 3;

                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; ${isTop3 ? 'background: rgba(56, 189, 248, 0.1);' : ''} border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: ${isTop3 ? '20px' : '14px'}; width: 30px; text-align: center;">${medal}</span>
                        <span style="color: var(--text-primary); font-weight: ${isTop3 ? '600' : '400'};">${name}</span>
                    </div>
                    <span style="color: var(--ocean-light); font-weight: 700;">${points.toLocaleString()} pts</span>
                </div>`;
            }).join('');
        }

        function toggleSingle(el) {
            el.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
    </script>
</body>

</html>