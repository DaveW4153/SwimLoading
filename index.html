<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwimLoading - Cape Town Ocean Swimming</title>
    <meta name="description" content="Log water temps, join group swims, track your streak. Cape Town's ocean swimming community.">
    <meta name="theme-color" content="#0284c7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SwimLoading">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js for temperature trends -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // ‚ö° CAPTURE the URL hash IMMEDIATELY before Supabase can consume it
        // Supabase's createClient() auto-detects #access_token=...&type=recovery
        // and processes + clears the hash before our code runs
        const INITIAL_HASH = window.location.hash;
        const IS_PASSWORD_RECOVERY = INITIAL_HASH && INITIAL_HASH.includes('type=recovery');
        const IS_AUTH_ERROR = INITIAL_HASH && INITIAL_HASH.includes('error=');
        const IS_EMAIL_VERIFY = INITIAL_HASH && INITIAL_HASH.includes('type=signup');

        if (IS_PASSWORD_RECOVERY || IS_AUTH_ERROR || IS_EMAIL_VERIFY) {
            console.log('üîë Auth hash detected BEFORE Supabase init:',
                IS_PASSWORD_RECOVERY ? 'RECOVERY' : IS_AUTH_ERROR ? 'ERROR' : 'SIGNUP');
        }

        // Initialize Supabase
        const SUPABASE_URL = 'https://szgkzuswelntnevobnoh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6Z2t6dXN3ZWxudG5ldm9ibm9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxODY1NTUsImV4cCI6MjA4Mzc2MjU1NX0.UfKqj2OZ-XeyzCy-MZYZqsDWjn_4EKrhgCFR8eIK2NA';

        let supabaseClient;

        // Initialize after library loads
        if (window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Global state
        let currentUser = null;
        let spots = [];

        // Global state for Spot Lock
        let selectedSpotLocked = false;
        let gpsSuggestedSpotId = null;

        // Icon helper function
        function icon(name, size = 16) {
            return `<i data-lucide="${name}" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"></i>`;
        }

        // Initialize Lucide icons after DOM updates
        function initIcons() {
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // Check authentication on load
        async function checkAuth() {
            // Use the hash we captured BEFORE Supabase could consume it
            // (Supabase's createClient auto-processes and clears auth hashes)

            // Handle password recovery
            if (IS_PASSWORD_RECOVERY) {
                console.log('‚úÖ Recovery detected ‚Äî waiting for Supabase to process token...');
                // Give Supabase a moment to exchange the token for a session
                // Then show the reset form
                await waitForSession(3000);
                showResetPasswordForm();
                return;
            }

            // Handle expired/invalid links
            if (IS_AUTH_ERROR) {
                const params = new URLSearchParams(INITIAL_HASH.substring(1));
                const errorDesc = params.get('error_description') || 'The link has expired or is invalid.';
                console.log('Auth error from URL:', errorDesc);
                window.location.hash = '';
                showAuth();
                setTimeout(() => {
                    showForgotPassword();
                    const msgEl = document.getElementById('forgotMessage');
                    msgEl.style.display = 'block';
                    msgEl.style.background = 'rgba(239, 68, 68, 0.1)';
                    msgEl.style.color = 'var(--danger)';
                    msgEl.innerHTML = '‚ö†Ô∏è ' + decodeURIComponent(errorDesc.replace(/\+/g, ' ')) + '<br><span style="font-size:12px; color: var(--text-secondary);">Please request a new reset link below.</span>';
                }, 200);
                return;
            }

            // Handle email verification (type=signup)
            if (IS_EMAIL_VERIFY) {
                console.log('Email verification token detected');
                // Let Supabase process the token, then load
                await waitForSession(3000);
                const { data: { session } } = await supabaseClient.auth.getSession();
                window.location.hash = '';
                if (session) {
                    currentUser = session.user;
                    loadApp();
                } else {
                    showAuth();
                }
                return;
            }

            // Normal auth check - no special tokens
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                loadApp();
            } else {
                showAuth();
            }
        }

        // Helper: wait for Supabase to finish processing the auth hash into a session
        function waitForSession(maxMs) {
            return new Promise((resolve) => {
                let elapsed = 0;
                const interval = setInterval(async () => {
                    elapsed += 200;
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session || elapsed >= maxMs) {
                        clearInterval(interval);
                        if (session) console.log('‚úÖ Session ready after', elapsed, 'ms');
                        else console.log('‚ö†Ô∏è No session after', maxMs, 'ms');
                        resolve(session);
                    }
                }, 200);
            });
        }

        // Show forgot password form
        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
            document.querySelector('.auth-tabs').style.display = 'none';
            initIcons();
        }

        // Hide forgot password form
        function hideForgotPassword() {
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.querySelector('.auth-tabs').style.display = 'flex';
            document.getElementById('forgotMessage').style.display = 'none';
        }

        // Send password reset email
        let resetCooldown = false;
        async function sendPasswordReset() {
            const email = document.getElementById('forgotEmail').value;
            if (!email) {
                alert('Please enter your email address');
                return;
            }

            if (resetCooldown) return;

            const msgEl = document.getElementById('forgotMessage');
            const btn = document.getElementById('resetSendBtn');
            msgEl.style.display = 'block';
            msgEl.style.background = 'rgba(56, 189, 248, 0.1)';
            msgEl.style.color = 'var(--ocean-light)';
            msgEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:8px;"><div class="spinner-small"></div> Sending reset link...</div>';
            btn.disabled = true;
            btn.style.opacity = '0.5';

            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/app'
            });

            if (error) {
                msgEl.style.background = 'rgba(239, 68, 68, 0.1)';
                msgEl.style.color = 'var(--danger)';
                msgEl.textContent = 'Error: ' + error.message;
                btn.disabled = false;
                btn.style.opacity = '1';
            } else {
                msgEl.style.background = 'rgba(16, 185, 129, 0.08)';
                msgEl.style.color = 'var(--success)';
                msgEl.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">‚úÖ Reset link sent!</div>
                    <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                        üì¨ Check your inbox for <strong style="color: var(--text-primary);">${email}</strong><br>
                        üìÅ Also check your <strong style="color: var(--text-primary);">Spam / Junk</strong> folder<br>
                        ‚è±Ô∏è Email can take 1-3 minutes to arrive
                    </div>
                `;

                // Start 60s cooldown with countdown
                resetCooldown = true;
                let seconds = 60;
                btn.textContent = `Resend in ${seconds}s`;
                const timer = setInterval(() => {
                    seconds--;
                    btn.textContent = `Resend in ${seconds}s`;
                    if (seconds <= 0) {
                        clearInterval(timer);
                        resetCooldown = false;
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.textContent = 'Resend Reset Link';
                    }
                }, 1000);
            }
        }

        // Show reset password form (after clicking email link)
        function showResetPasswordForm() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            // Hide all other auth forms
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.querySelector('.auth-tabs').style.display = 'none';
            // Show reset form
            document.getElementById('resetPasswordForm').style.display = 'block';
            initIcons();
        }

        // Update password
        async function updatePassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            const msgEl = document.getElementById('resetMessage');

            if (!newPass || !confirmPass) {
                alert('Please fill in both fields');
                return;
            }

            if (newPass !== confirmPass) {
                msgEl.style.display = 'block';
                msgEl.style.background = 'rgba(239, 68, 68, 0.1)';
                msgEl.style.color = 'var(--danger)';
                msgEl.textContent = 'Passwords do not match';
                return;
            }

            if (newPass.length < 6) {
                msgEl.style.display = 'block';
                msgEl.style.background = 'rgba(239, 68, 68, 0.1)';
                msgEl.style.color = 'var(--danger)';
                msgEl.textContent = 'Password must be at least 6 characters';
                return;
            }

            msgEl.style.display = 'block';
            msgEl.style.background = 'rgba(56, 189, 248, 0.1)';
            msgEl.style.color = 'var(--ocean-light)';
            msgEl.textContent = 'Updating password...';

            const { error } = await supabaseClient.auth.updateUser({
                password: newPass
            });

            if (error) {
                msgEl.style.background = 'rgba(239, 68, 68, 0.1)';
                msgEl.style.color = 'var(--danger)';
                msgEl.textContent = 'Error: ' + error.message;
            } else {
                msgEl.style.background = 'rgba(16, 185, 129, 0.1)';
                msgEl.style.color = 'var(--success)';
                msgEl.innerHTML = '‚úÖ Password updated! Redirecting...';

                // Clean up URL hash and redirect to app
                window.location.hash = '';
                setTimeout(() => {
                    document.getElementById('resetPasswordForm').style.display = 'none';
                    document.querySelector('.auth-tabs').style.display = 'flex';
                    const { data: { session } } = supabaseClient.auth.getSession().then(({ data: { session } }) => {
                        if (session) {
                            currentUser = session.user;
                            loadApp();
                        } else {
                            showAuth();
                            hideForgotPassword();
                        }
                    });
                }, 1500);
            }
        }

        // Show auth screen
        function showAuth() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Load main app
        async function loadApp() {
            // Check if user needs onboarding
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('terms_accepted_at, avatar_url, display_name')
                .eq('id', currentUser.id)
                .maybeSingle();

            // NEW USER - show onboarding
            if (!profile || !profile.terms_accepted_at) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'none';
                showOnboardingLegal();
                return;
            }

            // EXISTING USER - go to main app
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            // Load user avatar into header
            if (profile.avatar_url) {
                updateHeaderAvatar(profile.avatar_url);
            }

            // Set avatar color based on saved icon
            if (profile.avatar_url) {
                const avatarMeta = AVATARS.find(a => a.icon === profile.avatar_url);
                if (avatarMeta) {
                    const avatarDiv = document.querySelector('.user-avatar');
                    if (avatarDiv) {
                        avatarDiv.style.background = avatarMeta.color;
                        avatarDiv.style.borderColor = avatarMeta.color;
                    }
                }
            }

            // Load spots
            await loadSpots();

            // Load dashboard data
            await loadDashboard();

            // Initialize Lucide icons
            initIcons();

            // Initialize spot lock handler
            attachSpotLockHandler();

            // Initialize nav scroll handler
            initNavScroll();

            // Start Notification Polling
            startNotificationPolling();
        }

        // Sign up
        async function signUp() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const displayName = document.getElementById('signupName').value;
            const signupBtn = document.querySelector('#signupForm .btn');

            if (!email || !password || !displayName) {
                alert('Please fill in all fields');
                return;
            }

            if (password.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }

            // Show loading state
            signupBtn.disabled = true;
            signupBtn.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:8px;"><div class="spinner-small"></div> Creating account...</div>';

            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    data: { display_name: displayName },
                    emailRedirectTo: window.location.origin + '/app'
                }
            });

            if (error) {
                signupBtn.disabled = false;
                signupBtn.textContent = 'Sign Up';
                alert('Sign up failed: ' + error.message);
            } else {
                // Create profile
                try {
                    await supabaseClient.from('profiles').insert({
                        id: data.user.id,
                        display_name: displayName
                    });
                } catch (e) {
                    console.log('Profile insert note:', e);
                }

                // Check if auto-confirmed (session exists) or needs email verification
                if (data.session) {
                    // Auto-confirmed! Go straight to app
                    currentUser = data.user;
                    signupBtn.innerHTML = '‚úÖ Welcome aboard!';
                    setTimeout(() => {
                        signupBtn.disabled = false;
                        signupBtn.textContent = 'Sign Up';
                        loadApp();
                    }, 800);
                } else {
                    // Needs email verification - show helpful waiting screen
                    signupBtn.disabled = false;
                    signupBtn.textContent = 'Sign Up';
                    showSignupSuccess(email);
                }
            }
        }

        // Show a helpful email verification waiting screen
        function showSignupSuccess(email) {
            document.getElementById('signupForm').style.display = 'none';
            document.querySelector('.auth-tabs').style.display = 'none';

            let verifyEl = document.getElementById('signupVerifyScreen');
            if (!verifyEl) {
                verifyEl = document.createElement('div');
                verifyEl.id = 'signupVerifyScreen';
                document.querySelector('.auth-card').appendChild(verifyEl);
            }

            verifyEl.style.display = 'block';
            verifyEl.innerHTML = `
                <div style="text-align: center; padding: 10px 0;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì¨</div>
                    <h3 style="color: var(--text-primary); font-size: 20px; margin-bottom: 8px;">Check your email</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; line-height: 1.5;">
                        We sent a verification link to<br>
                        <strong style="color: var(--ocean-light);">${email}</strong>
                    </p>

                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: left; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                            <div>üì• Check your inbox</div>
                            <div>üìÅ Check <strong style="color: var(--text-primary);">Spam / Junk</strong> folder</div>
                            <div>‚è±Ô∏è Can take 1-3 minutes to arrive</div>
                            <div>üîó Click the link in the email to verify</div>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button class="btn" id="resendVerifyBtn" onclick="resendVerification('${email}')" style="font-size: 13px;">
                            Resend Verification Email
                        </button>
                        <a href="#" onclick="hideSignupSuccess(); return false;" style="color: var(--text-secondary); font-size: 13px; text-decoration: none;">‚Üê Back to Login</a>
                    </div>
                </div>
            `;
            initIcons();
        }

        function hideSignupSuccess() {
            const el = document.getElementById('signupVerifyScreen');
            if (el) el.style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.querySelector('.auth-tabs').style.display = 'flex';
            // Activate login tab
            document.querySelectorAll('.auth-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === 0);
            });
        }

        let verifyCooldown = false;
        async function resendVerification(email) {
            if (verifyCooldown) return;
            const btn = document.getElementById('resendVerifyBtn');
            btn.disabled = true;
            btn.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:8px;"><div class="spinner-small"></div> Sending...</div>';

            const { error } = await supabaseClient.auth.resend({
                type: 'signup',
                email: email,
                options: {
                    emailRedirectTo: window.location.origin + '/app'
                }
            });

            if (error) {
                btn.textContent = 'Error: ' + error.message;
                btn.disabled = false;
                return;
            }

            verifyCooldown = true;
            let seconds = 60;
            btn.textContent = `Sent! Resend in ${seconds}s`;
            const timer = setInterval(() => {
                seconds--;
                btn.textContent = `Resend in ${seconds}s`;
                if (seconds <= 0) {
                    clearInterval(timer);
                    verifyCooldown = false;
                    btn.disabled = false;
                    btn.textContent = 'Resend Verification Email';
                }
            }, 1000);
        }

        // Sign in
        async function signIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                alert('Login failed: ' + error.message);
            } else {
                currentUser = data.user;
                loadApp();
            }
        }

        // Sign out
        async function signOut() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            showAuth();
        }

        // Load spots
        async function loadSpots() {
            const { data, error } = await supabaseClient
                .from('spots')
                .select('*')
                .eq('active', true)
                .order('name', { ascending: true });



            if (data) {
                spots = data;
                populateSpotDropdowns();
            }
        }

        // Populate spot dropdowns
        function populateSpotDropdowns() {
            const selects = document.querySelectorAll('select[data-spots]');
            selects.forEach(select => {
                select.innerHTML = spots.map(spot =>
                    `<option value="${spot.id}">${spot.name}</option>`
                ).join('');
            });

            // Also populate history filter
            const historyFilter = document.getElementById('historySpotFilter');
            if (historyFilter) {
                historyFilter.innerHTML = '<option value="">All Locations</option>' +
                    spots.map(spot => `<option value="${spot.id}">${spot.name}</option>`).join('');
            }

            // Also populate event filter
            const eventFilter = document.getElementById('eventSpotFilter');
            if (eventFilter) {
                eventFilter.innerHTML = '<option value="">All Locations</option>' +
                    spots.map(spot => `<option value="${spot.id}">${spot.name}</option>`).join('');
            }
        }

        // Attach Spot Lock Handler
        function attachSpotLockHandler() {
            const spotSelect = document.querySelector('#logTemp select[data-spots]');
            if (spotSelect) {
                spotSelect.removeEventListener('change', handleSpotLock);
                spotSelect.addEventListener('change', handleSpotLock);
            }
        }

        function handleSpotLock() {
            selectedSpotLocked = true;
            // console.log('Spot selection locked by user');
        }

        // Nav Scroll Handler
        function initNavScroll() {
            const navTabs = document.querySelector('.nav-tabs');
            const navFade = document.querySelector('.nav-fade');

            if (!navTabs || !navFade) return;

            const checkScroll = () => {
                // If scrolled to end (within 5px tolerance), hide fade
                const isAtEnd = navTabs.scrollWidth - navTabs.scrollLeft - navTabs.clientWidth < 5;
                navFade.style.opacity = isAtEnd ? '0' : '1';
            };

            navTabs.removeEventListener('scroll', checkScroll);
            navTabs.addEventListener('scroll', checkScroll);

            // Checks initially
            checkScroll();

            // Also check on resize
            window.addEventListener('resize', checkScroll);
        }

        // Age calculation helper for temps
        function getAgeDisplay(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

            if (diffHours < 24) {
                return `${diffHours}h`;
            } else {
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays}d`;
            }
        }

        // Check if temp is fresh (<=96h)
        function isTempFresh(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffHours = diffMs / (1000 * 60 * 60);
            return diffHours <= 96;
        }

        // Helper to parse route from notes (legacy support)
        function parseRouteFromNotes(notes) {
            if (!notes || !notes.startsWith('Route: ')) return { route: null, notes: notes };
            const pipeIndex = notes.indexOf(' | ');
            if (pipeIndex !== -1) {
                return {
                    route: notes.substring(7, pipeIndex).trim(),
                    notes: notes.substring(pipeIndex + 3).trim()
                };
            } else {
                return {
                    route: notes.substring(7).trim(),
                    notes: ''
                };
            }
        }

        // Load dashboard
        async function loadDashboard() {
            try {
                // Load user stats
                const { data: stats } = await supabaseClient
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                // Render stats
                document.getElementById('dashStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div style="text-align: center; background: rgba(56, 189, 248, 0.08); border-radius: 14px; padding: 16px 8px; border: 1px solid rgba(56, 189, 248, 0.12);">
                            <div style="font-size: 26px; font-weight: 800; color: var(--ocean-light); line-height: 1;">${stats?.total_logs || 0}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Logs</div>
                        </div>
                        <div style="text-align: center; background: rgba(16, 185, 129, 0.08); border-radius: 14px; padding: 16px 8px; border: 1px solid rgba(16, 185, 129, 0.12);">
                            <div style="font-size: 26px; font-weight: 800; color: var(--success); line-height: 1;">${stats?.points || 0}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Points</div>
                        </div>
                        <div style="text-align: center; background: rgba(245, 158, 11, 0.08); border-radius: 14px; padding: 16px 8px; border: 1px solid rgba(245, 158, 11, 0.12);">
                            <div style="font-size: 26px; font-weight: 800; color: var(--warning); line-height: 1;">${stats?.current_streak || 0}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Streak</div>
                        </div>
                    </div>
                `;

                // Load upcoming swims user is attending
                console.log('Loading upcoming swims for user:', currentUser.id);

                const { data: memberEvents, error: eventsError } = await supabaseClient
                    .from('swim_participants')
                    .select(`
                        *,
                        swim_events(*)
                    `)
                    .eq('user_id', currentUser.id)
                    .in('status', ['approved', 'requested']);

                console.log('Member events result:', { memberEvents, eventsError });

                // Filter for upcoming events in JavaScript
                const now = new Date();
                const upcomingSwims = memberEvents
                    ?.map(m => m.swim_events)
                    .filter(e => e && new Date(e.start_at) >= now)
                    .slice(0, 3) || [];

                console.log('Upcoming swims after filter:', upcomingSwims);

                if (upcomingSwims.length === 0) {
                    document.getElementById('dashUpcomingSwims').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
                            No upcoming swims yet<br>
                            <button class="btn" style="margin-top: 12px; width: auto; padding: 8px 16px; font-size: 13px;" onclick="showPage('events')">Browse Swims</button>
                        </div>
                    `;
                } else {
                    document.getElementById('dashUpcomingSwims').innerHTML = upcomingSwims.map(e => {
                        const d = new Date(e.start_at);
                        const isToday = d.toDateString() === new Date().toDateString();
                        const isCancelled = e.status === 'cancelled';
                        return `
                            <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid ${isCancelled ? 'rgba(239, 68, 68, 0.2)' : 'rgba(56, 189, 248, 0.2)'}; border-radius: 12px; padding: 12px; margin-bottom: 8px; cursor: pointer; opacity: ${isCancelled ? '0.6' : '1'};" onclick="viewEventDetails('${e.id}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: ${isCancelled ? 'var(--text-secondary)' : 'var(--text-primary)'}; font-size: 15px; display: flex; align-items: center; gap: 6px;">
                                            ${e.title}
                                            ${isCancelled ? '<span style="background: var(--danger); color: white; padding: 1px 6px; border-radius: 4px; font-size: 9px; font-weight: 800;">CANCELLED</span>' : ''}
                                        </div>
                                        <div style="display: flex; gap: 6px; align-items: center; margin-top: 4px;">
                                            <div style="font-size: 12px; color: var(--text-secondary);"><i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${e.location_name}</div>
                                            ${e.route_type ? `
                                                <div style="background: rgba(56, 189, 248, 0.15); color: var(--ocean-light); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; border: 1px solid rgba(56, 189, 248, 0.2);">
                                                    ${e.route_type.replace(/_/g, ' ')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 13px; color: ${isCancelled ? 'var(--text-secondary)' : (isToday ? 'var(--success)' : 'var(--ocean-light)')}; font-weight: 600;">
                                            ${isToday ? 'TODAY' : d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Initialize icons after rendering upcoming swims
                initIcons();

                // Load recent temperatures
                // Load recent temperatures
                const { data: recentLogs, error: logError } = await supabaseClient
                    .from('temp_logs')
                    .select('*') // Simple select to avoid join issues
                    .order('created_at', { ascending: false })
                    .limit(10); // Get more to account for potential filtering

                if (logError) {
                    console.error('Error fetching recent logs:', logError);
                    document.getElementById('dashConditions').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--danger); font-size: 13px;">
                            Error loading temperatures
                        </div>
                    `;
                    return;
                }

                if (!recentLogs || recentLogs.length === 0) {
                    document.getElementById('dashConditions').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
                            No recent temperatures logged
                        </div>
                    `;
                } else {
                    // Group by spot, show latest per spot, filtering for active spots
                    const bySpot = {};
                    recentLogs.forEach(log => {
                        // Find spot in our local active spots array
                        const spotInfo = spots.find(s => s.id === log.spot_id);
                        if (spotInfo && !bySpot[log.spot_id]) {
                            log.spotName = spotInfo.name; // Attach name locally
                            bySpot[log.spot_id] = log;
                        }
                    });

                    const latest = Object.values(bySpot).slice(0, 4);

                    if (latest.length === 0) {
                        // Fallback: If filtering by active spots left us with nothing, 
                        // but we HAVE logs, just show the most recent ones anyway
                        const fallbackLogs = recentLogs.slice(0, 2);
                        fallbackLogs.forEach(log => {
                            log.spotName = spots.find(s => s.id === log.spot_id)?.name || 'Unknown Spot';
                        });

                        if (fallbackLogs.length > 0) {
                            renderDashConditions(fallbackLogs);
                        } else {
                            document.getElementById('dashConditions').innerHTML = `
                                <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
                                    No recent temperatures logged
                                </div>
                            `;
                        }
                    } else {
                        renderDashConditions(latest);
                    }
                }

            } catch (err) {
                console.error('Error loading dashboard:', err);
            }

            // Initialize icons and notifications
            initIcons();
            loadNotifications();
        }

        function renderDashConditions(logs) {
            document.getElementById('dashConditions').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    ${logs.map(log => {
                const color = log.temp_c < 10 ? '#6366f1' : log.temp_c < 12 ? '#3b82f6' : log.temp_c < 16 ? '#06b6d4' : log.temp_c < 20 ? '#10b981' : log.temp_c < 24 ? '#f59e0b' : log.temp_c < 28 ? '#f97316' : '#ef4444';
                const age = getAgeDisplay(log.created_at);
                const isFresh = isTempFresh(log.created_at);
                return `
                                <div style="background: rgba(15, 23, 42, 0.6); border-radius: 14px; padding: 14px; text-align: center; border: 1px solid ${color}20; ${!isFresh ? 'opacity: 0.5;' : ''} transition: all 0.2s ease;">
                                    <div style="font-size: 28px; font-weight: 800; color: ${color}; text-shadow: 0 0 20px ${color}30; line-height: 1.1;">${log.temp_c}¬∞</div>
                                    <div style="font-size: 10px; font-weight: 500; color: ${color}; opacity: 0.7; margin-top: 2px;">${age}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; font-weight: 600;">${log.spotName || 'Unknown'}</div>
                                    <div style="font-size: 10px; color: var(--text-secondary); opacity: 0.5; margin-top: 2px;">${getTimeAgo(new Date(log.created_at))}</div>
                                </div>
                            `;
            }).join('')}
                </div>
            `;
            initIcons();
        }

        // History view state
        let historyView = 'my'; // 'my' or 'community'
        let tempChart = null;

        // Toggle history view
        function toggleHistoryView(el, view) {
            historyView = view;
            el.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            loadHistory();
        }

        // Load history and trends
        async function loadHistory() {
            const spotFilter = document.getElementById('historySpotFilter').value;

            try {
                // First, try simple query without joins
                let query = supabaseClient
                    .from('temp_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                // Filter by user if "My Logs" is selected
                if (historyView === 'my') {
                    query = query.eq('user_id', currentUser.id);
                }

                // Filter by spot if selected
                if (spotFilter) {
                    query = query.eq('spot_id', spotFilter);
                }

                const { data: logs, error } = await query;

                if (error) {
                    console.error('Error loading history:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    document.getElementById('historyList').innerHTML =
                        `<div style="color: var(--danger); text-align: center; padding: 20px;">
                            Error loading history<br>
                            <small style="font-size: 11px;">${error.message || 'Unknown error'}</small>
                        </div>`;
                    return;
                }

                console.log('Loaded logs:', logs);

                // Now load spot and profile data separately
                if (logs && logs.length > 0) {
                    const spotIds = [...new Set(logs.map(l => l.spot_id).filter(Boolean))];
                    const userIds = [...new Set(logs.map(l => l.user_id).filter(Boolean))];

                    // Load spots
                    const { data: spotsData } = await supabaseClient
                        .from('spots')
                        .select('id, name')
                        .in('id', spotIds);

                    // Load profiles
                    const { data: profilesData } = await supabaseClient
                        .from('profiles')
                        .select('id, display_name')
                        .in('id', userIds);

                    // Create lookup maps
                    const spotMap = {};
                    const profileMap = {};

                    if (spotsData) spotsData.forEach(s => spotMap[s.id] = s);
                    if (profilesData) profilesData.forEach(p => profileMap[p.id] = p);

                    // Attach to logs
                    logs.forEach(log => {
                        log.spots = spotMap[log.spot_id] || null;
                        log.profiles = profileMap[log.user_id] || null;
                    });
                }

                // Render list
                renderHistoryList(logs);

                // Render chart
                renderTempChart(logs);
            } catch (err) {
                console.error('Caught error:', err);
                document.getElementById('historyList').innerHTML =
                    `<div style="color: var(--danger); text-align: center; padding: 20px;">
                        Unexpected error<br>
                        <small style="font-size: 11px;">${err.message}</small>
                    </div>`;
            }
        }

        // Render history list
        function renderHistoryList(logs) {
            const container = document.getElementById('historyList');

            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        No temperature logs yet. Be the first to log!
                    </div>
                `;
                return;
            }

            // Group by spot to get latest per spot
            const bySpot = {};
            logs.forEach(log => {
                if (!bySpot[log.spot_id]) {
                    bySpot[log.spot_id] = log;
                }
            });

            const allSpots = Object.values(bySpot);

            // Separate fresh (<=96h) and stale (>96h)
            const freshTemps = allSpots.filter(log => isTempFresh(log.created_at));
            const staleTemps = allSpots.filter(log => !isTempFresh(log.created_at));

            let html = '';

            // Fresh temps section
            if (freshTemps.length > 0) {
                html += freshTemps.map(log => {
                    const date = new Date(log.created_at);
                    const timeAgo = getTimeAgo(date);
                    const age = getAgeDisplay(log.created_at);
                    const spotName = log.spots?.name || 'Unknown';
                    const userName = log.profiles?.display_name || 'Anonymous';

                    return `
                    <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid rgba(56, 189, 248, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--ocean-light);">
                                    ${log.temp_c}¬∞C <span style="font-size: 12px; font-weight: 400; color: var(--text-secondary);">${age}</span>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    <i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${spotName}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${timeAgo}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${userName}
                                </div>
                            </div>
                        </div>
                        ${log.conditions ? `
                            <div style="display: inline-block; background: rgba(56, 189, 248, 0.2); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-top: 6px;">
                                ${log.conditions}
                            </div>
                        ` : ''}
                        ${log.hazards && log.hazards.length > 0 ? log.hazards.map(h => `
                            <div style="display: inline-block; background: rgba(245, 158, 11, 0.2); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-top: 6px;">
                                ${h}
                            </div>
                        `).join('') : ''}
                        ${log.notes ? `
                            <div style="margin-top: 10px; font-size: 13px; color: var(--text-secondary); font-style: italic;">
                                "${log.notes}"
                            </div>
                        ` : ''}
                    </div>
                `;
                }).join('');
            }

            // Stale temps section (collapsible)
            if (staleTemps.length > 0) {
                html += `
                    <div style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 16px;">
                        <div onclick="toggleStaleTemps()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.4); border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">
                                <i data-lucide="clock" style="width: 14px; height: 14px; vertical-align: middle;"></i> Stale Temperatures (${staleTemps.length})
                            </div>
                            <i id="staleToggleIcon" data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                        </div>
                        <div id="staleTempsContainer" style="display: none;">
                            ${staleTemps.map(log => {
                    const date = new Date(log.created_at);
                    const timeAgo = getTimeAgo(date);
                    const age = getAgeDisplay(log.created_at);
                    const spotName = log.spots?.name || 'Unknown';
                    const userName = log.profiles?.display_name || 'Anonymous';

                    return `
                                    <div style="background: rgba(15, 23, 42, 0.4); border: 2px solid rgba(56, 189, 248, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 12px; opacity: 0.6;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <div style="font-size: 18px; font-weight: 600; color: var(--ocean-light);">
                                                    ${log.temp_c}¬∞C <span style="font-size: 12px; font-weight: 400; color: var(--text-secondary);">${age}</span>
                                                </div>
                                                <div style="font-size: 13px; color: var(--text-secondary);">
                                                    <i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${spotName}
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">
                                                    ${timeAgo}
                                                </div>
                                                <div style="font-size: 12px; color: var(--text-secondary);">
                                                    ${userName}
                                                </div>
                                            </div>
                                        </div>
                                        ${log.conditions ? `
                                            <div style="display: inline-block; background: rgba(56, 189, 248, 0.1); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-top: 6px;">
                                                ${log.conditions}
                                            </div>
                                        ` : ''}
                                        ${log.hazards && log.hazards.length > 0 ? log.hazards.map(h => `
                                            <div style="display: inline-block; background: rgba(245, 158, 11, 0.1); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-top: 6px;">
                                                ${h}
                                            </div>
                                        `).join('') : ''}
                                        ${log.notes ? `
                                            <div style="margin-top: 10px; font-size: 13px; color: var(--text-secondary); font-style: italic;">
                                                "${log.notes}"
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            initIcons();
        }

        // Toggle stale temps visibility
        function toggleStaleTemps() {
            const container = document.getElementById('staleTempsContainer');
            const icon = document.getElementById('staleToggleIcon');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.setAttribute('data-lucide', 'chevron-up');
            } else {
                container.style.display = 'none';
                icon.setAttribute('data-lucide', 'chevron-down');
            }
            initIcons();
        }

        // Render temperature chart
        function renderTempChart(logs) {
            const ctx = document.getElementById('tempChart');

            if (!logs || logs.length === 0) {
                ctx.style.display = 'none';
                return;
            }

            ctx.style.display = 'block';

            // Prepare data (reverse to show oldest to newest)
            const reversedLogs = [...logs].reverse();
            const labels = reversedLogs.map(log => {
                const date = new Date(log.created_at);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const temps = reversedLogs.map(log => log.temp_c);

            // Destroy existing chart
            if (tempChart) {
                tempChart.destroy();
            }

            // Create new chart
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Water Temperature (¬∞C)',
                        data: temps,
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#38bdf8',
                        pointBorderColor: '#0c4a6e',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(56, 189, 248, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8',
                                callback: function (value) {
                                    return value + '¬∞C';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(56, 189, 248, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        // Helper: Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';

            return date.toLocaleDateString();
        }

        // ========== SWIM EVENTS ==========

        // Show/hide create event modal
        function showCreateEvent() {
            // Default to 08:00 AM today
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('eventDateTime').value = `${year}-${month}-${day}T08:00`;

            document.getElementById('createEventModal').style.display = 'block';
        }

        function hideCreateEvent() {
            document.getElementById('createEventModal').style.display = 'none';
            document.getElementById('createEventForm').reset();
        }

        function clearEventFilter() {
            const filter = document.getElementById('eventSpotFilter');
            if (filter) {
                filter.value = '';
                loadEvents();
            }
        }

        // Load events
        async function loadEvents() {
            try {
                console.log('Loading events...');

                // Query using your actual column names
                const { data: events, error } = await supabaseClient
                    .from('swim_events')
                    .select('*')
                    .order('start_at', { ascending: true })
                    .limit(50); // Increased limit as we filter client-side

                console.log('Events query result:', { events, error });

                if (error) {
                    console.error('Error loading events:', error);
                    document.getElementById('eventsList').innerHTML =
                        `<div style="color: var(--danger); text-align: center; padding: 20px;">
                            Error loading events<br>
                            <small style="font-size: 11px;">${error.message || JSON.stringify(error)}</small>
                        </div>`;
                    return;
                }

                // Filter out past events
                const now = new Date();
                let upcomingEvents = events?.filter(e => new Date(e.start_at) >= now) || [];

                // Apply location filter
                const spotFilterDom = document.getElementById('eventSpotFilter');
                const selectedSpotId = spotFilterDom ? spotFilterDom.value : '';

                // Show/hide clear link
                const clearLink = document.getElementById('clearEventFilter');
                if (clearLink) clearLink.style.display = selectedSpotId ? 'inline' : 'none';

                if (selectedSpotId) {
                    const selectedSpot = spots.find(s => s.id === selectedSpotId);
                    const selectedName = selectedSpot ? selectedSpot.name.trim().toLowerCase() : '';

                    upcomingEvents = upcomingEvents.filter(e => {
                        // Match by ID if present
                        if (e.spot_id === selectedSpotId) return true;
                        // Fallback match by name
                        if (e.location_name && selectedName) {
                            return e.location_name.trim().toLowerCase() === selectedName;
                        }
                        return false;
                    });
                }

                // Sort cancelled swims to the bottom
                upcomingEvents.sort((a, b) => {
                    if (a.status === 'cancelled' && b.status !== 'cancelled') return 1;
                    if (a.status !== 'cancelled' && b.status === 'cancelled') return -1;
                    return 0;
                });

                console.log('Upcoming events:', upcomingEvents);

                // If no events, show empty state
                if (!upcomingEvents || upcomingEvents.length === 0) {
                    const hasFilter = !!selectedSpotId;
                    document.getElementById('eventsList').innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;"><i data-lucide="waves" style="width: 48px; height: 48px;"></i></div>
                            <div style="font-size: 16px; margin-bottom: 8px;">${hasFilter ? 'No swims for this location yet' : 'No upcoming swims'}</div>
                            <div style="font-size: 13px; margin-bottom: 20px;">${hasFilter ? 'Create a new swim or clear the filter.' : 'Be the first to create one!'}</div>
                            ${hasFilter ? '<button class="btn btn-secondary" onclick="clearEventFilter()" style="width: auto; padding: 10px 20px;">Clear Filter</button>' : ''}
                        </div>
                    `;
                    return;
                }

                console.log('Successfully loaded events:', upcomingEvents);

                // Load creator profiles
                const creatorIds = [...new Set(upcomingEvents.map(e => e.created_by).filter(Boolean))];
                const { data: profilesData } = await supabaseClient
                    .from('profiles')
                    .select('id, display_name')
                    .in('id', creatorIds);

                const profileMap = {};
                if (profilesData) profilesData.forEach(p => profileMap[p.id] = p);

                console.log('Profile map:', profileMap);
                console.log('Creator IDs needed:', creatorIds);

                // Load user's status for these events
                const eventIds = upcomingEvents.map(e => e.id);
                const { data: userStatuses } = await supabaseClient
                    .from('swim_participants')
                    .select('swim_event_id, status')
                    .eq('user_id', currentUser.id)
                    .in('swim_event_id', eventIds);

                const statusMap = {};
                if (userStatuses) userStatuses.forEach(r => statusMap[r.swim_event_id] = r.status);

                // Load participant counts for these events
                const { data: counts } = await supabaseClient
                    .from('swim_participants')
                    .select('swim_event_id, status')
                    .in('swim_event_id', eventIds);

                const countMap = {};
                if (counts) {
                    counts.forEach(c => {
                        if (!countMap[c.swim_event_id]) countMap[c.swim_event_id] = { confirmed: 0, pending: 0 };
                        if (c.status === 'approved') countMap[c.swim_event_id].confirmed++;
                        if (c.status === 'requested') countMap[c.swim_event_id].pending++;
                    });
                }

                // Show events with your actual data structure
                const html = upcomingEvents.map(event => {
                    const eventDate = new Date(event.start_at);
                    const dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const timeStr = eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const creatorName = profileMap[event.created_by]?.display_name || 'Anonymous';
                    const userStatus = statusMap[event.id];
                    const isCancelled = event.status === 'cancelled';

                    // Participant counts
                    const confirmed = countMap[event.id]?.confirmed || 0;
                    const pending = countMap[event.id]?.pending || 0;
                    const maxPart = event.max_participants;
                    const spotsLeft = maxPart ? (maxPart - confirmed) : null;

                    // Determine pace level (for display)
                    const paceVal = event.target_pace_sec_per_100m;
                    let paceLabel = 'Developing';
                    let paceEmoji = '<i data-lucide="heart" style="width: 14px; height: 14px; vertical-align: middle;"></i>';

                    if (paceVal <= 100) {
                        paceLabel = 'Fast';
                        paceEmoji = '<i data-lucide="zap" style="width: 14px; height: 14px; vertical-align: middle;"></i>';
                    } else if (paceVal <= 120) {
                        paceLabel = 'Steady';
                        paceEmoji = '<i data-lucide="trending-up" style="width: 14px; height: 14px; vertical-align: middle;"></i>';
                    } else if (paceVal <= 150) {
                        paceLabel = 'Social';
                        paceEmoji = '<i data-lucide="users" style="width: 14px; height: 14px; vertical-align: middle;"></i>';
                    }

                    // Build RSVP buttons - clean 2-column layout
                    let rsvpButtons = '';
                    if (isCancelled) {
                        rsvpButtons = `
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: var(--danger); cursor: not-allowed;" disabled>
                                    Cancelled
                                </button>
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary);" onclick="event.stopPropagation(); viewEventDetails('${event.id}')">
                                    Details
                                </button>
                            </div>
                        `;
                    } else if (userStatus === 'approved') {
                        rsvpButtons = `
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <button class="btn btn-success" style="flex: 1; padding: 10px; font-size: 13px;" disabled>
                                    ‚úì You're Going
                                </button>
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary);" onclick="event.stopPropagation(); viewEventDetails('${event.id}')">
                                    Details
                                </button>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button class="btn" style="flex: 1; padding: 8px; font-size: 12px; background: rgba(234, 179, 8, 0.15); border: 1px solid rgba(234, 179, 8, 0.3); color: var(--warning);" onclick="event.stopPropagation(); viewEventDetails('${event.id}')">
                                    Running Late
                                </button>
                                <button class="btn" style="flex: 1; padding: 8px; font-size: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: var(--danger);" onclick="event.stopPropagation(); leaveEvent('${event.id}')">
                                    Cancel RSVP
                                </button>
                            </div>
                        `;
                    } else if (userStatus === 'requested') {
                        rsvpButtons = `
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.2); color: var(--ocean-light); cursor: not-allowed;" disabled>
                                    Request Sent
                                </button>
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary);" onclick="event.stopPropagation(); viewEventDetails('${event.id}')">
                                    Details
                                </button>
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: var(--danger);" onclick="event.stopPropagation(); leaveEvent('${event.id}')">
                                    Cancel
                                </button>
                            </div>
                        `;
                    } else {
                        rsvpButtons = `
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <button class="btn btn-success" style="flex: 1; padding: 10px; font-size: 13px;" onclick="event.stopPropagation(); joinEvent('${event.id}', 'going')">
                                    I'm Going
                                </button>
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(234, 179, 8, 0.15); border: 1px solid rgba(234, 179, 8, 0.3); color: var(--warning);" onclick="event.stopPropagation(); joinEvent('${event.id}', 'maybe')">
                                    Maybe
                                </button>
                                <button class="btn" style="flex: 1; padding: 10px; font-size: 13px; background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary);" onclick="event.stopPropagation(); viewEventDetails('${event.id}')">
                                    Details
                                </button>
                            </div>
                        `;
                    }

                    const routeInfo = parseRouteFromNotes(event.notes);
                    const displayRoute = event.route_type ? event.route_type.replace(/_/g, ' ') : routeInfo.route;
                    const displayNotes = event.description || event.notes;

                    return `
                        <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid ${isCancelled ? 'rgba(239, 68, 68, 0.2)' : 'rgba(56, 189, 248, 0.2)'}; border-radius: 12px; padding: 18px; margin-bottom: 14px; cursor: pointer; opacity: ${isCancelled ? '0.6' : '1'}; transition: all 0.2s;" onclick="viewEventDetails('${event.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${isCancelled ? 'var(--text-secondary)' : 'var(--text-primary)'}; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        ${event.title || 'Untitled Swim'}
                                        ${isCancelled ? `
                                            <span style="background: var(--danger); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px;">CANCELLED</span>
                                        ` : ''}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        üìç ${event.location_name || 'Location TBD'}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 14px; color: var(--ocean-light); font-weight: 600;">
                                        ${dateStr}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        ${timeStr}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                <div style="background: rgba(56, 189, 248, 0.15); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; color: var(--ocean-light);">
                                    ${paceLabel}
                                </div>
                                ${displayRoute ? `
                                    <div style="background: rgba(56, 189, 248, 0.1); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: var(--text-secondary);">
                                        ${displayRoute}
                                    </div>
                                ` : ''}
                                ${event.tow_float_recommended ? `
                                    <div style="background: rgba(251, 191, 36, 0.15); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: var(--warning);">
                                        Tow Float
                                    </div>
                                ` : ''}
                                ${event.bright_cap_recommended ? `
                                    <div style="background: rgba(251, 191, 36, 0.15); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: var(--warning);">
                                        Bright Cap
                                    </div>
                                ` : ''}
                                ${event.distance_km ? `
                                    <div style="background: rgba(16, 185, 129, 0.15); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: var(--success);">
                                        ${event.distance_km}km
                                    </div>
                                ` : ''}
                                <div style="background: rgba(139, 92, 246, 0.15); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: #a78bfa;">
                                    ${confirmed} going${pending > 0 ? ` ¬∑ ${pending} pending` : ''}${spotsLeft !== null ? ` ¬∑ ${spotsLeft} left` : ''}
                                </div>
                            </div>
                            
                            ${displayNotes ? `
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.5;">
                                    ${displayNotes.substring(0, 100)}${displayNotes.length > 100 ? '...' : ''}
                                </div>
                            ` : ''}
                            
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                Created by ${creatorName}
                            </div>
                            
                            ${rsvpButtons}
                        </div>
                    `;
                }).join('');

                document.getElementById('eventsList').innerHTML = html;
                initIcons(); // Initialize Lucide icons

            } catch (err) {
                console.error('Caught error:', err);
                document.getElementById('eventsList').innerHTML =
                    `<div style="color: var(--danger); text-align: center; padding: 20px;">
                        Unexpected error<br>
                        <small style="font-size: 11px;">${err.message}</small>
                    </div>`;
            }
        }


        // Submit new event  
        async function submitEvent(e) {
            e.preventDefault();

            // Get form values
            const title = document.getElementById('eventName')?.value;
            const spotSelect = document.getElementById('eventSpot');
            const spotId = spotSelect?.value;
            const startAt = document.getElementById('eventDateTime')?.value + ':00+02:00'; // Appending SAST offset (+02:00)
            const paceLevel = document.getElementById('eventPaceLevel')?.value;
            const distanceKm = parseFloat(document.getElementById('eventDistance')?.value);
            const notes = document.getElementById('eventDescription')?.value;

            // Find the spot name from the ID
            const spot = spots.find(s => s.id === spotId);
            const locationName = spot ? spot.name : spotSelect?.options[spotSelect.selectedIndex]?.text;

            // Pace level is now stored directly as integer (no mapping needed)
            const targetPace = parseInt(paceLevel, 10);

            // Handle coordination fields
            const routeType = document.getElementById('eventRouteType')?.value;
            const towFloat = document.getElementById('eventTowFloat')?.checked;
            const brightCap = document.getElementById('eventBrightCap')?.checked;
            const logistics = document.getElementById('eventLogistics')?.value;
            const chatUrl = document.getElementById('eventChatUrl')?.value;

            const eventData = {
                created_by: currentUser.id,
                title: title,
                start_at: startAt,
                location_name: locationName,
                lat: spot?.latitude || null,
                lng: spot?.longitude || null,
                distance_km: distanceKm,
                target_pace_sec_per_100m: targetPace,
                notes: notes,
                route_type: routeType,
                tow_float_recommended: towFloat,
                bright_cap_recommended: brightCap,
                logistics_note: logistics,
                external_chat_url: chatUrl,
                requires_approval: document.getElementById('eventRequireApproval')?.checked || false,
                status: 'planned',
                category: 'open'
            };

            console.log('CREATE_SWIM payload', eventData);

            const { data, error } = await supabaseClient
                .from('swim_events')
                .insert([eventData])
                .select();

            if (error) {
                alert('Error creating event: ' + error.message);
                console.error('Event creation error:', error);
                return;
            }

            console.log('Event created:', data);

            // Auto-join creator as organizer
            if (data && data[0]) {
                try {
                    await supabaseClient
                        .from('swim_participants')
                        .upsert({
                            swim_event_id: data[0].id,
                            user_id: currentUser.id,
                            rsvp: 'going',
                            status: 'approved',
                            requested_at: new Date().toISOString(),
                            decided_at: new Date().toISOString(),
                            decided_by: currentUser.id
                        }, { onConflict: 'swim_event_id,user_id' });
                } catch (err) {
                    console.error('Could not auto-join event:', err);
                }
            }


            showToast('Swim created successfully!', 'success');
            hideCreateEvent();
            loadEvents();
        }

        // View event details (placeholder)
        // RSVP to event
        // Check if user has safety info before joining a swim
        async function checkSafetyInfo() {
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('phone, emergency_contact_name, emergency_contact_phone')
                .eq('id', currentUser.id)
                .single();

            if (!profile || !profile.phone || !profile.emergency_contact_name || !profile.emergency_contact_phone) {
                showToast('Please add your phone & emergency contact in Profile first', 'error');
                setTimeout(() => showProfileSettings(), 500);
                return false;
            }
            return true;
        }

        async function rsvpToEvent(eventId, rsvpStatus) {
            try {
                // Safety gate: require phone + emergency contact
                if (rsvpStatus === 'going') {
                    const safe = await checkSafetyInfo();
                    if (!safe) return;
                }

                // Determine status based on event requirements
                const { data: event } = await supabaseClient
                    .from('swim_events')
                    .select('requires_approval')
                    .eq('id', eventId)
                    .single();

                const status = event?.requires_approval ? 'requested' : 'approved';

                const { error } = await supabaseClient
                    .from('swim_participants')
                    .upsert({
                        swim_event_id: eventId,
                        user_id: currentUser.id,
                        rsvp: rsvpStatus,
                        status: status
                    }, { onConflict: 'swim_event_id,user_id' });

                if (error) throw error;

                if (status === 'requested') {
                    showToast('Request sent to organizer!', 'info');
                } else {
                    showToast(rsvpStatus === 'going' ? "You're in!" : 'RSVP updated', 'success');
                }

                await showEventDetails(eventId);
                loadEvents();
                loadDashboard();
            } catch (err) {
                console.error('RSVP Error:', err);
                alert('Error updating RSVP: ' + err.message);
            }
        }
        async function updateJoinStatus(eventId, memberId, newStatus) {
            try {
                console.log('Updating join status:', memberId, 'to', newStatus);

                // Get member details to know WHO we are notifying
                const { data: member } = await supabaseClient
                    .from('swim_participants')
                    .select('user_id, swim_event_id')
                    .eq('id', memberId)
                    .single();

                const { error } = await supabaseClient
                    .from('swim_participants')
                    .update({
                        status: newStatus,
                        decided_at: new Date().toISOString(),
                        decided_by: currentUser.id
                    })
                    .eq('id', memberId);

                if (error) throw error;

                // Create notification for the user
                if (member) {
                    const { data: event } = await supabaseClient
                        .from('swim_events')
                        .select('title, start_at, location_name')
                        .eq('id', eventId)
                        .single();

                    const eventDate = new Date(event.start_at).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) + ' on ' + new Date(event.start_at).toLocaleDateString('en-US', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short'
                    });

                    const swimTitle = event.title || event.location_name;
                    const type = newStatus === 'approved' ? 'approval_granted' : 'approval_rejected';
                    const title = newStatus === 'approved' ? 'Approved to join' : 'Join request declined';
                    const message = newStatus === 'approved'
                        ? `Your request to join "${swimTitle}" at ${eventDate} has been approved!`
                        : `Your request to join "${swimTitle}" at ${eventDate} was declined.`;

                    await notify(member.user_id, eventId, type, title, message, { swim_event_id: eventId, decision: newStatus });
                }

                showToast(newStatus === 'approved' ? 'Swimmer approved!' : 'Request declined', 'success');
                await showEventDetails(eventId); // Refresh modal
                await loadEvents(); // Refresh home
            } catch (err) {
                console.error('Error updating status:', err);
                alert('Error: ' + err.message);
            }
        }

        // View event (compatibility function)
        function viewEvent(eventId) {
            showEventDetails(eventId);
        }

        // View event details (wrapper for compatibility)
        async function viewEventDetails(eventId) {
            showPage('events');
            await showEventDetails(eventId);
        }

        // Show event details modal
        async function showEventDetails(eventId) {
            // Find the event
            const event = await loadEventDetails(eventId);
            if (!event) return;

            document.getElementById('eventDetailsModal').style.display = 'block';
            renderEventDetails(event);
        }

        function hideEventDetails() {
            document.getElementById('eventDetailsModal').style.display = 'none';
        }

        async function loadEventDetails(eventId) {
            try {
                console.log('Loading event details for:', eventId);

                const { data: event, error } = await supabaseClient
                    .from('swim_events')
                    .select('*')
                    .eq('id', eventId)
                    .single();

                if (error) throw error;

                console.log('Event loaded:', event);

                // Load creator profile
                const { data: creatorProfile, error: creatorError } = await supabaseClient
                    .from('profiles')
                    .select('display_name')
                    .eq('id', event.created_by)
                    .maybeSingle();

                if (creatorError) {
                    console.error('Error loading creator:', creatorError);
                }

                event.creatorName = creatorProfile?.display_name || 'Anonymous';
                console.log('Creator:', event.creatorName);

                // Load participants - simple query without join
                const { data: members, error: membersError } = await supabaseClient
                    .from('swim_participants')
                    .select('*')
                    .eq('swim_event_id', eventId);

                console.log('Members loaded:', { members, membersError });

                // Load profiles for these members separately
                if (members && members.length > 0) {
                    const userIds = members.map(m => m.user_id);
                    const { data: profiles } = await supabaseClient
                        .from('profiles')
                        .select('id, display_name, phone, emergency_contact_name, emergency_contact_phone')
                        .in('id', userIds);

                    console.log('Profiles loaded:', profiles);

                    // Attach profiles to members
                    members.forEach(member => {
                        const profile = profiles?.find(p => p.id === member.user_id);
                        member.profiles = profile;
                    });
                }

                event.members = members || [];

                // Check if current user is attending
                const myMember = members?.find(m => m.user_id === currentUser.id);
                event.userStatus = myMember?.status || null;

                console.log('User status:', event.userStatus);

                return event;
            } catch (err) {
                console.error('Error loading event:', err);
                alert('Error loading event details: ' + err.message);
                return null;
            }
        }

        function renderEventDetails(event) {
            const isCancelled = event.status === 'cancelled';
            const eventDate = new Date(event.start_at);
            const attending = event.members.filter(m => m.status === 'approved').length;
            const pending = event.members.filter(m => m.status === 'requested').length;

            const html = `
                <div style="margin-bottom: 20px;">
                    ${isCancelled ? `
                        <div style="background: rgba(239, 68, 68, 0.15); border: 2px solid var(--danger); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
                            <div style="color: var(--danger); font-size: 18px; font-weight: 800; letter-spacing: 1px;">SWIM CANCELLED</div>
                            <div style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">This event will no longer take place.</div>
                        </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h2 style="font-size: 24px; color: var(--text-primary); margin-bottom: 8px;">${event.title || 'Group Swim'}</h2>
                        ${(function () {
                    const created = new Date(event.created_at);
                    const updated = new Date(event.updated_at);
                    if (updated - created > 60000) {
                        return `
                                    <div style="background: rgba(56, 189, 248, 0.2); color: var(--ocean-light); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; border: 1px solid rgba(56, 189, 248, 0.3);">
                                        <i data-lucide="refresh-cw" style="width: 12px; height: 12px; vertical-align: middle;"></i> UPDATED
                                    </div>
                                `;
                    }
                    return '';
                })()}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 14px;">Created by ${event.creatorName}</div>
                </div>
                
                <div style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="margin-bottom: 12px;">
                        <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="map-pin" style="width: 14px; height: 14px; vertical-align: middle;"></i> LOCATION</span>
                        <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-top: 4px;">${event.location_name}</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="calendar" style="width: 14px; height: 14px; vertical-align: middle;"></i> DATE & TIME</span>
                        <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-top: 4px;">
                            ${eventDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                            <br>${eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </div>
                    
                    ${event.distance_km ? `
                        <div style="margin-bottom: 12px;">
                            <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="ruler" style="width: 14px; height: 14px; vertical-align: middle;"></i> DISTANCE</span>
                            <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-top: 4px;">${event.distance_km}km</div>
                        </div>
                    ` : ''}
                    
                    ${(function () {
                    const routeInfo = parseRouteFromNotes(event.notes);
                    const displayRoute = event.route_type ? event.route_type.replace(/_/g, ' ') : routeInfo.route;
                    return displayRoute ? `
                            <div style="margin-bottom: 12px;">
                                <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="repeat" style="width: 14px; height: 14px; vertical-align: middle;"></i> ROUTE TYPE</span>
                                <div style="color: var(--text-primary); font-size: 16px; font-weight: 600; margin-top: 4px;">${displayRoute}</div>
                            </div>
                        ` : '';
                })()}

                    ${(event.tow_float_recommended || event.bright_cap_recommended) ? `
                        <div style="margin-bottom: 12px;">
                            <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="shield" style="width: 14px; height: 14px; vertical-align: middle;"></i> SAFETY RECOMMENDED</span>
                            <div style="display: flex; gap: 8px; margin-top: 6px;">
                                ${event.tow_float_recommended ? `
                                    <div style="background: rgba(251, 191, 36, 0.15); color: var(--warning); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; border: 1px solid rgba(251, 191, 36, 0.3);">
                                        Tow Float
                                    </div>
                                ` : ''}
                                ${event.bright_cap_recommended ? `
                                    <div style="background: rgba(251, 191, 36, 0.15); color: var(--warning); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; border: 1px solid rgba(251, 191, 36, 0.3);">
                                        Bright Cap
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${event.logistics_note ? `
                        <div style="margin-bottom: 12px;">
                            <span style="color: var(--text-secondary); font-size: 13px;"><i data-lucide="truck" style="width: 14px; height: 14px; vertical-align: middle;"></i> LOGISTICS</span>
                            <div style="color: var(--text-primary); font-size: 14px; margin-top: 4px; line-height: 1.6;">${event.logistics_note}</div>
                        </div>
                    ` : ''}
                    <!-- Private Coordination Details -->
                ${(() => {
                    const isApproved = event.userStatus === 'approved';
                    const isCreator = event.created_by === currentUser.id;
                    const isRequested = event.userStatus === 'requested';

                    if (!isApproved && !isCreator) {
                        return isRequested ? `
                            <div style="background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
                                <div style="color: var(--warning); font-size: 14px; font-weight: 700;"><i data-lucide="clock" style="width: 14px; height: 14px; vertical-align: middle;"></i> APPROVAL REQUESTED</div>
                                <div style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">The host must approve your request before you can see fixed logistics or group chat links.</div>
                            </div>
                        ` : '';
                    }

                    return `
                        <!-- Coordination Info -->
                        ${event.external_chat_url ? `
                            <div style="background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #25D366; display: flex; align-items: center; justify-content: center; color: white;">
                                        <i data-lucide="message-circle" style="width: 20px; height: 20px;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; color: #25D366; font-size: 13px;">WHATSAPP GROUP</div>
                                        <a href="${event.external_chat_url}" target="_blank" style="color: white; font-size: 14px; text-decoration: underline;">Click to join WhatsApp group</a>
                                    </div>
                                </div>
                                <i data-lucide="external-link" style="width: 16px; height: 16px; color: var(--text-secondary);"></i>
                            </div>
                        ` : ''}
                    `;
                })()}

                <!-- Pending Requests for Creator -->
                ${(event.created_by === currentUser.id && event.members.some(m => m.status === 'requested')) ? `
                    <div style="background: rgba(234, 179, 8, 0.1); border: 1px solid var(--warning); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="font-weight: 700; color: var(--warning); font-size: 14px; margin-bottom: 12px;"><i data-lucide="bell" style="width: 14px; height: 14px; vertical-align: middle;"></i> PENDING REQUESTS</div>
                        ${event.members.filter(m => m.status === 'requested').map(m => `
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 28px; height: 28px; border-radius: 50%; background: var(--warning); display: flex; align-items: center; justify-content: center; color: black; font-weight: 700; font-size: 12px;">
                                        ${m.profiles?.avatar_url ? `<i data-lucide="${m.profiles.avatar_url}" style="width: 14px; height: 14px;"></i>` : (m.profiles?.display_name?.charAt(0) || '?')}
                                    </div>
                                    <span style="font-size: 14px; color: var(--text-primary);">${m.profiles?.display_name || 'Anonymous'}</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-success" style="padding: 6px 12px; font-size: 11px;" onclick="updateJoinStatus('${event.id}', '${m.id}', 'approved')">Approve</button>
                                    <button class="btn" style="padding: 6px 12px; font-size: 11px; background: transparent; border: 1px solid var(--danger); color: var(--danger);" onclick="updateJoinStatus('${event.id}', '${m.id}', 'rejected')">Reject</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Running Late Section -->
                ${(function () {
                    const isCancelled = event.status === 'cancelled';
                    const approvedMembers = event.members.filter(m => m.status === 'approved');
                    const me = approvedMembers.find(m => m.user_id === currentUser.id);
                    const lateMembers = approvedMembers
                        .filter(m => m.late_status)
                        .sort((a, b) => new Date(b.late_updated_at) - new Date(a.late_updated_at));

                    if (isCancelled || (!me && lateMembers.length === 0)) return '';

                    const lateLabels = {
                        'on_my_way': 'On my way',
                        'late_5': '5 mins late',
                        'late_15': '15 mins late',
                        'late_30': '30 mins late'
                    };

                    const now = new Date();
                    const startAt = new Date(event.start_at);
                    const diffMs = now - startAt;
                    const diffMins = diffMs / (1000 * 60);
                    // Open window: -60 min to +120 min
                    const isOpen = diffMins >= -60 && diffMins <= 120;

                    const isGoing = me && me.rsvp === 'going';

                    let disabledReason = '';
                    if (!me) disabledReason = 'You must be approved to send updates.';
                    else if (!isGoing) disabledReason = "You must RSVP 'Going'.";
                    else if (!isOpen) disabledReason = 'Opens 60 mins before swim.';

                    return `
                        <div style="background: rgba(15, 23, 42, 0.4); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 14px;"><i data-lucide="clock" style="width: 14px; height: 14px; vertical-align: middle;"></i> RUNNING LATE?</div>
                                <select onchange="markRunningLate('${event.id}', this.value, this.options[this.selectedIndex].text)" 
                                        ${disabledReason ? 'disabled' : ''}
                                        style="background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 12px; outline: none; cursor: pointer; ${disabledReason ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                    <option value="">${disabledReason || 'Update status...'}</option>
                                    <option value="on_my_way">On my way</option>
                                    <option value="late_5">5 mins late</option>
                                    <option value="late_15">15 mins late</option>
                                    <option value="late_30">30 mins late</option>
                                </select>
                            </div>

                            ${lateMembers.length > 0 ? `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${lateMembers.map(lm => `
                                        <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--ocean-blue); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700;">
                                                    ${lm.profiles?.display_name?.charAt(0) || '?'}
                                                </div>
                                                <span style="font-size: 13px; color: var(--text-primary);">${lm.profiles?.display_name || 'Swimmer'}</span>
                                            </div>
                                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                                <span style="font-size: 12px; font-weight: 700; color: var(--warning);">${lateLabels[lm.late_status]}</span>
                                                <span style="font-size: 10px; color: var(--text-secondary); opacity: 0.7;">${getTimeAgo(new Date(lm.late_updated_at))}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; color: var(--text-secondary); font-size: 12px; padding: 10px; border: 1px dashed rgba(255,255,255,0.05); border-radius: 8px;">No one is running late yet</div>
                            `}
                        </div>
                    `;
                })()}

                <div style="background: rgba(56, 189, 248, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-weight: 600; color: var(--ocean-light); margin-bottom: 12px;"><i data-lucide="users" style="width: 14px; height: 14px; vertical-align: middle;"></i> Participants (${attending}${pending > 0 ? ` + ${pending} pending` : ''})</div>
                    ${(() => {
                        const isParticipant = event.members.some(m => m.user_id === currentUser.id && (m.status === 'approved' || m.status === 'requested'));
                        const visible = event.members.filter(m => m.status === 'approved' || m.status === 'requested');
                        if (visible.length === 0) return '<div style="color: var(--text-secondary); font-size: 13px;">No one has joined yet. Be the first!</div>';
                        return visible.map(m => `
                            <div style="margin-bottom: 10px; background: rgba(0,0,0,0.15); border-radius: 10px; padding: 10px 12px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: ${m.status === 'requested' ? 'var(--warning)' : 'var(--ocean-blue)'}; display: flex; align-items: center; justify-content: center; color: ${m.status === 'requested' ? 'black' : 'white'}; font-weight: 600; flex-shrink: 0;">
                                        ${m.profiles?.avatar_url ? '<i data-lucide="' + m.profiles.avatar_url + '" style="width: 16px; height: 16px;"></i>' : (m.profiles?.display_name?.charAt(0) || '?')}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="color: var(--text-primary); font-size: 14px;">
                                            ${m.profiles?.display_name || 'Anonymous'}
                                            ${m.status === 'requested' ? '<span style="color: var(--warning); font-size: 10px; font-weight: 800; margin-left: 4px; border: 1px solid var(--warning); padding: 1px 4px; border-radius: 4px;">PENDING</span>' : ''}
                                        </div>
                                        ${m.user_id === event.created_by ? '<div style="color: var(--ocean-light); font-size: 12px;">Swim Host</div>' : ''}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 12px;">
                                        ${m.status === 'approved' ? '‚úì Going' : m.status === 'requested' ? '? Interested' : ''}
                                    </div>
                                </div>
                                ${isParticipant && m.profiles?.phone ? `
                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; gap: 12px; flex-wrap: wrap;">
                                        <a href="tel:${m.profiles.phone}" style="color: var(--ocean-light); font-size: 12px; text-decoration: none;">üì± ${m.profiles.phone}</a>
                                        ${m.profiles.emergency_contact_name ? `<span style="color: var(--text-secondary); font-size: 11px;">üö® ICE: ${m.profiles.emergency_contact_name} <a href="tel:${m.profiles.emergency_contact_phone}" style="color: var(--danger); text-decoration: none;">${m.profiles.emergency_contact_phone || ''}</a></span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('');
                    })()}
                </div>
                
                <div id="eventDetailsActions"></div>
            `;

            document.getElementById('eventDetailsContent').innerHTML = html;

            // Render action buttons
            renderEventActions(event);
        }

        function renderEventActions(event) {
            const container = document.getElementById('eventDetailsActions');
            const isCancelled = event.status === 'cancelled';
            let html = '';

            if (isCancelled) {
                html = `
                    <div style="text-align: center; padding: 15px; background: rgba(15, 23, 42, 0.4); border-radius: 12px; border: 1px dashed var(--border); width: 100%;">
                        <div style="color: var(--text-secondary); font-size: 14px;">This swim has been cancelled.</div>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }

            if (event.userStatus === 'approved') {
                html += `
                    <button class="btn" style="background: var(--success);" disabled><i data-lucide="check" style="width: 14px; height: 14px; vertical-align: middle;"></i> You're Going</button>
                    <button class="btn" style="background: transparent; border: 2px solid var(--danger); color: var(--danger); margin-top: 10px;" onclick="leaveEvent('${event.id}')">Cancel RSVP</button>
                `;
            } else if (event.userStatus === 'requested') {
                html += `
                    <div style="background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; padding: 12px; margin-bottom: 12px; text-align: center; width: 100%;">
                        <div style="color: var(--warning); font-weight: 700; font-size: 14px;"><i data-lucide="clock" style="width: 16px; height: 16px; vertical-align: middle;"></i> Approval Requested</div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">The host must approve your request before you can see fixed logistics or group chat links.</div>
                    </div>
                    <button class="btn" style="background: transparent; border: 2px solid var(--danger); color: var(--danger);" onclick="leaveEvent('${event.id}')">Cancel RSVP</button>
                `;
            } else {
                html += `
                    <button class="btn btn-success" onclick="joinEvent('${event.id}', 'going')">Join Swim</button>
                    <button class="btn" style="background: rgba(255,255,255,0.1); margin-top: 10px;" onclick="joinEvent('${event.id}', 'maybe')">Maybe</button>
                `;
            }

            // Creator-only Edit and Cancel buttons
            if (event.created_by === currentUser.id) {
                html += `
                    <div style="display: flex; gap: 8px; margin-top: 10px; width: 100%;">
                        <button class="btn" style="flex: 1; background: var(--ocean-blue);" onclick="editEvent('${event.id}')">
                            <i data-lucide="edit-3" style="width: 14px; height: 14px; vertical-align: middle;"></i> Edit
                        </button>
                        <button class="btn" style="flex: 1; background: transparent; border: 2px solid var(--danger); color: var(--danger);" onclick="cancelSwim('${event.id}')">
                            <i data-lucide="x-circle" style="width: 14px; height: 14px; vertical-align: middle;"></i> Cancel
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
            initIcons();
        }

        async function editEvent(eventId) {
            const event = await loadEventDetails(eventId);
            if (!event) return;

            const html = `
                <div style="margin-bottom: 20px;">
                    <h2 style="font-size: 20px; color: var(--text-primary); margin-bottom: 8px;">Edit Swim</h2>
                    <div style="color: var(--text-secondary); font-size: 13px;">Editing ${event.title}</div>
                </div>

                <div class="form-group">
                    <div class="form-label">Date & Time (SAST)</div>
                    <input type="datetime-local" id="editEventDateTime" value="${(function () {
                    const d = new Date(event.start_at);
                    const pad = (n) => String(n).padStart(2, '0');
                    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                })()}">
                </div>

                <div class="form-group">
                    <div class="form-label">Route Type</div>
                    <select id="editEventRouteType">
                        <option value="loop" ${event.route_type === 'loop' ? 'selected' : ''}>Loop</option>
                        <option value="out_and_back" ${event.route_type === 'out_and_back' ? 'selected' : ''}>Out & back</option>
                        <option value="point_to_point" ${event.route_type === 'point_to_point' ? 'selected' : ''}>Point-to-point</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="form-label">Logistics Note</div>
                    <textarea id="editEventLogistics" placeholder="Lifts, car shuffle, etc...">${event.logistics_note || ''}</textarea>
                </div>

                <div class="form-group">
                    <div class="form-label">External Group Link</div>
                    <input type="url" id="editEventChatUrl" placeholder="WhatsApp link..." value="${event.external_chat_url || ''}">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" style="flex: 1;" onclick="saveEventUpdates('${eventId}')">Save Changes</button>
                    <button class="btn" style="flex: 1; background: rgba(255,255,255,0.1);" onclick="showEventDetails('${eventId}')">Cancel</button>
                </div>
            `;

            document.getElementById('eventDetailsContent').innerHTML = html;
            document.getElementById('eventDetailsActions').innerHTML = '';
        }

        async function saveEventUpdates(eventId) {
            try {
                const startAt = document.getElementById('editEventDateTime').value + ':00+02:00';
                const routeType = document.getElementById('editEventRouteType').value;
                const logistics = document.getElementById('editEventLogistics').value;
                const chatUrl = document.getElementById('editEventChatUrl').value;

                const { error } = await supabaseClient
                    .from('swim_events')
                    .update({
                        start_at: startAt,
                        route_type: routeType,
                        logistics_note: logistics,
                        external_chat_url: chatUrl,
                        updated_at: new Date().toISOString(),
                        updated_by: currentUser.id
                    })
                    .eq('id', eventId);

                if (error) throw error;

                showToast('Swim details updated!', 'success');
                await showEventDetails(eventId);
                loadEvents();
                loadDashboard();
            } catch (err) {
                console.error('Error updating swim:', err);
                alert('Error updating swim: ' + err.message);
            }
        }

        async function joinEvent(eventId, action) {
            try {
                // Safety gate: require phone + emergency contact for join/confirm
                if (action !== 'maybe') {
                    const safe = await checkSafetyInfo();
                    if (!safe) return;
                }

                console.log('Joining/Confirming event:', eventId, 'with action:', action);

                // 1. Get event details to check for approval requirement
                const { data: event, error: eventError } = await supabaseClient
                    .from('swim_events')
                    .select('requires_approval')
                    .eq('id', eventId)
                    .single();

                if (eventError) throw eventError;

                // 2. Determine status
                // Rule: If requires_approval = true, Join/Maybe/Confirm -> 'requested'
                // Rule: If requires_approval = false, Join/Confirm -> 'approved'
                // Rule: Maybe is always 'requested' if we can't distinguish it without rsvp column? 
                // Actually, the prompt says "Join/Maybe/Confirm must create/update swim_participants.status = 'requested'" if requires_approval is true.
                // If requires_approval is false, Join/Confirm can set 'approved' immediately.
                let status = 'requested';
                if (!event.requires_approval && action !== 'maybe') {
                    status = 'approved';
                }

                // 3. Upsert into swim_participants
                // Rule: Leaving then re-joining should reset late_* columns to NULL.
                const { error } = await supabaseClient
                    .from('swim_participants')
                    .upsert({
                        swim_event_id: eventId,
                        user_id: currentUser.id,
                        status: status,
                        late_status: null,
                        late_updated_at: null,
                        late_last_notified_at: null
                    }, { onConflict: 'swim_event_id,user_id' });

                if (error) throw error;

                console.log('Successfully updated participation in event:', eventId, 'to status:', status);

                // FORCE refresh event details modal if it's open
                const modal = document.getElementById('eventDetailsModal');
                if (modal && modal.style.display === 'block') {
                    await showEventDetails(eventId);
                }

                showToast(status === 'requested' ? "Request sent to host!" : "You're in!", 'success');

                loadEvents(); // Refresh list
                loadDashboard(); // Refresh dashboard
            } catch (err) {
                console.error('Error joining event:', err);
                alert('Error joining event: ' + err.message);
            }
        }

        async function leaveEvent(eventId) {
            if (!confirm('Cancel your RSVP for this swim?')) return;

            try {
                // Rule: "Cancel RSVP" should set status='left' (do not delete row).
                // 1. Fetch event details for notification
                const { data: eventData } = await supabaseClient
                    .from('swim_events')
                    .select('created_by, title, location_name, start_time')
                    .eq('id', eventId)
                    .single();

                // 2. Update status
                const { error } = await supabaseClient
                    .from('swim_participants')
                    .update({ status: 'left' })
                    .eq('swim_event_id', eventId)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                showToast('RSVP cancelled', 'info');

                // 3. Notify Creator
                if (eventData && eventData.created_by && eventData.created_by !== currentUser.id) {
                    const displayName = currentUser.user_metadata?.display_name || 'A swimmer';
                    const eventTitle = eventData.title || eventData.location_name;
                    const startTime = new Date(eventData.start_time).toLocaleString(undefined, {
                        weekday: 'short', hour: 'numeric', minute: '2-digit'
                    });

                    await notify(
                        eventData.created_by,
                        eventId,
                        'rsvp_cancelled',
                        'RSVP Cancelled',
                        `${displayName} cancelled their RSVP for ${eventTitle} (${startTime})`,
                        { swim_event_id: eventId, actor_user_id: currentUser.id, action: 'cancel_rsvp' }
                    );
                }

                // Refresh event details modal if it's open
                const modal = document.getElementById('eventDetailsModal');
                if (modal && modal.style.display === 'block') {
                    await showEventDetails(eventId); // Refresh the modal
                }

                loadEvents(); // Refresh events list
                loadDashboard(); // Refresh dashboard
            } catch (err) {
                alert('Error cancelling RSVP: ' + err.message);
            }
        }

        // Mark user as running late
        async function markRunningLate(eventId, status, label) {
            if (!status) return;

            try {
                // 1. Get current member record
                const { data: member, error: memberError } = await supabaseClient
                    .from('swim_participants')
                    .select('*, profiles(display_name)')
                    .eq('swim_event_id', eventId)
                    .eq('user_id', currentUser.id)
                    .single();

                if (memberError || !member) {
                    showToast("You must RSVP 'Going' before using Running Late.", 'error');
                    return;
                }

                // Strict check: Status must be approved AND RSVP must be 'going'
                if (member.status !== 'approved' || member.rsvp !== 'going') {
                    showToast("You must RSVP 'Going' before using Running Late.", 'error');
                    return;
                }

                // Time Gating: 1 hour before to 2 hours after start_at
                const { data: eventData } = await supabaseClient
                    .from('swim_events')
                    .select('start_at')
                    .eq('id', eventId)
                    .single();

                if (eventData) {
                    const startAt = new Date(eventData.start_at);
                    const now = new Date();
                    const diffMs = now - startAt;
                    const diffMins = diffMs / (1000 * 60);

                    // -60 mins to +120 mins
                    if (diffMins < -60 || diffMins > 120) {
                        showToast("Running Late updates are only available near swim time.", 'error');
                        return;
                    }
                }

                // 2. Throttling logic
                const severity = {
                    'on_my_way': 1,
                    'late_5': 2,
                    'late_15': 3,
                    'late_30': 4
                };

                const lastNotified = member.late_last_notified_at ? new Date(member.late_last_notified_at) : null;
                const now = new Date();
                const diffMins = lastNotified ? (now - lastNotified) / 60000 : 999;

                const oldSeverity = severity[member.late_status] || 0;
                const newSeverity = severity[status] || 0;

                let shouldNotify = false;
                if (diffMins > 5) {
                    shouldNotify = true;
                } else if (newSeverity > oldSeverity) {
                    shouldNotify = true;
                }

                // 3. Update participant record
                const updateData = {
                    late_status: status,
                    late_updated_at: now.toISOString()
                };

                if (shouldNotify) {
                    updateData.late_last_notified_at = now.toISOString();
                }

                const { error: updateError } = await supabaseClient
                    .from('swim_participants')
                    .update(updateData)
                    .eq('id', member.id);

                if (updateError) throw updateError;

                // 4. Send notifications if needed
                if (shouldNotify) {
                    // Get event details
                    const { data: event } = await supabaseClient
                        .from('swim_events')
                        .select('title, location_name')
                        .eq('id', eventId)
                        .single();

                    // Get other approved participants
                    const { data: others } = await supabaseClient
                        .from('swim_participants')
                        .select('user_id')
                        .eq('swim_event_id', eventId)
                        .eq('status', 'approved')
                        .neq('user_id', currentUser.id);

                    if (others && others.length > 0) {
                        const displayName = member.profiles?.display_name || 'A swimmer';
                        const swimName = event.title || event.location_name;

                        // Extract minutes from label/status for payload
                        let minutes = 0;
                        if (status === 'late_5') minutes = 5;
                        else if (status === 'late_15') minutes = 15;
                        else if (status === 'late_30') minutes = 30;

                        for (const o of others) {
                            await notify(
                                o.user_id,
                                eventId,
                                'participant_late',
                                'Running late',
                                `${displayName} is running late (${label}) for ${swimName}`,
                                {
                                    swim_event_id: eventId,
                                    actor_user_id: currentUser.id,
                                    late_status: status,
                                    minutes: minutes
                                }
                            );
                        }
                    }
                }

                showToast(shouldNotify ? `Status updated and group notified: ${label}` : `Status updated: ${label}`, 'success');

                // Refresh detail and dashboard
                await viewEventDetails(eventId);
                loadDashboard();

            } catch (err) {
                console.error('Error marking late:', err);
                alert('Error updating late status: ' + err.message);
            }
        }

        async function cancelSwim(eventId) {
            if (!confirm("Are you sure you want to cancel this swim? This will notify all participants.")) return;

            try {
                // 1. Get event details and participants first
                const { data: event } = await supabaseClient
                    .from('swim_events')
                    .select('title, start_at, location_name')
                    .eq('id', eventId)
                    .single();

                const { data: participants } = await supabaseClient
                    .from('swim_participants')
                    .select('user_id')
                    .eq('swim_event_id', eventId)
                    .in('status', ['approved', 'requested']);

                // 2. Update status to cancelled
                const { error: cancelError } = await supabaseClient
                    .from('swim_events')
                    .update({ status: 'cancelled' })
                    .eq('id', eventId);

                if (cancelError) throw cancelError;

                // 3. Create notifications for all participants (except creator)
                if (participants && participants.length > 0) {
                    const eventDate = new Date(event.start_at).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) + ' on ' + new Date(event.start_at).toLocaleDateString('en-US', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short'
                    });

                    const swimTitle = event.title || event.location_name;
                    const message = `The swim "${swimTitle}" at ${eventDate} has been cancelled by the host.`;

                    for (const p of participants) {
                        if (p.user_id !== currentUser.id) {
                            await notify(
                                p.user_id,
                                eventId,
                                'swim_cancelled',
                                'Swim cancelled',
                                message,
                                { swim_event_id: eventId, status: 'cancelled' }
                            );
                        }
                    }
                }

                showToast('Swim cancelled and participants notified.', 'success');
                await viewEventDetails(eventId);
                loadEvents();
                loadDashboard();

            } catch (err) {
                console.error('Error cancelling swim:', err);
                alert('Error cancelling swim: ' + err.message);
            }
        }

        function showToast(message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--ocean-blue)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: 600;
                z-index: 10000;
                animation: slideUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========== PROFILE SETTINGS ==========

        // Global to store profile being edited
        let editingProfile = null;
        // Avatar options (ocean-themed Lucide icons)
        const AVATARS = [
            { icon: 'anchor', color: '#3b82f6', name: 'Anchor' },
            { icon: 'waves', color: '#06b6d4', name: 'Waves' },
            { icon: 'compass', color: '#10b981', name: 'Compass' },
            { icon: 'ship', color: '#f59e0b', name: 'Ship' },
            { icon: 'sailboat', color: '#ef4444', name: 'Sailboat' },
            { icon: 'fish', color: '#8b5cf6', name: 'Fish' },
            { icon: 'droplets', color: '#ec4899', name: 'Droplets' },
            { icon: 'gem', color: '#14b8a6', name: 'Gem' },
            { icon: 'zap', color: '#6366f1', name: 'Lightning' },
            { icon: 'flame', color: '#f97316', name: 'Flame' },
            { icon: 'star', color: '#84cc16', name: 'Star' },
            { icon: 'trophy', color: '#06b6d4', name: 'Trophy' },
            { icon: 'shield', color: '#0ea5e9', name: 'Shield' },
            { icon: 'target', color: '#22c55e', name: 'Target' },
            { icon: 'award', color: '#a855f7', name: 'Award' },
            { icon: 'crown', color: '#f43f5e', name: 'Crown' }
        ];



        // Helper to update the header profile icon
        function updateHeaderAvatar(iconName = 'user') {
            const avatarDiv = document.querySelector('.user-avatar');
            if (avatarDiv) {
                const iconToUse = iconName || 'user';
                avatarDiv.innerHTML = `<i data-lucide="${iconToUse}" style="width: 18px; height: 18px; color: white;"></i>`;
                // Set the avatar background to the icon's color
                const avatarMeta = AVATARS.find(a => a.icon === iconToUse);
                if (avatarMeta) {
                    avatarDiv.style.background = avatarMeta.color;
                    avatarDiv.style.borderColor = avatarMeta.color;
                } else {
                    avatarDiv.style.background = 'linear-gradient(135deg, var(--ocean-blue) 0%, var(--ocean-dark) 100%)';
                    avatarDiv.style.borderColor = 'var(--ocean-light)';
                }
                if (window.lucide) lucide.createIcons();
            }
        }

        async function showProfileSettings() {
            // Instant open
            console.log('OPEN_PROFILE');
            document.getElementById('profileModal').style.display = 'block';
            document.getElementById('profileEmail').textContent = currentUser.email;

            // Load current profile
            try {
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (profile) {
                    editingProfile = profile;
                    selectedAvatar = profile.avatar_url;
                    updateHeaderAvatar(profile.avatar_url);

                    document.getElementById('profileDisplayName').value = profile.display_name || '';
                    document.getElementById('profilePhone').value = profile.phone || '';
                    document.getElementById('profileEmergencyName').value = profile.emergency_contact_name || '';
                    document.getElementById('profileEmergencyPhone').value = profile.emergency_contact_phone || '';
                    document.getElementById('profileHomeBeach').value = profile.home_beach_id || '';
                    document.getElementById('profilePreferredSuit').value = profile.preferred_suit || 'both';
                    document.getElementById('profileColdTolerance').value = profile.cold_tolerance_min_c || '';

                    // Times
                    if (profile.pool_1km_time_seconds) {
                        const mins = Math.floor(profile.pool_1km_time_seconds / 60);
                        const secs = profile.pool_1km_time_seconds % 60;
                        document.getElementById('profilePoolTime').value = `${mins}:${secs.toString().padStart(2, '0')}`;
                    } else {
                        document.getElementById('profilePoolTime').value = '';
                    }

                    if (profile.ocean_1km_time_seconds) {
                        const mins = Math.floor(profile.ocean_1km_time_seconds / 60);
                        const secs = profile.ocean_1km_time_seconds % 60;
                        document.getElementById('profileOceanTime').value = `${mins}:${secs.toString().padStart(2, '0')}`;
                    } else {
                        document.getElementById('profileOceanTime').value = '';
                    }
                }

                renderAvatarGrid();
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }

        function renderAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            if (!grid) return;
            grid.innerHTML = '';

            AVATARS.forEach(avatar => {
                const div = document.createElement('div');
                const isSelected = selectedAvatar === avatar.icon;
                div.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 18px;
                    border-radius: 14px;
                    background: ${avatar.color};
                    opacity: ${isSelected ? '1' : '0.75'};
                    border: 3px solid ${isSelected ? 'white' : 'transparent'};
                    transition: all 0.2s;
                    box-shadow: ${isSelected ? '0 6px 16px rgba(0,0,0,0.35)' : '0 2px 8px rgba(0,0,0,0.15)'};
                    transform: ${isSelected ? 'scale(1.05)' : 'scale(1)'};
                `;
                div.innerHTML = `<i data-lucide="${avatar.icon}" style="width: 28px; height: 28px; color: white;"></i>`;
                div.title = avatar.name;
                div.onmouseenter = () => {
                    if (!isSelected) {
                        div.style.opacity = '0.9';
                        div.style.transform = 'scale(1.05)';
                    }
                };
                div.onmouseleave = () => {
                    if (!isSelected) {
                        div.style.opacity = '0.75';
                        div.style.transform = 'scale(1)';
                    }
                };
                div.onclick = () => {
                    selectedAvatar = avatar.icon;
                    renderAvatarGrid();
                };
                grid.appendChild(div);
            });
            initIcons(); // Re-initialize Lucide icons
        }

        function hideProfileSettings() {
            document.getElementById('profileModal').style.display = 'none';
        }

        async function saveProfile() {
            const displayName = document.getElementById('profileDisplayName').value;
            const phone = document.getElementById('profilePhone').value.trim();
            const emergencyName = document.getElementById('profileEmergencyName').value.trim();
            const emergencyPhone = document.getElementById('profileEmergencyPhone').value.trim();
            const homeBeachId = document.getElementById('profileHomeBeach').value;
            const preferredSuit = document.getElementById('profilePreferredSuit').value;
            const coldTolerance = document.getElementById('profileColdTolerance').value;
            const poolTimeStr = document.getElementById('profilePoolTime').value;
            const oceanTimeStr = document.getElementById('profileOceanTime').value;

            if (!displayName) {
                alert('Please enter a display name');
                return;
            }

            // Helper: mm:ss OR raw seconds to integer seconds (Tolerant)
            const mmssToSeconds = (val) => {
                if (!val) return null;
                const s = String(val).trim();
                if (!s) return null;

                // Normalize separators: dots, spaces, semicolons -> colon
                const normalized = s.replace(/[.;\s]+/g, ':');

                // If digits only
                if (/^\d+$/.test(normalized)) return parseInt(normalized, 10);

                // If mm:ss
                const parts = normalized.split(':');
                if (parts.length === 2) {
                    const m = parseInt(parts[0], 10) || 0;
                    const sc = parseInt(parts[1], 10) || 0;
                    // Basic validation: seconds should be < 60
                    if (sc >= 60) return null;
                    return m * 60 + sc;
                }
                return null;
            };

            // Derive Tier
            const poolTierFromSeconds = (poolSec) => {
                if (poolSec == null) return "unsure";
                if (poolSec < 870) return "fast";      // Fast (< 1:27/100m)
                if (poolSec <= 989) return "steady";   // Steady (1:27-1:38/100m)
                if (poolSec <= 1140) return "social"; // Social (1:39-1:54/100m)
                return "developing";                      // Developing (> 1:54/100m)
            };

            const poolSeconds = mmssToSeconds(poolTimeStr);
            const oceanSeconds = mmssToSeconds(oceanTimeStr);
            const experienceLevel = poolTierFromSeconds(poolSeconds);

            const payload = {
                display_name: displayName,
                phone: phone || null,
                emergency_contact_name: emergencyName || null,
                emergency_contact_phone: emergencyPhone || null,
                home_beach_id: homeBeachId || null,
                preferred_suit: preferredSuit,
                cold_tolerance_min_c: coldTolerance ? parseFloat(coldTolerance) : null,
                pool_1km_time_seconds: poolSeconds,
                ocean_1km_time_seconds: oceanSeconds,
                experience_level: experienceLevel,
                avatar_url: selectedAvatar
            };

            // Onboarding check
            if (editingProfile && !editingProfile.onboarding_completed_at) {
                payload.onboarding_completed_at = new Date().toISOString();
            }

            // Final guard: never write null/empty experience_level
            if (!payload.experience_level) {
                payload.experience_level = "unsure";
            }

            console.log("PROFILE SAVE PAYLOAD", payload);

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update(payload)
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Success!
                updateHeaderAvatar(selectedAvatar);

                showToast('Profile updated!', 'success');
                hideProfileSettings();
                loadDashboard();
            } catch (err) {
                console.error('Error saving profile:', err);
                alert('Error saving profile: ' + err.message);
            }
        }

        // ===== ONBOARDING FUNCTIONS =====

        function showOnboardingLegal() {
            document.getElementById('onboardingLegal').style.display = 'block';
            document.getElementById('onboardingPersonal').style.display = 'none';
            setTimeout(() => initIcons(), 100);
        }

        function showOnboardingPersonal() {
            document.getElementById('onboardingLegal').style.display = 'none';
            document.getElementById('onboardingPersonal').style.display = 'block';
            setTimeout(() => initIcons(), 100);
        }

        function checkOnboardingBoxes() {
            const terms = document.getElementById('obTerms').checked;
            const privacy = document.getElementById('obPrivacy').checked;
            const waiver = document.getElementById('obWaiver').checked;
            const data = document.getElementById('obData').checked;

            const btn = document.getElementById('obAcceptBtn');
            const allChecked = terms && privacy && waiver && data;
            btn.disabled = !allChecked;
            btn.style.opacity = allChecked ? '1' : '0.5';
            btn.style.cursor = allChecked ? 'pointer' : 'not-allowed';
        }

        // Consent document content (embedded for file:// compatibility)
        const consentDocuments = {
            terms: {
                title: 'Terms of Service',
                content: `
<h4 style="color: #38bdf8; margin-bottom: 12px;">SwimLoading Terms of Service</h4>
<p><strong>Effective Date:</strong> January 2025</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">1. Acceptance of Terms</h4>
<p>By accessing or using SwimLoading ("the App"), you agree to be bound by these Terms of Service. If you do not agree, do not use the App.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">2. Description of Service</h4>
<p>SwimLoading is a community platform for open water swimmers to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Log and share water temperature readings</li>
<li>View swim conditions at various spots</li>
<li>Connect with the local swimming community</li>
<li>Track swimming activities</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">3. User Responsibilities</h4>
<p>You agree to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Provide accurate information when logging temperatures and conditions</li>
<li>Not misuse the service or attempt to harm other users</li>
<li>Respect the community and other swimmers</li>
<li>Keep your account credentials secure</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">4. Safety Disclaimer</h4>
<p>SwimLoading provides information for convenience only. <strong>You are solely responsible for assessing conditions and your own safety.</strong> Never rely solely on app data for safety decisions.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">5. Intellectual Property</h4>
<p>The App and its content are owned by SwimLoading. User-submitted data (temperatures, conditions) may be used to improve the service and shared with the community.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">6. Termination</h4>
<p>We may suspend or terminate accounts that violate these terms or for any reason at our discretion.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">7. Changes to Terms</h4>
<p>We may update these terms at any time. Continued use constitutes acceptance of changes.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">8. Governing Law</h4>
<p>These terms are governed by the laws of South Africa.</p>
`
            },
            privacy: {
                title: 'Privacy Policy (POPIA Compliant)',
                content: `
<h4 style="color: #38bdf8; margin-bottom: 12px;">SwimLoading Privacy Policy</h4>
<p><strong>Effective Date:</strong> January 2025</p>
<p>This policy complies with the Protection of Personal Information Act (POPIA) of South Africa.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">1. Information We Collect</h4>
<p><strong>Account Information:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>Email address</li>
<li>Full name</li>
<li>Phone number (for emergency contact)</li>
<li>Date of birth</li>
<li>Physical address</li>
</ul>

<p><strong>Usage Data:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>Temperature logs you submit</li>
<li>GPS coordinates (when you grant permission)</li>
<li>Swim check-ins and activities</li>
<li>App usage patterns</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">2. How We Use Your Information</h4>
<ul style="margin: 8px 0 8px 20px;">
<li>To provide and improve the SwimLoading service</li>
<li>To display community temperature data</li>
<li>For safety features (check-in/check-out, emergency contacts)</li>
<li>To communicate important updates</li>
<li>For anonymized research to improve ocean safety</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">3. Data Sharing</h4>
<p>We may share data with:</p>
<ul style="margin: 8px 0 8px 20px;">
<li><strong>Other users:</strong> Your temperature logs and swim spot data (not personal details)</li>
<li><strong>Emergency services:</strong> If you fail to check out from a swim</li>
<li><strong>Research partners:</strong> Anonymized data only, for ocean safety research</li>
</ul>
<p>We do <strong>not</strong> sell your personal information.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">4. Your POPIA Rights</h4>
<p>Under POPIA, you have the right to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Access your personal information</li>
<li>Correct inaccurate information</li>
<li>Request deletion of your data</li>
<li>Object to processing</li>
<li>Withdraw consent</li>
</ul>
<p>To exercise these rights, contact us at privacy@swimloading.com</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">5. Data Security</h4>
<p>We use industry-standard security measures to protect your data, including encryption in transit and at rest.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">6. Data Retention</h4>
<p>We retain your data for as long as your account is active. You may request deletion at any time.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">7. Information Officer</h4>
<p>SwimLoading's Information Officer can be contacted at: privacy@swimloading.com</p>
`
            },
            waiver: {
                title: 'Liability Waiver',
                content: `
<h4 style="color: #ef4444; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i> LIABILITY WAIVER AND ASSUMPTION OF RISK
                    </h4>
<p><strong>PLEASE READ CAREFULLY BEFORE ACCEPTING</strong></p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">ACKNOWLEDGMENT OF RISKS</h4>
<p>I understand and acknowledge that <strong>open water swimming is an inherently dangerous activity</strong> that involves serious risks including but not limited to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Drowning and death</li>
<li>Hypothermia and cold water shock</li>
<li>Cardiac events</li>
<li>Marine life encounters (sharks, jellyfish, etc.)</li>
<li>Strong currents, waves, and changing conditions</li>
<li>Boat traffic and watercraft collisions</li>
<li>Physical injury or permanent disability</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">VOLUNTARY PARTICIPATION</h4>
<p>I voluntarily choose to participate in open water swimming activities. I understand that SwimLoading is an information platform only and <strong>does not supervise, organize, or control any swimming activities</strong>.</p>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">RELEASE OF LIABILITY</h4>
<p>In consideration of being allowed to use SwimLoading, I hereby:</p>
<ol style="margin: 8px 0 8px 20px;">
<li><strong>RELEASE AND DISCHARGE</strong> SwimLoading, its owners, operators, employees, and affiliates from any and all liability, claims, demands, or causes of action that may arise from my use of the app or participation in open water swimming.</li>
<li><strong>WAIVE</strong> any claims I may have against SwimLoading for injury, death, or property damage.</li>
<li><strong>ASSUME ALL RISKS</strong> associated with open water swimming, whether known or unknown.</li>
</ol>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">DATA ACCURACY DISCLAIMER</h4>
<p>I understand that:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Temperature and condition data is user-submitted and may be <strong>inaccurate</strong></li>
<li>Conditions can change rapidly and without warning</li>
<li>I must <strong>independently verify all conditions</strong> before swimming</li>
<li>SwimLoading makes <strong>no guarantees</strong> about data accuracy</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">INDEMNIFICATION</h4>
<p>I agree to indemnify and hold harmless SwimLoading from any claims, damages, or expenses arising from my swimming activities or use of the app.</p>

<h4 style="color: #ef4444; margin: 16px 0 8px 0; display: flex; align-items: center; gap: 8px;">
    <i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i> BY ACCEPTING, I CONFIRM THAT:
</h4>
<ul style="margin: 8px 0 8px 20px;">
<li>I have read and understood this waiver</li>
<li>I am at least 18 years old (or have parental consent)</li>
<li>I accept full responsibility for my safety</li>
<li>I am physically fit to participate in open water swimming</li>
</ul>
`
            },
            data: {
                title: 'Data Collection Consent',
                content: `
<h4 style="color: #38bdf8; margin-bottom: 12px;">Data Collection Consent</h4>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">Purpose of Data Collection</h4>
<p>SwimLoading collects data to:</p>
<ul style="margin: 8px 0 8px 20px;">
<li>Build a community resource of ocean conditions</li>
<li>Improve safety for open water swimmers</li>
<li>Enable features like check-in/check-out safety systems</li>
<li>Support research into ocean swimming safety</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">What Data We Collect</h4>
<p><strong>Location Data:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>GPS coordinates when you log temperatures</li>
<li>Location during check-in/check-out</li>
<li>This helps verify spot accuracy and enables safety features</li>
</ul>

<p><strong>Activity Data:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>Temperature readings you submit</li>
<li>Conditions and hazards you report</li>
<li>Your swim activities and check-ins</li>
</ul>

<p><strong>Personal Data:</strong></p>
<ul style="margin: 8px 0 8px 20px;">
<li>Contact information for safety features</li>
<li>Emergency contact details</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">How We Use This Data</h4>
<ol style="margin: 8px 0 8px 20px;">
<li><strong>Community Features:</strong> Sharing temperature and condition data with other swimmers</li>
<li><strong>Safety:</strong> Alerting emergency contacts if you don't check out</li>
<li><strong>Improvement:</strong> Making the app better based on usage patterns</li>
<li><strong>Research:</strong> Anonymized data may be used for ocean safety research</li>
</ol>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">Your Control Over Your Data</h4>
<ul style="margin: 8px 0 8px 20px;">
<li>You can disable GPS permissions in your device settings</li>
<li>You can request a copy of your data at any time</li>
<li>You can request deletion of your account and data</li>
<li>Temperature logs may be retained anonymously for community benefit</li>
</ul>

<h4 style="color: #f8fafc; margin: 16px 0 8px 0;">Third-Party Sharing</h4>
<p>Your data may be shared with:</p>
<ul style="margin: 8px 0 8px 20px;">
<li><strong>Other users:</strong> Temperature logs (with optional anonymity)</li>
<li><strong>Emergency services:</strong> Only when safety features are triggered</li>
<li><strong>Insurance partners:</strong> Only with your explicit additional consent</li>
</ul>

<h4 style="color: #38bdf8; margin: 16px 0 8px 0;">By accepting, you consent to:</h4>
<ul style="margin: 8px 0 8px 20px;">
<li>Collection of the data described above</li>
<li>Use of this data for the stated purposes</li>
<li>Sharing as described in this policy</li>
</ul>
`
            }
        };

        function openConsentModal(docType) {
            const doc = consentDocuments[docType];
            if (!doc) return;

            document.getElementById('consentModalTitle').textContent = doc.title;
            document.getElementById('consentModalBody').innerHTML = doc.content;

            const modal = document.getElementById('consentModal');
            modal.style.display = 'flex';
        }

        function closeConsentModal() {
            document.getElementById('consentModal').style.display = 'none';
        }

        // ESC key to close modal
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeConsentModal();
            }
        });

        // Click outside modal to close
        document.getElementById('consentModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeConsentModal();
            }
        });

        async function acceptOnboardingLegal() {
            try {
                const now = new Date().toISOString();

                // Check if profile exists
                const { data: existing } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .update({
                            terms_accepted_at: now,
                            privacy_accepted_at: now,
                            waiver_accepted_at: now,
                            data_consent_at: now
                        })
                        .eq('id', currentUser.id);

                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .insert({
                            id: currentUser.id,
                            display_name: currentUser.email.split('@')[0],
                            terms_accepted_at: now,
                            privacy_accepted_at: now,
                            waiver_accepted_at: now,
                            data_consent_at: now,
                            experience_level: 'unsure' // Canonical default to satisfy constraint
                        });

                    if (error) throw error;
                }

                showOnboardingPersonal();
            } catch (err) {
                console.error('Error accepting legal:', err);
                alert('Error: ' + err.message);
            }
        }

        async function saveOnboardingPersonal() {
            const fullName = document.getElementById('obFullName').value.trim();
            const phone = document.getElementById('obPhone').value.trim();
            const dob = document.getElementById('obDOB').value;
            const address = document.getElementById('obAddress').value.trim();
            const city = document.getElementById('obCity').value.trim();
            const postal = document.getElementById('obPostal').value.trim();

            if (!fullName || !phone || !dob || !address || !city || !postal) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        phone: phone,
                        date_of_birth: dob,
                        address_line1: address,
                        city: city,
                        postal_code: postal,
                        onboarding_completed_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Hide onboarding, show main app
                document.getElementById('onboardingLegal').style.display = 'none';
                document.getElementById('onboardingPersonal').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';

                await loadSpots();
                await loadDashboard();
                initIcons();
            } catch (err) {
                console.error('Error saving personal details:', err);
                alert('Error: ' + err.message);
            }
        }

        // ===== END ONBOARDING =====

        // GPS State
        let currentGpsLocation = null;

        // Get current GPS location
        async function getCurrentLocation() {
            const btn = document.getElementById('gpsButton');
            const status = document.getElementById('gpsStatus');

            if (!navigator.geolocation) {
                alert('GPS not supported on this device');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" style="width: 14px; height: 14px; animation: spin 1s linear infinite;"></i> Getting location...';
            status.textContent = 'Detecting...';
            status.style.color = 'var(--warning)';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    currentGpsLocation = { lat, lng };

                    // Find nearest spot
                    const nearest = findNearestSpot(lat, lng);

                    if (nearest) {
                        // Store suggested ID
                        gpsSuggestedSpotId = nearest.spot.id;

                        // Select the nearest spot in dropdown ONLY if not locked
                        if (!selectedSpotLocked) {
                            const select = document.querySelector('#logTemp select[data-spots]');
                            if (select) select.value = nearest.spot.id;
                        }

                        status.innerHTML = `üìç ${nearest.spot.name} (${nearest.distance.toFixed(1)}km away)`;
                        status.style.color = 'var(--success)';
                    } else {
                        status.textContent = `üìç ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                        status.style.color = 'var(--ocean-light)';
                    }

                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="map-pin" style="width: 14px; height: 14px;"></i> Update Location';
                    initIcons();
                },
                (error) => {
                    console.error('GPS error:', error);
                    status.textContent = 'Location access denied';
                    status.style.color = 'var(--danger)';
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="map-pin" style="width: 14px; height: 14px;"></i> Use My Location';
                    initIcons();

                    if (error.code === 1) {
                        alert('Please allow location access to use GPS');
                    }
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // Calculate distance between two points (Haversine formula)
        function getDistanceKm(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Find nearest spot to GPS coordinates
        function findNearestSpot(lat, lng) {
            if (!spots || spots.length === 0) return null;

            let nearest = null;
            let minDistance = Infinity;

            for (const spot of spots) {
                const distance = getDistanceKm(lat, lng, spot.latitude, spot.longitude);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = { spot, distance };
                }
            }

            // Only return if within 10km (reasonable for Cape Town spots)
            return minDistance <= 10 ? nearest : null;
        }

        // Submit temperature log
        async function submitTempLog() {
            const spotId = document.querySelector('#logTemp select[data-spots]').value;
            const temp = parseFloat(document.getElementById('tempValue').textContent);
            const conditionsRaw = document.querySelector('#logTemp .toggle-btn.active')?.textContent.trim() || 'Calm';

            // Remove emojis and extract just the word (calm, choppy, rough, extreme)
            const conditions = conditionsRaw.replace(/[^\w\s]/g, '').trim().toLowerCase();

            // Get selected hazards and remove emojis
            const hazards = Array.from(document.querySelectorAll('#logTemp .toggle-group:last-of-type .toggle-btn.active'))
                .map(btn => btn.textContent.replace(/[^\w\s]/g, '').trim().toLowerCase());

            const notes = document.querySelector('#logTemp textarea').value;

            // ‚õî Duplicate check: prevent logging same spot within 1 hour
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
            const { data: recentLogs } = await supabaseClient
                .from('temp_logs')
                .select('id, created_at')
                .eq('user_id', currentUser.id)
                .eq('spot_id', spotId)
                .gte('created_at', oneHourAgo)
                .limit(1);

            if (recentLogs && recentLogs.length > 0) {
                const logTime = new Date(recentLogs[0].created_at);
                const minsAgo = Math.round((Date.now() - logTime) / 60000);
                const minsLeft = 60 - minsAgo;
                showToast(`You already logged this spot ${minsAgo} min ago. Try again in ${minsLeft} min.`, 'error');
                return;
            }

            // Determine location source
            let locationSource = 'fallback';
            if (selectedSpotLocked) {
                locationSource = 'manual';
            } else if (currentGpsLocation) {
                locationSource = 'gps';
            }

            // Build insert object
            const logData = {
                user_id: currentUser.id,
                spot_id: spotId,
                temp_c: temp,
                conditions: conditions,
                hazards: hazards,
                notes: notes,
                location_source: locationSource,
                gps_spot_id: gpsSuggestedSpotId
            };

            // Add GPS coordinates if available (for future custom spots feature)
            // Note: Could store in notes or a separate field later
            if (currentGpsLocation) {
                logData.lat = currentGpsLocation.lat;
                logData.lng = currentGpsLocation.lng;
                logData.notes = (notes ? notes + '\n' : '') +
                    `[GPS: ${currentGpsLocation.lat.toFixed(5)}, ${currentGpsLocation.lng.toFixed(5)}]`;
            }

            const { data, error } = await supabaseClient
                .from('temp_logs')
                .insert(logData);

            if (error) {
                alert('Error logging temperature: ' + error.message);
                console.error(error);
            } else {
                showToast('Temperature logged successfully! +10 points!', 'success');

                // Reset GPS and Lock state
                selectedSpotLocked = false;
                gpsSuggestedSpotId = null;
                currentGpsLocation = null;
                const status = document.getElementById('gpsStatus');
                if (status) status.textContent = '';

                // Switch to dashboard
                showPage('dashboard');
                await loadDashboard();
                await loadLeaderboard(); // Refresh leaderboard to show new points
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', checkAuth);
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --ocean-blue: #0284c7;
            --ocean-dark: #0c4a6e;
            --ocean-light: #38bdf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --elite-red: #dc2626;
            --bg-dark: #0a1628;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: rgba(56, 189, 248, 0.2);
            --modal-bg: rgba(15, 23, 42, 0.98);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(circle at 20% 80%, rgba(2, 132, 199, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(56, 189, 248, 0.08) 0%, transparent 50%);
            animation: pulse 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.3;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.5;
            }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            padding: 20px;
        }

        /* Auth Screen */
        #authScreen {
            display: none;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-card {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(30px);
            border-radius: 28px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(56, 189, 248, 0.15);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 40px rgba(56, 189, 248, 0.05);
            animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-logo h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .auth-logo p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: rgba(15, 23, 42, 0.6);
            padding: 4px;
            border-radius: 12px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--ocean-blue);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(56, 189, 248, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s;
            outline: none;
        }

        input:focus {
            border-color: var(--ocean-light);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1), 0 0 20px rgba(56, 189, 248, 0.08);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--ocean-blue) 0%, var(--ocean-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(2, 132, 199, 0.4);
        }

        .btn:active {
            transform: translateY(0px) scale(0.98);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        #mainApp {
            display: none;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(56, 189, 248, 0.1);
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 20%;
            right: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--ocean-light), transparent);
            opacity: 0.4;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--ocean-light) 0%, #0ea5e9 50%, var(--ocean-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--ocean-blue) 0%, var(--ocean-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid var(--ocean-light);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(2, 132, 199, 0.2);
            position: relative;
            z-index: 200;
            pointer-events: auto;
            /* Ensure it is above any headers or overlays */
        }

        .nav-tabs {
            display: inline-flex;
            /* Fix desktop overflow: grow with content */
            flex-wrap: nowrap;
            /* Prevent wrapping on desktop */
            overflow-x: auto;
            /* Allow scroll if it doesn't fit */
            max-width: 100%;
            /* Ensure it doesn't overflow parent */
            min-width: 100%;
            /* Ensure it takes full width if content is small (pill style) */
            box-sizing: border-box;
            gap: 8px;
            /* margin-bottom handled by wrapper */
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            padding: 6px;
            border-radius: 16px;
            border: 1px solid var(--border);
            /* Position sticky handled by wrapper */
        }

        /* Wrapper for sticky positioning and positioning context for fade */
        .nav-wrapper {
            position: sticky;
            top: 12px;
            z-index: 100;
            margin-bottom: 24px;
        }

        .nav-fade {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 40px;
            background: linear-gradient(to right, transparent, rgba(30, 41, 59, 0.95));
            pointer-events: none;
            border-top-right-radius: 16px;
            border-bottom-right-radius: 16px;
            transition: opacity 0.3s ease;
            display: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }


        .nav-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--ocean-blue) 0%, var(--ocean-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
        }

        /* Mobile nav: single row, swipeable, never wraps */
        @media (max-width: 520px) {
            .nav-wrapper {
                overflow: hidden;
                /* Clip anything outside */
                border-radius: 16px;
                /* Match nav radius */
            }

            .nav-tabs {
                display: flex;
                width: 100%;
                /* Reset inline-flex for mobile */
                flex-wrap: nowrap !important;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 2px;
                padding-right: 12px;
                /* prevents margin issues */
                margin-bottom: 0;
                /* Wrapper handles margin */
                border: none;
                background: rgba(30, 41, 59, 0.6);
                backdrop-filter: blur(20px);
                border: 1px solid var(--border);
            }

            .nav-fade {
                display: block;
                /* Show on mobile */
            }

            .nav-tabs::-webkit-scrollbar {
                display: none;
            }

            .nav-tab {
                flex: 0 0 auto !important;
                white-space: nowrap;
                padding: 8px 12px;
                font-size: 12px;
            }
        }


        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(16px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(56, 189, 248, 0.2); }
            50% { box-shadow: 0 0 20px rgba(56, 189, 248, 0.4); }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spinner-small {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            flex-shrink: 0;
        }

        .page.active {
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: border-color 0.3s ease;
        }

        .card:hover {
            border-color: rgba(56, 189, 248, 0.3);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.3px;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, var(--ocean-light) 0%, var(--ocean-blue) 100%);
            border-radius: 4px;
            box-shadow: 0 0 8px rgba(56, 189, 248, 0.3);
        }

        .slider-value {
            text-align: center;
            font-size: 48px;
            font-weight: 800;
            color: #06b6d4;
            margin-bottom: 16px;
            transition: color 0.3s ease, text-shadow 0.3s ease;
            text-shadow: 0 0 30px currentColor;
            letter-spacing: -1px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, var(--ocean-blue) 0%, var(--ocean-light) 100%);
            border-radius: 3px;
            outline: none;
            border: none;
            padding: 0;
            -webkit-appearance: none;
        }

        #logTemp input[type="range"]#tempSlider {
            background: linear-gradient(to right, #6366f1 0%, #3b82f6 12%, #06b6d4 25%, #10b981 40%, #f59e0b 55%, #f97316 75%, #ef4444 100%);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: white;
            border: 3px solid var(--ocean-blue);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(56, 189, 248, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.2);
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.4), 0 0 30px rgba(56, 189, 248, 0.5);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Trends Redesign Styles */
        .trends-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .region-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 140px;
            position: relative;
            overflow: hidden;
        }

        .region-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.06) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .region-card:hover {
            transform: translateY(-2px);
            border-color: rgba(56, 189, 248, 0.3);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .region-card:hover::after {
            opacity: 1;
        }

        .region-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.1);
        }

        .region-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .region-temp {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .region-stat {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .region-warmest {
            font-size: 11px;
            color: var(--ocean-light);
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .view-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(56, 189, 248, 0.15);
            border-color: rgba(56, 189, 248, 0.3);
        }

        .view-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .spot-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .spot-list-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .spot-list-item:first-child {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .spot-list-item:last-child {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            border-bottom: none;
        }

        .spot-trend-chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }



        .toggle-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        select {
            appearance: none;
            background: rgba(15, 23, 42, 0.8) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 16px center;
            background-size: 18px;
            border: 2px solid rgba(56, 189, 248, 0.15);
            border-radius: 12px;
            color: white;
            padding: 14px 18px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            font-weight: 500;
        }

        select:hover {
            border-color: rgba(56, 189, 248, 0.4);
            background-color: rgba(15, 23, 42, 0.9);
        }

        select:focus {
            outline: none;
            border-color: var(--ocean-light);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
        }

        .toggle-btn {
            padding: 14px 20px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(56, 189, 248, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .toggle-btn:hover {
            background: rgba(56, 189, 248, 0.15);
            border-color: rgba(56, 189, 248, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.5) 0%, rgba(6, 182, 212, 0.5) 100%);
            border-color: var(--ocean-light);
            color: white;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(56, 189, 248, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
            outline: none;
        }

        textarea:focus {
            border-color: var(--ocean-light);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
        }

        select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(56, 189, 248, 0.2);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 44px;
        }

        select:focus {
            border-color: var(--ocean-light);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .info-box {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-box strong {
            color: var(--ocean-light);
            display: block;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <!-- AUTH SCREEN -->
    <div id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">
                <h1><i data-lucide="waves" style="width: 32px; height: 32px; vertical-align: middle;"></i> SwimLoading
                </h1>
                <p>Cape Town Ocean Swimming Community</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('signup')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="btn" onclick="signIn()">Login</button>
                <div style="text-align: center; margin-top: 16px;">
                    <a href="#" onclick="showForgotPassword(); return false;" style="color: var(--ocean-light); font-size: 13px; text-decoration: none; font-weight: 500;">Forgot your password?</a>
                </div>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="auth-form" style="display: none;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i data-lucide="mail" style="width: 32px; height: 32px; color: var(--ocean-light);"></i>
                    <h3 style="margin-top: 12px; font-size: 18px; color: var(--text-primary);">Reset Password</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">Enter your email and we'll send you a reset link</p>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="forgotEmail" placeholder="your.email@example.com">
                </div>
                <button class="btn" id="resetSendBtn" onclick="sendPasswordReset()">Send Reset Link</button>
                <div id="forgotMessage" style="display: none; text-align: center; margin-top: 16px; padding: 12px; border-radius: 12px; font-size: 13px;"></div>
                <div style="text-align: center; margin-top: 16px;">
                    <a href="#" onclick="hideForgotPassword(); return false;" style="color: var(--text-secondary); font-size: 13px; text-decoration: none;">‚Üê Back to Login</a>
                </div>
            </div>

            <!-- Reset Password Form (shown after clicking email link) -->
            <div id="resetPasswordForm" style="display: none;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i data-lucide="lock" style="width: 32px; height: 32px; color: var(--ocean-light);"></i>
                    <h3 style="margin-top: 12px; font-size: 18px; color: var(--text-primary);">Set New Password</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">Enter your new password below</p>
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password (min 6 chars)">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password">
                </div>
                <button class="btn" onclick="updatePassword()">Update Password</button>
                <div id="resetMessage" style="display: none; text-align: center; margin-top: 16px; padding: 12px; border-radius: 12px; font-size: 13px;"></div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="auth-form">
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="signupName" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="your.email@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" placeholder="Create password (min 8 chars)">
                </div>
                <button class="btn" onclick="signUp()">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- ONBOARDING SCREENS -->
    <div id="onboardingLegal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); overflow-y: auto; z-index: 9999;">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="max-width: 600px; width: 100%;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="font-size: 48px; margin-bottom: 16px;"><i data-lucide="waves"
                            style="width: 48px; height: 48px; color: #38bdf8; stroke-width: 2;"></i></div>
                    <h2
                        style="font-size: 28px; color: #f8fafc; margin: 0 0 8px 0; font-family: system-ui, -apple-system, sans-serif;">
                        Before You Dive In...</h2>
                    <p style="color: #94a3b8; margin: 0; font-family: system-ui, -apple-system, sans-serif;">Please
                        review and accept the following</p>
                </div>

                <div
                    style="background: rgba(15, 23, 42, 0.8); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">

                    <div style="display: flex; gap: 12px; padding: 16px; border-radius: 8px; transition: background 0.2s; margin-bottom: 12px;"
                        onmouseover="this.style.background='rgba(56,189,248,0.1)'"
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" id="obTerms" onchange="checkOnboardingBoxes()"
                            style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div
                                style="color: #f8fafc; font-weight: 600; margin-bottom: 4px; font-family: system-ui, -apple-system, sans-serif;">
                                <label for="obTerms" style="cursor: pointer;"><i data-lucide="scroll-text"
                                        style="width: 16px; height: 16px; vertical-align: middle; stroke-width: 2;"></i>
                                    Terms of Service</label>
                                <a href="#" onclick="openConsentModal('terms'); return false;"
                                    style="margin-left: 8px; font-size: 12px; color: #38bdf8; text-decoration: none;">View</a>
                            </div>
                            <label for="obTerms" style="cursor: pointer;">
                                <div
                                    style="color: #94a3b8; font-size: 13px; font-family: system-ui, -apple-system, sans-serif;">
                                    I understand the rules and responsibilities</div>
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; padding: 16px; border-radius: 8px; transition: background 0.2s; margin-bottom: 12px;"
                        onmouseover="this.style.background='rgba(56,189,248,0.1)'"
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" id="obPrivacy" onchange="checkOnboardingBoxes()"
                            style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div
                                style="color: #f8fafc; font-weight: 600; margin-bottom: 4px; font-family: system-ui, -apple-system, sans-serif;">
                                <label for="obPrivacy" style="cursor: pointer;"><i data-lucide="shield-check"
                                        style="width: 16px; height: 16px; vertical-align: middle; stroke-width: 2;"></i>
                                    Privacy Policy (POPIA)</label>
                                <a href="#" onclick="openConsentModal('privacy'); return false;"
                                    style="margin-left: 8px; font-size: 12px; color: #38bdf8; text-decoration: none;">View</a>
                            </div>
                            <label for="obPrivacy" style="cursor: pointer;">
                                <div
                                    style="color: #94a3b8; font-size: 13px; font-family: system-ui, -apple-system, sans-serif;">
                                    I understand how my data is used</div>
                            </label>
                        </div>
                    </div>

                    <div
                        style="display: flex; gap: 12px; padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 2px solid rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05);">
                        <input type="checkbox" id="obWaiver" onchange="checkOnboardingBoxes()"
                            style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div
                                style="color: #ef4444; font-weight: 600; margin-bottom: 8px; font-family: system-ui, -apple-system, sans-serif;">
                                <label for="obWaiver" style="cursor: pointer;"><i data-lucide="alert-triangle"
                                        style="width: 16px; height: 16px; vertical-align: middle; stroke-width: 2;"></i>
                                    Liability Waiver</label>
                                <a href="#" onclick="openConsentModal('waiver'); return false;"
                                    style="margin-left: 8px; font-size: 12px; color: #38bdf8; text-decoration: none;">View</a>
                            </div>
                            <label for="obWaiver" style="cursor: pointer;">
                                <div
                                    style="color: #cbd5e1; font-size: 12px; font-family: system-ui, -apple-system, sans-serif;">
                                    Ocean swimming is dangerous. I may be seriously injured or killed. SwimLoading
                                    assumes ZERO liability.</div>
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; padding: 16px; border-radius: 8px; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(56,189,248,0.1)'"
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" id="obData" onchange="checkOnboardingBoxes()"
                            style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div
                                style="color: #f8fafc; font-weight: 600; margin-bottom: 4px; font-family: system-ui, -apple-system, sans-serif;">
                                <label for="obData" style="cursor: pointer;"><i data-lucide="database"
                                        style="width: 16px; height: 16px; vertical-align: middle; stroke-width: 2;"></i>
                                    Data Consent</label>
                                <a href="#" onclick="openConsentModal('data'); return false;"
                                    style="margin-left: 8px; font-size: 12px; color: #38bdf8; text-decoration: none;">View</a>
                            </div>
                            <label for="obData" style="cursor: pointer;">
                                <div
                                    style="color: #94a3b8; font-size: 13px; font-family: system-ui, -apple-system, sans-serif;">
                                    I consent to data collection for safety</div>
                            </label>
                        </div>
                    </div>

                </div>

                <button id="obAcceptBtn" onclick="acceptOnboardingLegal()" disabled
                    style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; background: #38bdf8; color: white; border: none; border-radius: 8px; cursor: not-allowed; opacity: 0.5; font-family: system-ui, -apple-system, sans-serif;">Accept
                    All & Continue</button>

                <div style="text-align: center; margin-top: 16px;">
                    <button onclick="signOut()"
                        style="background: transparent; border: 1px solid #64748b; color: #94a3b8; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: system-ui, -apple-system, sans-serif;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Consent Document Modal -->
    <div id="consentModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: #1e293b; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1);">
            <div
                style="padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="consentModalTitle"
                    style="margin: 0; color: #f8fafc; font-family: system-ui, -apple-system, sans-serif;"></h3>
                <button onclick="closeConsentModal()"
                    style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>
            <div id="consentModalBody"
                style="padding: 24px; overflow-y: auto; flex: 1; color: #cbd5e1; font-size: 14px; line-height: 1.6; font-family: system-ui, -apple-system, sans-serif;">
            </div>
            <div style="padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button onclick="closeConsentModal()"
                    style="width: 100%; padding: 12px; background: #38bdf8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: system-ui, -apple-system, sans-serif;">Close</button>
            </div>
        </div>
    </div>

    <div id="onboardingPersonal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); overflow-y: auto; z-index: 9999;">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="max-width: 600px; width: 100%;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="font-size: 48px; margin-bottom: 16px;"><i data-lucide="user"
                            style="width: 48px; height: 48px; color: #38bdf8; stroke-width: 2;"></i></div>
                    <h2
                        style="font-size: 28px; color: #f8fafc; margin: 0 0 8px 0; font-family: system-ui, -apple-system, sans-serif;">
                        Let's Get to Know You</h2>
                    <p style="color: #94a3b8; margin: 0; font-family: system-ui, -apple-system, sans-serif;">We need
                        this for safety and emergency purposes</p>
                </div>

                <div
                    style="background: rgba(15, 23, 42, 0.8); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">

                    <div style="margin-bottom: 16px;">
                        <label
                            style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;"><i
                                data-lucide="user"
                                style="width: 14px; height: 14px; vertical-align: middle; stroke-width: 2;"></i> Full
                            Name *</label>
                        <input type="text" id="obFullName" placeholder="John Smith"
                            style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label
                            style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;"><i
                                data-lucide="phone"
                                style="width: 14px; height: 14px; vertical-align: middle; stroke-width: 2;"></i> Phone
                            *</label>
                        <input type="tel" id="obPhone" placeholder="+27 82 123 4567"
                            style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label
                            style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;"><i
                                data-lucide="calendar"
                                style="width: 14px; height: 14px; vertical-align: middle; stroke-width: 2;"></i> Date of
                            Birth *</label>
                        <input type="date" id="obDOB"
                            style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label
                            style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;"><i
                                data-lucide="map-pin"
                                style="width: 14px; height: 14px; vertical-align: middle; stroke-width: 2;"></i> Address
                            *</label>
                        <input type="text" id="obAddress" placeholder="123 Beach Road"
                            style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label
                                style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;">City
                                *</label>
                            <input type="text" id="obCity" placeholder="Cape Town" value="Cape Town"
                                style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                        </div>
                        <div>
                            <label
                                style="color: #94a3b8; font-size: 13px; margin-bottom: 4px; display: block; font-family: system-ui, -apple-system, sans-serif;">Postal
                                *</label>
                            <input type="text" id="obPostal" placeholder="8001"
                                style="width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f8fafc; font-size: 14px; font-family: system-ui, -apple-system, sans-serif; box-sizing: border-box;">
                        </div>
                    </div>

                </div>

                <button onclick="saveOnboardingPersonal()"
                    style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; background: #38bdf8; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: system-ui, -apple-system, sans-serif;">Continue
                    to Dashboard</button>

                <div
                    style="text-align: center; margin-top: 16px; color: #64748b; font-size: 12px; font-family: system-ui, -apple-system, sans-serif;">
                    * Required fields
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <div class="container">
            <div class="header">
                <div class="header-top">
                    <div class="logo"><i data-lucide="waves"
                            style="width: 24px; height: 24px; vertical-align: middle;"></i> SwimLoading</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <!-- Notification Bell -->
                        <div id="notifBell" onclick="showNotifications()"
                            style="position: relative; cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;">
                            <i data-lucide="bell" style="width: 18px; height: 18px; color: var(--text-secondary);"></i>
                            <div id="notifBadge"
                                style="display: none; position: absolute; top: 2px; right: 2px; width: 9px; height: 9px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg-dark);">
                            </div>
                        </div>

                        <div class="user-avatar" id="headerAvatar"
                            onclick="showProfileSettings()" title="Profile Settings"><i
                                data-lucide="user" style="width: 18px; height: 18px; color: white;"></i></div>
                    </div>
                </div>
            </div>


            <div class="nav-wrapper">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showPage('dashboard')">Home</button>
                    <button class="nav-tab" onclick="showPage('logTemp')">Temps</button>
                    <button class="nav-tab" onclick="showPage('events')">Swims</button>
                    <button class="nav-tab" onclick="showPage('history')">Trends</button>
                    <button class="nav-tab" onclick="showPage('safety')">Safety</button>
                    <button class="nav-tab" onclick="showPage('leaderboard')">Board</button>
                </div>
                <div class="nav-fade"></div>
            </div>



            <!-- DASHBOARD -->
            <div id="dashboard" class="page active">
                <div class="card">
                    <div class="card-title">Dashboard</div>

                    <!-- Your Upcoming Swims -->
                    <div style="margin-bottom: 24px;">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
                            <i data-lucide="calendar-check"
                                style="width: 18px; height: 18px; vertical-align: middle;"></i> Your Upcoming Swims
                        </div>
                        <div id="dashUpcomingSwims">Loading...</div>
                    </div>

                    <!-- Your Stats -->
                    <div
                        style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
                            <i data-lucide="bar-chart-3" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                            Your Stats
                        </div>
                        <div id="dashStats">Loading...</div>
                    </div>

                    <!-- Recent Conditions -->
                    <div style="margin-bottom: 24px;">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
                            <i data-lucide="thermometer" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                            Latest Water Temps
                        </div>
                        <div id="dashConditions">Loading...</div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <button class="btn btn-success" onclick="showPage('logTemp')">Log Temperature</button>
                    </div>
                </div>
            </div>

            <!-- LOG TEMP -->
            <div id="logTemp" class="page">
                <div class="card">
                    <div class="card-title">Log Temperature</div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="map-pin"
                                style="width: 14px; height: 14px; vertical-align: middle;"></i> Location</div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <select data-spots style="flex: 1;">
                                <option>Loading spots...</option>
                            </select>
                            <button type="button" id="gpsButton" class="btn"
                                style="width: auto; padding: 12px 16px; font-size: 13px;"
                                onclick="getCurrentLocation()">
                                <i data-lucide="navigation" style="width: 14px; height: 14px;"></i> GPS
                            </button>
                        </div>
                        <div id="gpsStatus" style="font-size: 12px; color: var(--text-secondary); min-height: 18px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="thermometer"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i> Water
                            Temperature</div>
                        <div class="slider-value" id="tempValue">14¬∞C</div>
                        <input type="range" id="tempSlider" min="8" max="32" value="14" step="0.5"
                            oninput="updateTempSlider(this.value)">
                        <div class="slider-labels">
                            <span>8¬∞C</span>
                            <span>32¬∞C</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="waves"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                            Conditions</div>
                        <div class="toggle-group">
                            <div class="toggle-btn active" onclick="toggleSingle(this)"><i data-lucide="sun"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Calm</div>
                            <div class="toggle-btn" onclick="toggleSingle(this)"><i data-lucide="waves"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Choppy</div>
                            <div class="toggle-btn" onclick="toggleSingle(this)"><i data-lucide="wind"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Rough</div>
                            <div class="toggle-btn" onclick="toggleSingle(this)"><i data-lucide="cloud-lightning"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Extreme</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="shield-alert"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                            Hazards (Optional)</div>
                        <div class="toggle-group">
                            <div class="toggle-btn" onclick="this.classList.toggle('active')"><i data-lucide="droplet"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Jellyfish</div>
                            <div class="toggle-btn" onclick="this.classList.toggle('active')"><i
                                    data-lucide="circle-dot"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Seals</div>
                            <div class="toggle-btn" onclick="this.classList.toggle('active')"><i
                                    data-lucide="alert-triangle"
                                    style="width: 18px; height: 18px; vertical-align: middle;"></i> Shark</div>
                            <div class="toggle-btn" onclick="this.classList.toggle('active')">üí© Sewage</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i data-lucide="file-text"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i> Notes
                        </div>
                        <textarea placeholder="Visibility, currents, etc..."></textarea>
                    </div>

                    <button class="btn btn-success" onclick="submitTempLog()">Submit Temperature Log</button>

                    <div class="info-box">
                        <i data-lucide="database"
                            style="width: 16px; height: 16px; vertical-align: middle; color: var(--ocean-light); margin-right: 4px;"></i>
                        <strong>Live Database!</strong>
                        This will save to YOUR Supabase database in real-time!
                    </div>
                </div>
            </div>

            <!-- HISTORY & TRENDS -->
            <!-- TRENDS / HISTORY PAGE -->
            <div id="history" class="page">
                <div class="card" style="min-height: 80vh;">

                    <!-- 1. Region Overview -->
                    <div id="trendsOverview">
                        <div class="card-title">Regional Overview</div>

                        <!-- Water Type Filter -->
                        <div class="toggle-group" style="margin-bottom: 20px; justify-content: center;">
                            <div class="toggle-btn active" id="filterOcean" onclick="setWaterFilter('ocean')">Ocean
                            </div>
                            <div class="toggle-btn" id="filterLagoons" onclick="setWaterFilter('lagoons')">Lagoons</div>
                            <div class="toggle-btn" id="filterPools" onclick="setWaterFilter('pools')">Pools</div>
                            <div class="toggle-btn" id="filterInland" onclick="setWaterFilter('inland')">Inland</div>
                        </div>

                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;"
                            id="trendsLoading">
                            Loading data...
                        </div>
                        <div class="region-grid" id="regionGrid" style="display: none;">
                            <!-- Tiles rendered here -->
                        </div>
                    </div>

                    <!-- 2. Region Detail -->
                    <div id="trendsRegionDetail" style="display: none;">
                        <div class="view-header">
                            <button class="back-btn" onclick="showTrendsOverview()">
                                <i data-lucide="arrow-left" style="width: 18px; height: 18px;"></i>
                            </button>
                            <div class="view-title" id="regionDetailTitle">Region Name</div>
                        </div>
                        <div id="regionSpotList">
                            <!-- Spot list rendered here -->
                        </div>
                    </div>

                    <!-- 3. Spot Detail -->
                    <div id="trendsSpotDetail" style="display: none;">
                        <div class="view-header">
                            <button class="back-btn" onclick="showLastRegionDetail()">
                                <i data-lucide="arrow-left" style="width: 18px; height: 18px;"></i>
                            </button>
                            <div class="view-title" id="spotDetailTitle">Spot Name</div>
                        </div>

                        <div class="form-group">
                            <!-- Window Selector -->
                            <div class="toggle-group" style="margin-bottom: 12px;">
                                <div class="toggle-btn" id="window7d" onclick="setChartWindow('7d')">7d</div>
                                <div class="toggle-btn active" id="window30d" onclick="setChartWindow('30d')">30d</div>
                                <div class="toggle-btn" id="window90d" onclick="setChartWindow('90d')">90d</div>
                                <div class="toggle-btn" id="windowAll" onclick="setChartWindow('all')">All</div>
                            </div>

                            <!-- My/Community Toggle -->
                            <div class="toggle-group" style="margin-bottom: 20px;">
                                <div class="toggle-btn active" id="toggleCommunity"
                                    onclick="toggleChartSource('community')">Community</div>
                                <div class="toggle-btn" id="toggleMyLogs" onclick="toggleChartSource('my')">My Logs
                                </div>
                            </div>
                        </div>

                        <div class="spot-trend-chart-container">
                            <canvas id="spotTrendChart" style="max-height: 250px;"></canvas>
                        </div>

                        <div class="card-title" style="font-size: 16px; margin-bottom: 12px;">Recent Logs</div>
                        <div id="spotRecentLogs">
                            <!-- Logs list -->
                        </div>
                    </div>

                </div>
            </div>


            <!-- SWIM EVENTS -->
            <div id="events" class="page">
                <div class="card">
                    <div class="card-title">Group Swims</div>

                    <!-- Create Event Button -->
                    <button class="btn btn-success" onclick="showCreateEvent()" style="margin-bottom: 20px;">
                        <i data-lucide="plus" style="width: 16px; height: 16px; vertical-align: middle;"></i> Create
                        New Swim
                    </button>

                    <!-- Event Filters -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <div class="form-label"
                                style="display: flex; justify-content: space-between; align-items: center;">
                                <span><i data-lucide="map-pin"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Location</span>
                                <span id="clearEventFilter" onclick="clearEventFilter()"
                                    style="display: none; font-size: 11px; color: var(--ocean-light); cursor: pointer; font-weight: 500;">Clear</span>
                            </div>
                            <select id="eventSpotFilter" onchange="loadEvents()">
                                <option value="">All Locations</option>
                            </select>
                        </div>
                    </div>

                    <!-- Events List -->
                    <div id="eventsList" style="margin-top: 20px;">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            Loading events...
                        </div>
                    </div>
                </div>

                <!-- Create Event Modal -->
                <div id="createEventModal"
                    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 20px; overflow-y: auto;">
                    <div
                        style="max-width: 500px; margin: 40px auto; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 20px; padding: 30px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--text-primary); font-size: 20px;">Create New Swim</h3>
                            <button onclick="hideCreateEvent()"
                                style="background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: auto;">‚úï</button>
                        </div>

                        <!-- Safety Disclaimer -->
                        <div
                            style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <div
                                style="font-weight: 600; color: var(--danger); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i> Important Safety
                                Note
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                All group swims are <strong style="color: var(--text-primary);">peer-to-peer</strong>. By creating or joining a swim, you acknowledge that:
                                <ul style="margin: 8px 0 0 20px; padding: 0;">
                                    <li>Every swimmer participates <strong style="color: var(--text-primary);">at their own risk</strong></li>
                                    <li>The organizer is coordinating, <strong style="color: var(--text-primary);">not supervising</strong></li>
                                    <li>You must assess your own ability and conditions</li>
                                    <li>Open water and cold water carry serious risks</li>
                                    <li>Emergency contacts are shared with fellow swimmers for safety</li>
                                </ul>
                            </div>
                        </div>

                        <form id="createEventForm" onsubmit="submitEvent(event)">
                            <div class="form-group">
                                <div class="form-label">Swim Name</div>
                                <input type="text" id="eventName" placeholder="e.g., Morning Clifton Lap" required>
                            </div>

                            <div class="form-group">
                                <div class="form-label"><i data-lucide="map-pin"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Location</div>
                                <select id="eventSpot" data-spots required></select>
                            </div>

                            <div class="form-group">
                                <div class="form-label">Route Type</div>
                                <select id="eventRouteType"
                                    onchange="const hint = document.getElementById('logisticsHint'); if(this.value === 'point_to_point') { hint.style.display = 'block' } else { hint.style.display = 'none' }">
                                    <option value="loop">Loop (start/end same)</option>
                                    <option value="out_and_back">Out & back (turnaround)</option>
                                    <option value="point_to_point">Point-to-point (lifts likely)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div class="form-label">Logistics</div>
                                <div id="logisticsHint"
                                    style="display: none; font-size: 11px; color: var(--ocean-light); margin-bottom: 4px;">
                                    Point-to-point often needs lifts‚Äîadd the plan here.</div>
                                <textarea id="eventLogistics"
                                    placeholder="Meet details / car shuffle plan..."></textarea>
                            </div>

                            <!-- Safety Collapsible -->
                            <details
                                style="margin-bottom: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 4px;">
                                <summary
                                    style="cursor: pointer; padding: 12px; color: var(--text-secondary); font-size: 14px; font-weight: 600;">
                                    Safety Recommendations
                                </summary>
                                <div style="padding: 12px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                                        <input type="checkbox" id="eventTowFloat" checked
                                            style="width: 18px; height: 18px;">
                                        <span style="font-size: 14px; color: var(--text-primary);">Tow float
                                            recommended</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="eventBrightCap" checked
                                            style="width: 18px; height: 18px;">
                                        <span style="font-size: 14px; color: var(--text-primary);">Bright cap
                                            recommended</span>
                                    </label>
                                </div>
                            </details>

                            <div class="form-group">
                                <div class="form-label">External Group Link (Optional)</div>
                                <input type="url" id="eventChatUrl" placeholder="https://chat.whatsapp.com/...">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">External
                                    link. SwimLoading doesn't moderate chats.</div>
                            </div>

                            <div class="form-group">
                                <div class="form-label"><i data-lucide="calendar"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Date & Time
                                </div>
                                <input type="datetime-local" id="eventDateTime" required>
                            </div>

                            <div class="form-group">
                                <div class="form-label">Pace Category</div>
                                <select id="eventPaceLevel" required>
                                    <option value="100">Fast (1:40/100m)</option>
                                    <option value="120">Steady (2:00/100m)</option>
                                    <option value="150" selected>Social (2:30/100m)</option>
                                    <option value="180">Developing (3:00/100m)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div class="form-label"><i data-lucide="ruler"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Distance (km)
                                </div>
                                <input type="number" id="eventDistance" step="0.1" placeholder="e.g., 2.5" required>
                            </div>

                            <div class="form-group">
                                <div class="form-label"><i data-lucide="users"
                                        style="width: 14px; height: 14px; vertical-align: middle;"></i> Max Participants
                                </div>
                                <input type="number" id="eventMaxParticipants" placeholder="Leave empty for unlimited"
                                    min="2">
                            </div>

                            <div class="form-group">
                                <div class="form-label">Description / Route</div>
                                <textarea id="eventDescription"
                                    placeholder="Describe the route, meeting point, any special notes..."
                                    rows="4"></textarea>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="eventRequireApproval" style="width: auto; margin: 0;">
                                    <span style="font-size: 13px; color: var(--text-secondary);">
                                        Require approval for swimmers below pace level
                                    </span>
                                </label>
                            </div>

                            <button type="submit" class="btn btn-success" style="margin-top: 10px;">Create
                                Swim</button>
                        </form>
                    </div>
                </div>

                <!-- Event Details Modal -->
                <div id="eventDetailsModal"
                    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; padding: 20px; overflow-y: auto;">
                    <div
                        style="max-width: 600px; margin: 40px auto; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 20px; padding: 30px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--text-primary); font-size: 20px;">Swim Details</h3>
                            <button onclick="hideEventDetails()"
                                style="background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: auto;">‚úï</button>
                        </div>

                        <div id="eventDetailsContent"></div>
                    </div>
                </div>

                <!-- Profile Settings Modal -->
                <div id="profileModal"
                    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1002; padding: 20px; overflow-y: auto;">
                    <div
                        style="max-width: 500px; margin: 40px auto; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 20px; padding: 30px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--text-primary); font-size: 20px;">Profile Settings</h3>
                            <button onclick="hideProfileSettings()"
                                style="background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: auto;">‚úï</button>
                        </div>

                        <div style="text-align: center; margin-bottom: 24px;">
                            <div class="form-label" style="text-align:center; margin-bottom:8px;">Choose Avatar</div>
                            <div id="avatarGrid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 12px; margin-bottom: 20px;">
                                <!-- Populated by JS -->
                            </div>
                            <div style="color: var(--text-primary); font-weight: 600;" id="profileEmail"></div>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Display Name</div>
                            <input type="text" id="profileDisplayName" placeholder="Your name">
                        </div>

                        <div class="form-group">
                            <div class="form-label">üì± Phone Number</div>
                            <input type="tel" id="profilePhone" placeholder="e.g., 082 123 4567">
                            <small style="color: var(--text-secondary); font-size: 11px;">Required to join group swims</small>
                        </div>

                        <div style="background: rgba(239, 68, 68, 0.06); border: 1px solid rgba(239, 68, 68, 0.15); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: var(--text-primary); font-size: 13px; margin-bottom: 10px;">üö® Emergency Contact</div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <div class="form-label" style="font-size: 12px;">Contact Name</div>
                                <input type="text" id="profileEmergencyName" placeholder="e.g., Jane Smith">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <div class="form-label" style="font-size: 12px;">Contact Phone</div>
                                <input type="tel" id="profileEmergencyPhone" placeholder="e.g., 083 456 7890">
                            </div>
                            <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 8px;">Visible to fellow swimmers on group swims ‚Äî for safety only</small>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Preferred Suit</div>
                            <select id="profilePreferredSuit">
                                <option value="skins">Skins (No Wetsuit)</option>
                                <option value="wetsuit">Wetsuit</option>
                                <option value="both">Both</option>
                            </select>
                        </div>



                        <div class="form-group">
                            <div class="form-label">üèñÔ∏è Home Beach</div>
                            <select id="profileHomeBeach" data-spots></select>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Pool 1km Time (optional)</div>
                            <input type="text" id="profilePoolTime" placeholder="e.g., 18:30 (mm:ss)">
                            <small style="color: var(--text-secondary); font-size: 11px;">Helps match you with
                                appropriate pace groups</small>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Ocean 1km Time (optional)</div>
                            <input type="text" id="profileOceanTime" placeholder="e.g., 21:00 (mm:ss)">
                        </div>

                        <div class="form-group">
                            <div class="form-label">‚ùÑÔ∏è Cold Tolerance (¬∞C)</div>
                            <input type="number" id="profileColdTolerance" placeholder="e.g., 12" step="0.5">
                            <small style="color: var(--text-secondary); font-size: 11px;">Minimum water temp you're
                                comfortable swimming in</small>
                        </div>

                        <button class="btn btn-success" onclick="saveProfile()" style="margin-bottom: 16px;">Save
                            Profile</button>

                        <div style="border-top: 1px solid rgba(255,255,255,0.06); padding-top: 16px; margin-top: 8px;">
                            <button class="btn"
                                style="background: transparent; border: 1px solid rgba(239, 68, 68, 0.25); color: rgba(239, 68, 68, 0.7); font-size: 13px; padding: 10px 20px;"
                                onclick="signOut()"><i data-lucide="log-out" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 6px;"></i>Sign Out</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SAFETY -->
            <div id="safety" class="page">
                <div class="card">
                    <div class="card-title"><i data-lucide="shield-alert"
                            style="width: 24px; height: 24px; vertical-align: middle;"></i> Safety Guidance</div>

                    <!-- üî¥ Section 1: Critical Risks -->
                    <div
                        style="background: rgba(239, 68, 68, 0.15); border: 2px solid var(--danger); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div
                            style="font-weight: 800; color: var(--danger); margin-bottom: 12px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="alert-octagon" style="width: 20px; height: 20px;"></i> üî¥ CRITICAL SAFETY
                            WARNINGS
                        </div>

                        <div style="margin-bottom: 16px;">
                            <div
                                style="font-weight: 700; color: var(--text-primary); font-size: 14px; margin-bottom: 4px;">
                                SEAL BITES / RABIES ‚Äî MEDICAL EMERGENCY</div>
                            <ul
                                style="margin: 0 0 0 20px; padding: 0; color: var(--text-primary); font-size: 13px; line-height: 1.4;">
                                <li style="margin-bottom: 4px;">Rabies confirmed in Cape fur seals.</li>
                                <li style="margin-bottom: 4px;">Any bite/scratch requires immediate hospital treatment.
                                </li>
                                <li style="margin-bottom: 4px;">Wash wound with soap + water for 10‚Äì15 minutes.</li>
                                <li style="margin-bottom: 4px;">Report possible rabies exposure at the ER immediately.
                                </li>
                            </ul>
                        </div>

                        <div>
                            <div
                                style="font-weight: 700; color: var(--text-primary); font-size: 14px; margin-bottom: 4px;">
                                HYPOTHERMIA ‚Äî MEDICAL EMERGENCY</div>
                            <ul
                                style="margin: 0 0 0 20px; padding: 0; color: var(--text-primary); font-size: 13px; line-height: 1.4;">
                                <li style="margin-bottom: 4px;">Remove wet clothing and shelter from wind.</li>
                                <li style="margin-bottom: 4px;">Warm the core first (chest, neck, groin).</li>
                                <li style="margin-bottom: 4px;">Handle gently ‚Äî rough movement can trigger cardiac
                                    arrest.</li>
                                <li style="margin-bottom: 4px;">Do not give alcohol or rub the skin.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 2: Marine Life -->
                    <div
                        style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);">
                        <div
                            style="font-weight: 700; color: var(--text-primary); margin-bottom: 12px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="waves" style="width: 18px; height: 18px; color: var(--ocean-light);"></i>
                            Marine Life
                        </div>

                        <div style="display: grid; gap: 12px;">
                            <div>
                                <div
                                    style="font-weight: 600; color: var(--ocean-light); font-size: 13px; margin-bottom: 2px;">
                                    SHARKS</div>
                                <ul
                                    style="margin: 0 0 0 18px; padding: 0; color: var(--text-secondary); font-size: 13px; line-height: 1.4;">
                                    <li>Avoid dawn/dusk and murky water.</li>
                                    <li>Exit water calmly if sharks are sighted.</li>
                                    <li>Swim in groups where possible.</li>
                                    <li></li>
                                </ul>
                            </div>
                            <div>
                                <div
                                    style="font-weight: 600; color: var(--ocean-light); font-size: 13px; margin-bottom: 2px;">
                                    SEALS (INC. RABID)</div>
                                <ul
                                    style="margin: 0 0 0 18px; padding: 0; color: var(--text-secondary); font-size: 13px; line-height: 1.4;">
                                    <li>Do not approach or interact.</li>
                                    <li>Exit immediately if seal acts aggressively or unusually.</li>
                                    <li>Erratic or overly friendly behavior = DANGER.</li>
                                </ul>
                            </div>
                            <div>
                                <div
                                    style="font-weight: 600; color: var(--ocean-light); font-size: 13px; margin-bottom: 2px;">
                                    BLUEBOTTLES / JELLYFISH</div>
                                <ul
                                    style="margin: 0 0 0 18px; padding: 0; color: var(--text-secondary); font-size: 13px; line-height: 1.4;">
                                    <li>Rinse with seawater (never fresh water).</li>
                                    <li>Exit water if stings are widespread.</li>
                                    <li>Seek help if pain is severe or systemic.</li>
                                </ul>
                            </div>

                            <div style="margin-top: 10px;">
                                <div
                                    style="font-weight: 600; color: var(--ocean-light); font-size: 13px; margin-bottom: 2px;">
                                    üí© SEWAGE / WATER POLLUTION</div>
                                <ul
                                    style="margin: 0 0 0 18px; padding: 0; color: var(--text-secondary); font-size: 13px; line-height: 1.4;">
                                    <li>Do not swim if water is discoloured or smells foul.</li>
                                    <li>Avoid swimming after heavy rainfall (stormwater runoff).</li>
                                    <li>Check for City of Cape Town beach closures / advisories.</li>
                                    <li>If exposed: shower immediately, avoid swallowing water.</li>
                                    <li>Seek medical help if you develop gastro, ear or skin infections.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Cold & Exposure -->
                    <div
                        style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);">
                        <div
                            style="font-weight: 700; color: var(--text-primary); margin-bottom: 12px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="thermometer-snowflake"
                                style="width: 18px; height: 18px; color: #38bdf8;"></i> Cold Water & Exposure
                        </div>
                        <ul
                            style="margin: 0 0 0 20px; padding: 0; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                            <li style="margin-bottom: 4px;">Cold + wind dramatically increases heat loss.</li>
                            <li style="margin-bottom: 4px;">Shivering, slurred speech, confusion = DANGER SIGNS.</li>
                            <li style="margin-bottom: 4px;">Get out early ‚Äî do not "push through".</li>
                            <li style="margin-bottom: 4px;">Always have a warm change and shelter ready.</li>
                        </ul>
                    </div>

                    <!-- Section 4: Emergency Contacts -->
                    <div
                        style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.1);">
                        <div
                            style="font-weight: 700; color: var(--text-primary); margin-bottom: 12px; font-size: 16px;">
                            Emergency Contacts
                        </div>
                        <div style="display: grid; gap: 8px;">
                            <a href="tel:0870949774"
                                style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-decoration: none; border: 1px solid rgba(255,255,255,0.05);">
                                <div>
                                    <div style="color: var(--text-primary); font-weight: 700; font-size: 14px;">üö§ NSRI
                                        (Sea Rescue)</div>
                                    <div style="color: var(--text-secondary); font-size: 11px;">Water rescue / missing
                                        swimmer</div>
                                </div>
                                <span style="color: #38bdf8; font-weight: 800; font-size: 15px;">087 094 9774</span>
                            </a>
                            <a href="tel:10177"
                                style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-decoration: none; border: 1px solid rgba(255,255,255,0.05);">
                                <div>
                                    <div style="color: var(--text-primary); font-weight: 700; font-size: 14px;">üöë
                                        Ambulance</div>
                                    <div style="color: var(--text-secondary); font-size: 11px;">Medical emergency</div>
                                </div>
                                <span style="color: #38bdf8; font-weight: 800; font-size: 15px;">10177</span>
                            </a>
                            <a href="tel:10111"
                                style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-decoration: none; border: 1px solid rgba(255,255,255,0.05);">
                                <div>
                                    <div style="color: var(--text-primary); font-weight: 700; font-size: 14px;">üëÆ
                                        Police</div>
                                    <div style="color: var(--text-secondary); font-size: 11px;">Immediate danger</div>
                                </div>
                                <span style="color: #38bdf8; font-weight: 800; font-size: 15px;">10111</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LEADERBOARD -->
            <div id="leaderboard" class="page">
                <div class="card">
                    <div class="card-title"><i data-lucide="trophy"
                            style="width: 24px; height: 24px; vertical-align: middle;"></i> Leaderboard</div>

                    <!-- Top Swimmers -->
                    <div>
                        <div
                            style="font-weight: 700; color: var(--text-primary); margin-bottom: 16px; font-size: 18px;">
                            üèÜ Top Swimmers</div>
                        <div id="leaderboardList"
                            style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px;">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find tab by text
                const tabs = Array.from(document.querySelectorAll('.auth-tab'));
                const target = tabs.find(t => t.innerText.toLowerCase().includes(tab));
                if (target) target.classList.add('active');
            }
            document.getElementById(tab + 'Form').classList.add('active');
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(page).classList.add('active');
            if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find nav-tab by its onclick attribute
                const tabs = Array.from(document.querySelectorAll('.nav-tab'));
                const target = tabs.find(t => t.getAttribute('onclick') && t.getAttribute('onclick').includes(`showPage('${page}')`));
                if (target) target.classList.add('active');
            }

            // Load data for specific pages
            if (page === 'dashboard') {
                loadDashboard();
            } else if (page === 'history') {
                currentWaterFilter = 'ocean'; // Reset to default
                updateWaterFilterUI();
                loadTrends(); // Updated to new function
            } else if (page === 'events') {
                loadEvents();
            } else if (page === 'leaderboard') {
                loadLeaderboard();
            }

            // Initialize icons after page switch
            initIcons();
        }

        // Load leaderboard data
        async function loadLeaderboard() {
            const listEl = document.getElementById('leaderboardList');

            try {
                // Fetch top swimmers by points
                const { data, error } = await supabaseClient
                    .from('user_stats')
                    .select('user_id, points, profiles(display_name)')
                    .gt('points', 0)
                    .order('points', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('Leaderboard error:', error);
                    listEl.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 20px;">
                        ‚ùå Could not load leaderboard<br>
                        <small style="color: var(--text-secondary);">${error.message}</small>
                    </div>`;
                } else if (!data || data.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No swimmers on the leaderboard yet. Log a temperature to earn points!</div>';
                } else {
                    listEl.innerHTML = renderLeaderboardList(data, 'points');
                }

            } catch (err) {
                console.error('Leaderboard error:', err);
                listEl.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">Error loading leaderboard</div>';
            }
        }

        function renderLeaderboardList(data, pointsField) {
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            return data.map((row, i) => {
                const name = row.profiles?.display_name || 'Anonymous Swimmer';
                const points = row[pointsField] || 0;
                const medal = medals[i] || `${i + 1}.`;
                const isTop3 = i < 3;

                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; ${isTop3 ? 'background: rgba(56, 189, 248, 0.1);' : ''} border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: ${isTop3 ? '20px' : '14px'}; width: 30px; text-align: center;">${medal}</span>
                        <span style="color: var(--text-primary); font-weight: ${isTop3 ? '600' : '400'};">${name}</span>
                    </div>
                    <span style="color: var(--ocean-light); font-weight: 700;">${points.toLocaleString()} pts</span>
                </div>`;
            }).join('');
        }

        // Helper to send a notification
        async function notify(recipientUserId, swimEventId, type, title, message, payloadObj = {}) {
            // Don't notify yourself
            if (currentUser && recipientUserId === currentUser.id) return;

            try {
                const { error } = await supabaseClient
                    .from('notifications')
                    .insert({
                        recipient_user_id: recipientUserId,
                        swim_event_id: swimEventId,
                        type: type,
                        title: title,
                        message: message,
                        payload: payloadObj,
                        created_at: new Date().toISOString()
                    });

                if (error) {
                    console.error('Supabase Notification Error:', error);
                    throw error;
                }
                // console.log('Notification sent to ' + recipientUserId);
            } catch (err) {
                console.error('Notification failed:', err);
                // We don't necessarily want to toast the sender if a background notification fails, 
                // but for debugging it might be useful.
                // showToast(`Failed to send notification`, 'error'); 
            }
        }

        // Initialize polling when app loads
        function startNotificationPolling() {
            updateUnreadCount();
            setInterval(updateUnreadCount, 30000); // Poll every 30s
        }

        async function updateUnreadCount() {
            if (!currentUser) return;
            try {
                const { count, error } = await supabaseClient
                    .from('notifications')
                    .select('*', { count: 'exact', head: true })
                    .eq('recipient_user_id', currentUser.id)
                    .is('read_at', null);

                if (error) throw error;

                const badge = document.getElementById('notifBadge');
                if (count > 0) {
                    badge.style.display = 'block';
                    // Optional: badge.innerText = count > 9 ? '9+' : count;
                } else {
                    badge.style.display = 'none';
                }
            } catch (err) {
                console.error('Error polling notifications:', err);
            }
        }

        async function loadNotifications() {
            const modal = document.getElementById('notifModal');
            const list = document.getElementById('notifList');

            if (!currentUser) return;

            try {
                const { data, error } = await supabaseClient
                    .from('notifications')
                    .select('*')
                    .eq('recipient_user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(50); // Get latest 50

                if (error) throw error;

                if (!data || data.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No notifications yet</div>';
                } else {
                    list.innerHTML = data.map(n => {
                        const isRead = n.read_at !== null;
                        return `
                        <div onclick="markNotifRead('${n.id}')" style="cursor: pointer; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); background: ${isRead ? 'transparent' : 'rgba(56, 189, 248, 0.05)'}; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                                <div style="font-weight: 700; color: ${isRead ? 'var(--text-secondary)' : 'var(--ocean-light)'}; font-size: 14px;">${n.title}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">${getTimeAgo(new Date(n.created_at))}</div>
                             ${!isRead ? `<div style="width: 8px; height: 8px; background: var(--ocean-light); border-radius: 50%; position: absolute; top: 20px; right: 10px;"></div>` : ''}
                        </div>
                    `}).join('');
                }

                // Update badge immediately
                updateUnreadCount();

            } catch (err) {
                console.error('Error loading notifications:', err);
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">Error loading notifications</div>';
            }
        }

        async function showNotifications() {
            const list = document.getElementById('notifList');
            const modal = document.getElementById('notifModal');

            modal.style.display = 'flex';
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading...</div>';

            await loadNotifications();
        }



        async function markNotifRead(id) {
            try {
                await supabaseClient.from('notifications').update({ read_at: new Date().toISOString() }).eq('id', id);
                await loadNotifications();
            } catch (err) {
                console.error('Error marking as read:', err);
                showToast('Failed to mark notification as read', 'error');
            }
        }

        async function markAllNotifsRead() {
            try {
                await supabaseClient.from('notifications')
                    .update({ read_at: new Date().toISOString() })
                    .eq('recipient_user_id', currentUser.id)
                    .is('read_at', null);
                await loadNotifications();
            } catch (err) {
                console.error('Error marking all as read:', err);
                showToast('Failed to mark all notifications as read', 'error');
            }
        }

        function closeNotifModal() {
            document.getElementById('notifModal').style.display = 'none';
        }

        function getTempColor(temp) {
            if (temp < 10) return '#6366f1';  // Indigo - Ice cold
            if (temp < 12) return '#3b82f6';  // Blue - Very cold
            if (temp < 14) return '#0ea5e9';  // Sky blue - Cold
            if (temp < 16) return '#06b6d4';  // Cyan - Cool
            if (temp < 18) return '#14b8a6';  // Teal - Refreshing
            if (temp < 20) return '#10b981';  // Emerald - Nice
            if (temp < 22) return '#84cc16';  // Lime - Warm
            if (temp < 24) return '#f59e0b';  // Amber - Quite warm
            if (temp < 26) return '#f97316';  // Orange - Hot
            if (temp < 28) return '#ef4444';  // Red - Very hot
            if (temp < 30) return '#dc2626';  // Dark red - Scorching
            return '#b91c1c';                  // Deep red - Extreme
        }

        function getTempLabel(temp) {
            if (temp < 10) return 'ü•∂ Ice Cold';
            if (temp < 12) return '‚ùÑÔ∏è Very Cold';
            if (temp < 14) return 'üßä Cold';
            if (temp < 16) return 'üíß Cool';
            if (temp < 18) return 'üåä Refreshing';
            if (temp < 20) return 'üëå Nice';
            if (temp < 22) return 'üòé Warm';
            if (temp < 24) return '‚òÄÔ∏è Quite Warm';
            if (temp < 26) return 'üî• Hot';
            if (temp < 28) return 'üå∂Ô∏è Very Hot';
            if (temp < 30) return '‚ô®Ô∏è Scorching';
            return 'üö´ Too Hot!';
        }

        function updateTempSlider(val) {
            const temp = parseFloat(val);
            const color = getTempColor(temp);
            const label = getTempLabel(temp);
            const display = document.getElementById('tempValue');
            display.textContent = val + '¬∞C';
            display.style.color = color;
            display.style.textShadow = `0 0 30px ${color}40, 0 0 60px ${color}20`;

            // Update or create temp label
            let labelEl = document.getElementById('tempLabel');
            if (!labelEl) {
                labelEl = document.createElement('div');
                labelEl.id = 'tempLabel';
                labelEl.style.cssText = 'text-align: center; font-size: 13px; font-weight: 600; margin-top: -8px; margin-bottom: 12px; transition: all 0.3s ease; letter-spacing: 0.5px;';
                display.parentNode.insertBefore(labelEl, display.nextSibling);
            }
            labelEl.textContent = label;
            labelEl.style.color = color;
        }

        function toggleSingle(el) {
            el.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
    </script>
    <!-- Notifications Modal -->
    <div id="notifModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; align-items: center; justify-content: center;">
        <div
            style="background: #1e293b; border-radius: 16px; max-width: 400px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div
                style="padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: var(--text-primary); font-size: 18px;">Notifications</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button onclick="markAllNotifsRead()"
                        style="background: transparent; border: none; color: var(--ocean-light); font-size: 12px; cursor: pointer; font-weight: 600;">Mark
                        all read</button>
                    <button onclick="closeNotifModal()"
                        style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                </div>
            </div>
            <div id="notifList" style="flex: 1; overflow-y: auto; background: rgba(15, 23, 42, 0.3);">
                <!-- Notifications load here -->
            </div>
        </div>
    </div>
    <script>
        // ==========================================
        // TRENDS REDESIGN LOGIC
        // ==========================================

        let trendsData = {}; // Cache for Region Overview
        let currentRegionDomain = null;
        let currentSpotId = null;
        let currentChartSource = 'community'; // 'community' | 'my'
        let currentChartWindow = '30d'; // '7d' | '30d' | '90d' | 'all'
        let currentWaterFilter = 'ocean'; // 'ocean' | 'lagoons' | 'pools' | 'inland'

        // Water type group mappings
        const WATER_TYPE_GROUPS = {
            ocean: ['OCEAN'],
            lagoons: ['LAGOON'],
            pools: ['POOL', 'TIDAL_POOL'],
            inland: ['DAM', 'LAKE', 'RIVER']
        };

        // Coastal regions (for Ocean and Lagoons)
        const COASTAL_REGIONS = ['ATLANTIC', 'FALSE_BAY', 'WEST_COAST', 'SOUTH_COAST', 'GARDEN_ROUTE'];
        let spotChartInstance = null;

        // Domains in order
        const DOMAINS = ['ATLANTIC', 'FALSE_BAY', 'WEST_COAST', 'SOUTH_COAST', 'GARDEN_ROUTE', 'INLAND'];

        function formatDomain(d) {
            return d.replace('_', ' ');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }

        async function loadTrends() {
            // Reset views
            document.getElementById('trendsOverview').style.display = 'block';
            document.getElementById('trendsRegionDetail').style.display = 'none';
            document.getElementById('trendsSpotDetail').style.display = 'none';

            const loadingEl = document.getElementById('trendsLoading');
            const gridEl = document.getElementById('regionGrid');

            loadingEl.style.display = 'block';
            gridEl.style.display = 'none';

            try {
                // Fetch ALL latest spot temps
                const { data, error } = await supabaseClient
                    .from('latest_spot_temps')
                    .select('*');

                if (error) {
                    console.error('Error loading trends data:', error);
                    throw error;
                }

                // Filter by current water type
                const allowedTypes = WATER_TYPE_GROUPS[currentWaterFilter] || [];
                const filteredData = data ? data.filter(row => allowedTypes.includes(row.water_type)) : [];

                console.log(`Trends filter [${currentWaterFilter}]:`, { count: filteredData.length, allowedTypes });

                // Empty state check
                if (filteredData.length === 0) {
                    loadingEl.style.display = 'none';
                    gridEl.style.display = 'block';
                    gridEl.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                            <div style="font-size: 18px; font-weight: 500;">No spots logged yet.</div>
                        </div>
                    `;
                    return;
                }

                // Render based on filter type
                if (currentWaterFilter === 'ocean' || currentWaterFilter === 'lagoons') {
                    // Fetch spots metadata for area mapping
                    const { data: spotsData } = await supabaseClient
                        .from('spots')
                        .select('code, area');

                    const spotAreaMap = {};
                    if (spotsData) {
                        spotsData.forEach(s => spotAreaMap[s.code] = s.area);
                    }

                    // Group by domain (only regions that actually have data)
                    const grouped = {};
                    filteredData.forEach(row => {
                        if (!grouped[row.domain]) {
                            grouped[row.domain] = {
                                domain: row.domain,
                                spots: [],
                                avgTemp: 0,
                                maxTemp: -100,
                                warmestSpotName: '',
                                lastUpdated: null
                            };
                        }
                        const group = grouped[row.domain];
                        group.spots.push({
                            ...row,
                            area: spotAreaMap[row.spot_code]
                        });

                        if (row.temp_c > group.maxTemp) {
                            group.maxTemp = row.temp_c;
                            group.warmestSpotName = row.spot_name;
                        }

                        const rowDate = new Date(row.updated_at);
                        if (!group.lastUpdated || rowDate > new Date(group.lastUpdated)) {
                            group.lastUpdated = row.updated_at;
                        }
                    });

                    // Calculate averages
                    Object.keys(grouped).forEach(d => {
                        const g = grouped[d];
                        const sum = g.spots.reduce((acc, s) => acc + s.temp_c, 0);
                        g.avgTemp = (sum / g.spots.length).toFixed(1);
                    });

                    trendsData = grouped;
                    renderRegionalGrid();
                } else {
                    // For Pools and Inland: show spot list
                    const sorted = filteredData.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                    const title = currentWaterFilter === 'pools' ? 'Pools' : 'Inland Spots';
                    renderTrendSpotList(title, sorted);
                }

            } catch (err) {
                console.error('Error loading trends:', err);
                loadingEl.innerText = 'Error loading data.';
            }
        }

        function renderRegionalGrid() {
            const loadingEl = document.getElementById('trendsLoading');
            const gridEl = document.getElementById('regionGrid');

            loadingEl.style.display = 'none';
            gridEl.style.display = 'grid';
            gridEl.style.gridTemplateColumns = ''; // Reset to default grid
            gridEl.innerHTML = '';

            // Get regions with data (Object.keys(trendsData))
            const activeRegions = Object.keys(trendsData).sort((a, b) => {
                // Keep the same order if possible: ATLANTIC, FALSE_BAY, etc.
                const order = ['ATLANTIC', 'FALSE_BAY', 'WEST_COAST', 'SOUTH_COAST', 'GARDEN_ROUTE'];
                return order.indexOf(a) - order.indexOf(b);
            });

            activeRegions.forEach(domain => {
                const data = trendsData[domain];
                const hasData = data && data.spots && data.spots.length > 0;
                if (!hasData) return; // Hide empty regions

                let tempDisplay = `${data.avgTemp}¬∞C`;
                let subtext = `${data.spots.length} spots`;
                let warmestText = data.maxTemp !== null ? `Warmest: ${data.warmestSpotName} (${data.maxTemp}¬∞C)` : '';
                let updatedText = `Updated ${getTimeAgo(new Date(data.lastUpdated))}`;

                const card = document.createElement('div');
                card.className = 'region-card';
                card.onclick = () => openRegionDetail(domain);
                card.innerHTML = `
                    <div>
                        <div class="region-name" style="font-weight: 700; font-size: 16px;">${formatDomain(domain)}</div>
                        <div class="region-temp" style="font-size: 32px; font-weight: 800; color: var(--ocean-light); margin: 4px 0;">${tempDisplay}</div>
                        <div class="region-stat" style="font-size: 13px; font-weight: 600;">${subtext}</div>
                        <div class="region-stat" style="font-size: 11px; opacity: 0.8;">${updatedText}</div>
                    </div>
                    <div>
                        ${warmestText ? `<div class="region-warmest" style="font-size: 12px; font-weight: 600; margin-top: 12px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;">${warmestText}</div>` : ''}
                    </div>
                `;
                gridEl.appendChild(card);
            });
        }

        function renderTrendSpotList(titleText, spots) {
            const loadingEl = document.getElementById('trendsLoading');
            const gridEl = document.getElementById('regionGrid');

            loadingEl.style.display = 'none';
            gridEl.style.display = 'block';
            gridEl.style.gridTemplateColumns = '1fr';
            gridEl.innerHTML = '';

            // Section Header
            const header = document.createElement('div');
            header.style.cssText = 'font-size: 18px; font-weight: 800; color: var(--text-primary); padding: 20px 0 12px 0; letter-spacing: 0.5px;';
            header.innerText = titleText;
            gridEl.appendChild(header);

            spots.forEach(spot => {
                const item = document.createElement('div');
                item.className = 'spot-list-item';
                item.onclick = () => openSpotDetail(spot.spot_id, spot.spot_name, spot.spot_code);

                // Water type badge
                const waterType = spot.water_type || '';
                let badgeHtml = '';
                if (waterType) {
                    const badgeColors = {
                        'OCEAN': 'rgba(59, 130, 246, 0.2)',
                        'LAGOON': 'rgba(34, 197, 94, 0.2)',
                        'POOL': 'rgba(168, 85, 247, 0.2)',
                        'DAM': 'rgba(234, 179, 8, 0.2)',
                        'LAKE': 'rgba(14, 165, 233, 0.2)',
                        'RIVER': 'rgba(6, 182, 212, 0.2)',
                        'TIDAL_POOL': 'rgba(20, 184, 166, 0.2)'
                    };
                    const badgeBorders = {
                        'OCEAN': 'rgba(59, 130, 246, 0.5)',
                        'LAGOON': 'rgba(34, 197, 94, 0.5)',
                        'POOL': 'rgba(168, 85, 247, 0.5)',
                        'DAM': 'rgba(234, 179, 8, 0.5)',
                        'LAKE': 'rgba(14, 165, 233, 0.5)',
                        'RIVER': 'rgba(6, 182, 212, 0.5)',
                        'TIDAL_POOL': 'rgba(20, 184, 166, 0.5)'
                    };
                    const bgColor = badgeColors[waterType] || 'rgba(100, 100, 100, 0.2)';
                    const borderColor = badgeBorders[waterType] || 'rgba(100, 100, 100, 0.3)';

                    badgeHtml = `<span style="display: inline-block; padding: 2px 8px; margin-left: 8px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; border-radius: 6px; background: ${bgColor}; border: 1px solid ${borderColor}; color: var(--text-primary); vertical-align: middle;">${waterType}</span>`;
                }

                item.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--text-primary); font-size: 16px; margin-bottom: 2px;">${spot.spot_name}${badgeHtml}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500;">${getTimeAgo(new Date(spot.updated_at))}</div>
                    </div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--ocean-light);">${spot.temp_c}¬∞C</div>
                `;
                gridEl.appendChild(item);
            });
        }

        function openRegionDetail(domain) {
            currentRegionDomain = domain;
            const data = trendsData[domain];

            document.getElementById('trendsOverview').style.display = 'none';
            document.getElementById('trendsRegionDetail').style.display = 'block';
            document.getElementById('regionDetailTitle').innerText = formatDomain(domain);

            const listEl = document.getElementById('regionSpotList');
            listEl.innerHTML = '';

            if (!data || data.spots.length === 0) {
                listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No spots with recent data in this region.</div>';
                return;
            }

            // The spots in trendsData[domain].spots are already filtered by loadTrends()
            // so we can just render them directly.
            const sortedSpots = [...data.spots].sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

            sortedSpots.forEach(s => {
                const spotId = s.spot_id;
                const spotName = s.spot_name;
                const spotCode = s.spot_code;
                const waterType = s.water_type || '';

                // Water type badge
                let badgeHtml = '';
                if (waterType) {
                    const badgeColors = {
                        'OCEAN': 'rgba(59, 130, 246, 0.2)',
                        'LAGOON': 'rgba(34, 197, 94, 0.2)',
                        'POOL': 'rgba(168, 85, 247, 0.2)',
                        'DAM': 'rgba(234, 179, 8, 0.2)',
                        'LAKE': 'rgba(14, 165, 233, 0.2)',
                        'RIVER': 'rgba(6, 182, 212, 0.2)',
                        'TIDAL_POOL': 'rgba(20, 184, 166, 0.2)'
                    };
                    const badgeBorders = {
                        'OCEAN': 'rgba(59, 130, 246, 0.5)',
                        'LAGOON': 'rgba(34, 197, 94, 0.5)',
                        'POOL': 'rgba(168, 85, 247, 0.5)',
                        'DAM': 'rgba(234, 179, 8, 0.5)',
                        'LAKE': 'rgba(14, 165, 233, 0.5)',
                        'RIVER': 'rgba(6, 182, 212, 0.5)',
                        'TIDAL_POOL': 'rgba(20, 184, 166, 0.5)'
                    };
                    const bgColor = badgeColors[waterType] || 'rgba(100, 100, 100, 0.2)';
                    const borderColor = badgeBorders[waterType] || 'rgba(100, 100, 100, 0.3)';

                    badgeHtml = `<span style="display: inline-block; padding: 2px 8px; margin-left: 8px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; border-radius: 6px; background: ${bgColor}; border: 1px solid ${borderColor}; color: var(--text-primary); vertical-align: middle;">${waterType}</span>`;
                }

                const item = document.createElement('div');
                item.className = 'spot-list-item';
                item.onclick = () => openSpotDetail(spotId, spotName, spotCode);
                item.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--text-primary); font-size: 16px; margin-bottom: 2px;">${spotName}${badgeHtml}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500;">${getTimeAgo(new Date(s.updated_at))}</div>
                    </div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--ocean-light);">${s.temp_c}¬∞C</div>
                `;
                listEl.appendChild(item);
            });

            initIcons();
        }

        function showTrendsOverview() {
            document.getElementById('trendsRegionDetail').style.display = 'none';
            document.getElementById('trendsOverview').style.display = 'block';
        }

        function showLastRegionDetail() {
            document.getElementById('trendsSpotDetail').style.display = 'none';
            document.getElementById('trendsRegionDetail').style.display = 'block';
        }

        async function openSpotDetail(spotId, spotName, spotCode) {
            // Debug logging
            console.log('Spot open', { spot_id: spotId, spot_name: spotName, spot_code: spotCode });

            // Find spot's water_type from cached data
            let spotWaterType = null;
            for (const domain in trendsData) {
                const spot = trendsData[domain].spots.find(s => s.spot_id === spotId);
                if (spot) {
                    spotWaterType = spot.water_type;
                    break;
                }
            }

            // No validation - allow spot drilldown regardless of filter
            // (spot drilldown is driven by spot_id and temp_logs)

            currentSpotId = spotId;
            document.getElementById('trendsRegionDetail').style.display = 'none';
            document.getElementById('trendsSpotDetail').style.display = 'block';

            // Update header with water type
            let waterLabel = '';
            if (spotWaterType === 'POOL') waterLabel = 'Pool';
            else if (spotWaterType === 'OCEAN') waterLabel = 'Ocean';
            else if (spotWaterType === 'LAGOON') waterLabel = 'Lagoon';
            else if (spotWaterType === 'DAM') waterLabel = 'Dam';

            document.getElementById('spotDetailTitle').innerText =
                waterLabel ? `${spotName} ‚Ä¢ ${waterLabel}` : spotName;

            // Reset to defaults
            currentChartSource = 'community';
            currentChartWindow = '30d';
            updateToggleUI();
            updateWindowUI();

            await loadSpotChartData();
        }

        function setChartWindow(window) {
            if (currentChartWindow === window) return;
            currentChartWindow = window;
            updateWindowUI();
            loadSpotChartData();
        }

        function updateWindowUI() {
            ['7d', '30d', '90d', 'all'].forEach(w => {
                const el = document.getElementById('window' + w);
                if (el) {
                    el.className = currentChartWindow === w ? 'toggle-btn active' : 'toggle-btn';
                }
            });
        }

        function setWaterFilter(filter) {
            if (currentWaterFilter === filter) return;
            console.log('Switching water filter:', { from: currentWaterFilter, to: filter });
            currentWaterFilter = filter;
            updateWaterFilterUI();
            loadTrends();
        }

        function updateWaterFilterUI() {
            const oceanEl = document.getElementById('filterOcean');
            const lagoonsEl = document.getElementById('filterLagoons');
            const poolsEl = document.getElementById('filterPools');
            const inlandEl = document.getElementById('filterInland');
            if (oceanEl) oceanEl.className = currentWaterFilter === 'ocean' ? 'toggle-btn active' : 'toggle-btn';
            if (lagoonsEl) lagoonsEl.className = currentWaterFilter === 'lagoons' ? 'toggle-btn active' : 'toggle-btn';
            if (poolsEl) poolsEl.className = currentWaterFilter === 'pools' ? 'toggle-btn active' : 'toggle-btn';
            if (inlandEl) inlandEl.className = currentWaterFilter === 'inland' ? 'toggle-btn active' : 'toggle-btn';
        }

        function toggleChartSource(source) {
            if (currentChartSource === source) return;
            currentChartSource = source;
            updateToggleUI();
            loadSpotChartData();
        }

        function updateToggleUI() {
            const communityEl = document.getElementById('toggleCommunity');
            const myLogsEl = document.getElementById('toggleMyLogs');
            if (communityEl) communityEl.className = currentChartSource === 'community' ? 'toggle-btn active' : 'toggle-btn';
            if (myLogsEl) myLogsEl.className = currentChartSource === 'my' ? 'toggle-btn active' : 'toggle-btn';
        }

        async function loadSpotChartData() {
            const listEl = document.getElementById('spotRecentLogs');

            // Debug logging
            console.log('Spot drilldown: currentSpotId=', currentSpotId, 'window=', currentChartWindow, 'source=', currentChartSource);
            if (!currentSpotId) {
                showToast('No spot selected', 'error');
                listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No spot selected.</div>';
                return;
            }

            // Clear existing chart
            if (spotChartInstance) {
                spotChartInstance.destroy();
                spotChartInstance = null;
            }
            // Clear canvas
            const canvas = document.getElementById('spotTrendChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            listEl.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';

            try {
                // ===== CHART DATA QUERY =====
                // Calculate time filter based on window
                let timeFilter = null;
                if (currentChartWindow === '7d') {
                    timeFilter = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                } else if (currentChartWindow === '30d') {
                    timeFilter = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
                } else if (currentChartWindow === '90d') {
                    timeFilter = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString();
                }

                // Build chart query (DESC for 'All' case, then reverse)
                let chartQuery = supabaseClient
                    .from('temp_logs')
                    .select('id,user_id,spot_id,temp_c,created_at')
                    .eq('spot_id', currentSpotId)
                    .order('created_at', { ascending: false });

                if (currentChartSource === 'my') {
                    chartQuery = chartQuery.eq('user_id', currentUser.id);
                }

                if (currentChartWindow === 'all') {
                    chartQuery = chartQuery.limit(500);
                } else {
                    chartQuery = chartQuery.gte('created_at', timeFilter);
                }

                const { data: chartData, error: chartError } = await chartQuery;
                if (chartError) {
                    console.error('Chart data load error:', chartError);
                    throw chartError;
                }

                // Reverse for chronological order (chart needs ascending)
                if (chartData) chartData.reverse();

                // ===== RECENT LOGS QUERY (always latest 15) =====
                let logsQuery = supabaseClient
                    .from('temp_logs')
                    .select('id,user_id,temp_c,created_at')
                    .eq('spot_id', currentSpotId)
                    .order('created_at', { ascending: false })
                    .limit(15);

                if (currentChartSource === 'my') {
                    logsQuery = logsQuery.eq('user_id', currentUser.id);
                }

                const { data: recentLogs, error: logsError } = await logsQuery;
                if (logsError) {
                    console.error('Recent logs load error:', logsError);
                    throw logsError;
                }

                // ===== FETCH USER PROFILES =====
                const allUserIds = new Set();
                if (chartData) chartData.forEach(l => allUserIds.add(l.user_id));
                if (recentLogs) recentLogs.forEach(l => allUserIds.add(l.user_id));

                const userIds = [...allUserIds];
                const { data: profiles } = await supabaseClient
                    .from('profiles')
                    .select('id, display_name')
                    .in('id', userIds);

                // Map profiles
                const profileMap = {};
                if (profiles) {
                    profiles.forEach(p => profileMap[p.id] = p.display_name);
                }

                // ===== RENDER CHART =====
                if (!chartData || chartData.length === 0) {
                    renderSpotChart([], []);
                } else {
                    const labels = chartData.map(d => new Date(d.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
                    const temps = chartData.map(d => d.temp_c);
                    renderSpotChart(labels, temps);
                }

                // ===== RENDER RECENT LOGS LIST =====
                if (!recentLogs || recentLogs.length === 0) {
                    listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No logs found.</div>';
                } else {
                    listEl.innerHTML = recentLogs.map(log => `
                         <div style="display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div>
                                <span style="font-weight: 600; font-size: 13px;">${profileMap[log.user_id] || 'Anonymous'}</span>
                                <div style="font-size: 11px; color: var(--text-secondary);">${new Date(log.created_at).toLocaleString()}</div>
                            </div>
                            <div style="font-weight: 700; color: var(--ocean-light);">${log.temp_c}¬∞C</div>
                         </div>
                    `).join('');
                }

            } catch (err) {
                console.error('Spot drilldown load error:', err);
                showToast('Error loading data: ' + err.message, 'error');
                listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error loading data. Check console for details.</div>';
            }
        }

        function renderSpotChart(labels, dataPoints) {
            const ctx = document.getElementById('spotTrendChart').getContext('2d');

            spotChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: dataPoints,
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', maxTicksLimit: 6 }
                        }
                    }
                }
            });
        }
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>

</html>